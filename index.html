<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Cofrinho M√°gico</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Itim -->
    <link href="https://fonts.googleapis.com/css2?family=Itim&display=swap" rel="stylesheet">
    <!-- Font Awesome (√çcones) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        /* Estilo da fonte Itim conforme o Figma */
        .font-itim {
            font-family: 'Itim', cursive;
        }

        /* Estilo do gradiente que ser√° atualizado via JS */
        .app-gradient {
            background: linear-gradient(180deg, var(--color-start, #99BFFB) 0%, var(--color-end, #C7F8DC) 100%);
            transition: background 0.5s ease;
        }

        /* --- NOVO: Estilo para o Background da Tela de Login --- */
        .login-background {
            background-image: url('Fundo.png');
            background-repeat: repeat; 
            background-size: contain; 
            background-color: #EDEFF2; /* Cor de fallback */
        }

        /* --- NOVO: Estilo Soft Neumorphism para Cards e Inputs --- */
        .soft-card {
            background-color: #FCFCFC;
            border-radius: 1rem; /* 16px */
            box-shadow: 
                /* Sombra externa sutil (principal) */
                0 6px 15px rgba(0, 0, 0, 0.1),
                /* Sombra interna para o efeito de relevo (opcional) */
                inset 0 2px 4px rgba(255, 255, 255, 0.5);
            transition: all 0.2s ease-in-out;
        }
        
        .soft-input {
             border: 1px solid #E5E7EB;
             box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
             transition: box-shadow 0.2s;
        }
        .soft-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(154, 193, 251, 0.5); /* Cor prim√°ria do app */
            border-color: #9AC1FB;
        }
        
        /* Estilos para responsividade m√≥vel */
        .mobile-card {
            /* Mantido o min-height para garantir a altura em iframe/mobile */
            min-height: 90vh;
        }
        /* NOVO: Aumentar o min-height para telas maiores no dashboard do pai */
        @media (min-width: 768px) {
            .parent-desktop-card {
                min-height: 95vh; 
            }
            .child-desktop-card {
                min-height: 85vh; 
            }
        }


        .profile-placeholder {
            background: #D1D5DB; 
            border: 4px solid white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* --- NOVO: Bot√µes de A√ß√£o com Profundidade (Gamifica√ß√£o) --- */
        .action-button {
            transition: transform 0.1s, box-shadow 0.2s, background 0.2s;
            border-radius: 12px;
            box-shadow: 0 6px 0 0 rgba(0, 0, 0, 0.25); /* Sombra 3D */
            /* NOVO: Efeito de Relevo na parte superior */
            border-top: 2px solid rgba(255, 255, 255, 0.4); 
            border-bottom: none;
        }
        .action-button:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 0 rgba(0, 0, 0, 0.25);
        }
        
        /* Cor dos bot√µes de a√ß√£o (para evitar cores fixas no JS) */
        .action-green { background-color: #4CAF50; }
        .action-blue { background-color: #64B5F6; }
        .action-red { background-color: #FF7043; }
        .action-yellow { background-color: #FFC107; }
        
        /* Estilo para o modal e sidebar */
        .modal-overlay { z-index: 1000; background-color: rgba(0, 0, 0, 0.6); }
        .modal-content { 
             box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5); 
             border-radius: 1.5rem; /* 24px */
        }
        .sidebar { z-index: 900; transition: transform 0.3s ease-in-out; }

        /* --- MELHORIA DE UX: CANVAS RESPONSIVO --- */
        #game-canvas {
            border: 4px solid #fff;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            background-color: #e0f7fa; 
            border-radius: 12px;
            cursor: pointer;
            
            /* Responsividade */
            width: 100%; /* Ocupa a largura do cont√™iner */
            height: auto; /* Altura autom√°tica para manter propor√ß√£o */
            max-width: 350px; /* Limite m√°ximo para n√£o ficar gigante em desktop */
            aspect-ratio: 3/4; /* For√ßa a propor√ß√£o 300x400 */
            
            touch-action: none; /* Previne scroll da p√°gina ao jogar no celular */
            display: block; /* Remove espa√ßamento inline extra */
        }

        /* Anima√ß√£o de Flutua√ß√£o */
        @keyframes float-animation {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-8px) rotate(-1deg); }
        }
        /* Anima√ß√£o de Rea√ß√£o (Pulo e Balan√ßo) */
        @keyframes react-animation {
            0% { transform: translateY(0) scale(1); }
            25% { transform: translateY(-20px) scale(1.1) rotate(5deg); }
            50% { transform: translateY(0) scale(1) rotate(-5deg); }
            75% { transform: translateY(-10px) scale(1.05) rotate(2deg); }
            100% { transform: translateY(0) scale(1) rotate(0deg); }
        }

        .piggy-character {
            animation: float-animation 4s ease-in-out infinite;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .piggy-reacting {
            animation: react-animation 0.5s ease-out;
        }
        
        /* --- NOVO: Cont√™iner Mascote com estilo l√∫dico --- */
        #animated-piggy-container {
             background-color: rgba(255, 255, 255, 0.5);
             border: 2px solid rgba(255, 255, 255, 0.7);
             border-radius: 9999px;
             box-shadow: 0 0 10px rgba(154, 193, 251, 0.5); /* Sombra da cor do gradiente */
        }
    </style>
</head>
<body class="login-background min-h-screen flex flex-col items-center pt-8 pb-4">
    <!-- Script de Inicializa√ß√£o do Supabase e L√≥gica do App -->
    <script type="module">
        // NOVO: Importa√ß√£o do cliente Supabase
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.44.2/+esm";

        // Vari√°veis globais obrigat√≥rias para Supabase (CREDENCIAIS FORNECIDAS)
        const SUPABASE_URL = "https://jwwgsyibgwpvgfbsltzr.supabase.co"; 
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3d2dzeWliZ3dwdmdmYnNsdHpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzNzkzMDAsImV4cCI6MjA3ODk1NTMwMH0.9iA_dKu4UJf-tQV03YdG8J1N4FhuP_flxHr7HWDbt9I"; 
        
        const initialAuthToken = null; 
        const appId = 'default-app-id';

        let supabase, parentId = null; 
        let currentUserId = null; // UID do usu√°rio logado (pai ou crian√ßa, an√¥nimo)
        let currentChildId = null; // Usado no dashboard do pai para focar na crian√ßa
        let userType = 'Guest'; // 'Parent', 'Child', 'Guest'
        let childParentId = null; // O ID do pai que possui os dados da crian√ßa logada
        
        // VARI√ÅVEIS DE SUBSCRI√á√ÉO REALTIME (CR√çTICO PARA CLEANUP)
        let parentSubscription = null; 
        let childSubscription = null;

        // Credenciais do Pai (Simula√ß√£o)
        // REMOVIDO: HARDCODED - N√£o √© mais usado para login, pois usamos o Supabase Auth.
        const PARENT_CREDENCIAIS = { email: 'admin@admin.com', password: 'admin' };
        
        // Constante de dura√ß√£o da recarga do jogo (6 horas)
        const COOLDOWN_DURATION_MS = 6 * 60 * 60 * 1000; 

        // --- SISTEMA DE √ÅUDIO (SOUND FX) ---
        // Sintetizador simples usando Web Audio API para evitar arquivos externos pesados
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            const now = audioCtx.currentTime;
            
            if (type === 'coin') {
                // Som "Pling" (Senoide aguda)
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
                gainNode.gain.setValueAtTime(0.3, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            } 
            else if (type === 'jump') {
                // Som de Pulo (Quadrada subindo)
                osc.type = 'square';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(300, now + 0.1);
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.linearRampToValueAtTime(0.01, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            }
            else if (type === 'success') {
                // Sucesso (Acorde r√°pido)
                [440, 554, 659].forEach((freq, i) => {
                    const o = audioCtx.createOscillator();
                    const g = audioCtx.createGain();
                    o.connect(g);
                    g.connect(audioCtx.destination);
                    o.type = 'triangle';
                    o.frequency.value = freq;
                    g.gain.setValueAtTime(0.1, now + i*0.1);
                    g.gain.exponentialRampToValueAtTime(0.001, now + i*0.1 + 0.5);
                    o.start(now + i*0.1);
                    o.stop(now + i*0.1 + 0.5);
                });
            }
             else if (type === 'error') {
                // Erro (Dente de serra descendo)
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.2);
                gainNode.gain.setValueAtTime(0.2, now);
                gainNode.gain.linearRampToValueAtTime(0.01, now + 0.2);
                osc.start(now);
                osc.stop(now + 0.2);
            }
        }

        // --- CONSTANTES ---
        const BADGES = {
            first_earn: { id: 'first_earn', name: "Primeiro Ganho", description: "Concluiu a primeira tarefa ou jogo.", icon: "fa-trophy" },
            first_save: { id: 'first_save', name: "Primeira Poupan√ßa", description: "Fez sua primeira contribui√ß√£o para a meta.", icon: "fa-piggy-bank" },
            generous: { id: 'generous', name: "Cora√ß√£o de Ouro", description: "Fez 5 doa√ß√µes no total.", icon: "fa-hands-clapping" },
            goal_starter: { id: 'goal_starter', name: "In√≠cio da Meta", description: "Alcan√ßou 10% da meta.", icon: "fa-bullseye" },
            goal_master: { id: 'goal_master', name: "Mestre da Meta", description: "Completou uma meta de poupan√ßa.", icon: "fa-crown" },
        };
        const DONATION_TARGET = 5; 

        // Listas de itens compr√°veis
        const SHOP_ICONS = [
            { id: 'mago', type: 'fa-icon', value: 'fa-hat-wizard', label: 'Mago', price: 50 },
            { id: 'moneybag', type: 'emoji', value: 'üí∞', label: 'Saco de Dinheiro', price: 75 },
            { id: 'pirata', type: 'fa-icon', value: 'fa-anchor', label: 'Pirata', price: 60 },
            { id: 'coroa', type: 'emoji', value: 'üëë', label: 'Coroa', price: 100 },
        ];
        
        const SHOP_EMOTIONS = [
            { id: 'happy_star', value: 'ü§©', label: 'Feliz Estrela', price: 50 },
            { id: 'thinking', value: 'ü§î', label: 'Pensativo', price: 60 },
            { id: 'pirate', value: 'üè¥‚Äç‚ò†Ô∏è', label: 'Aventureiro', price: 75 },
            { id: 'cool', value: 'üòé', label: 'Legalz√£o', price: 100 },
        ];

        const STANDARD_EMOTIONS = [
            { id: 'smile', value: 'üòä', label: 'Alegre' },
            { id: 'sad', value: 'üòü', label: 'Triste' },
            { id: 'angry', value: 'üò°', label: 'Irritado' },
            { id: 'neutral', value: 'üòê', label: 'Normal' },
        ];
        
        const PET_CHARACTERS = [
            { id: 'piggy', value: 'üê∑', label: 'Porquinho', price: 0 },
            { id: 'cat', value: 'üêà', label: 'Gatinho', price: 120 },
            { id: 'dog', value: 'üê∂', label: 'Cachorrinho', price: 150 },
            { id: 'bear', value: 'üêª', label: 'Ursinho', price: 180 },
            { id: 'rabbit', value: 'üê∞', label: 'Coelhinho', price: 90 },
        ];
        
        // --- ESTRUTURA DE DADOS INICIAL E DEFAULT ---
        let userData = {}; // Objeto de dados din√¢mico da crian√ßa atual
        
        const DEFAULT_CHILD_DATA = {
            name: "Convidado",
            coins: 0, 
            tasks: [], 
            transactions: [], 
            badges: [], 
            lastInterestDate: Date.now(), 
            donationCount: 0, 
            progress: { goal: 500, targetName: "Brinquedo Novo", savedAmount: 0 },
            profileIcon: { type: 'fa-icon', value: 'fa-user-astronaut', shopOwned: [] },
            currentEmotion: { value: 'üòä', shopOwned: [] },
            currentPet: PET_CHARACTERS[0],
            unlockedPets: ['piggy'], 
            settings: {
                theme: 'padr√£o',
                themes: {
                    padr√£o: { start: '#99BFFB', end: '#C7F8DC', price: 0, purchased: true }, 
                    rosa: { start: '#FFC0CB', end: '#ADD8E6', price: 0, purchased: true }, 
                    azul: { start: '#4682B4', end: '#B0E0E6', price: 0, purchased: true },
                    espaco: { start: '#00008B', end: '#483D8B', price: 100, purchased: false },
                    verde: { start: '#A8DADC', end: '#457B9D', price: 150, purchased: false }, 
                    sol: { start: '#FFC72C', end: '#F97316', price: 200, purchased: false }
                },
            },
            actions: { earn: 10, save: 20, spend: 50, donate: 10 }
        };

        // --- ESTRUTURA DE DADOS (Pai) ---
        let parentData = {
            name: "Respons√°vel",
            children: [] // [{ uid: 'childUID', name: 'Child Name', code: '1234' }]
        };

        const DEFAULT_THEME_COLORS = { start: '#99BFFB', end: '#C7F8DC' };


        // --- Elementos do DOM (Cache) ---
        const userNameEl = document.getElementById('user-name');
        const coinCountEl = document.getElementById('coin-count');
        const tasksDoneEl = document.getElementById('tasks-done');
        const tasksTotalEl = document.getElementById('tasks-total');
        const progressBarEl = document.getElementById('progress-bar');
        // REMOVIDO: const coinGoalEl = document.getElementById('coin-goal'); // Elemento antigo
        const modalEl = document.getElementById('main-modal');
        const modalTitleEl = document.getElementById('modal-title');
        const modalBodyEl = document.getElementById('modal-body');
        const sidebarEl = document.getElementById('sidebar');
        const profileIconContainer = document.getElementById('profile-icon-container');
        const piggyCharEl = document.getElementById('piggy-character');
        const piggyGreetingEl = document.getElementById('piggy-greeting');
        const piggyContainerEl = document.getElementById('animated-piggy-container');

        // --- FUN√á√ÉO PARA TESTAR A CONEX√ÉO E RLS (NOVO) ---
        async function testSupabaseConnection() {
            console.log("A testar a conex√£o com Supabase...");
            try {
                // Tenta buscar um item que deve existir (neste caso, tentamos ler a tabela principal)
                const { error, status } = await supabase
                    .from('parent_control')
                    .select('user_id', { head: true }); 

                if (error) {
                    let errorMessage = error.message;
                    if (status === 404 || errorMessage.includes('Could not find the table')) {
                         errorMessage = `**Tabela Inexistente!** Voc√™ precisa criar a tabela **parent_control** e **child_profiles** na sua base Supabase (esquema public) com uma coluna 'user_id' (TEXT/UUID) e 'data' (JSONB).`;
                    } else if (errorMessage.includes('permission denied') || status === 401) {
                         errorMessage = `**Erro de Permiss√£o (RLS)!** O usu√°rio an√¥nimo (Anon Key) n√£o tem permiss√£o de leitura. Habilite o RLS nas tabelas **parent_control** e **child_profiles** e crie uma pol√≠tica de SELECT para 'anon'.`;
                    }
                    
                    console.error("ERRO de Conex√£o Supabase:", error.message);
                    showModal("ERRO de Configura√ß√£o Supabase", errorMessage);
                    return false;
                }

                console.log("Conex√£o Supabase BEM-SUCEDIDA.");
                // O modal de sucesso √© removido para que o usu√°rio veja a tela de login.
                // showModal("Conex√£o OK! ‚ú®", "O cliente Supabase conectou com sucesso. Pr√≥ximo passo: fazer login como 'Pai'.");
                return true;

            } catch (e) {
                console.error("ERRO CR√çTICO de Inicializa√ß√£o Supabase:", e);
                showModal("ERRO CR√çTICO de Conex√£o", "N√£o foi poss√≠vel conectar ao Supabase. Verifique URL/KEY e a sua conex√£o de rede.");
                return false;
            }
        }


        // --- Inicializa√ß√£o do Supabase e Auth (Substitui initFirebase) ---
        function initSupabase() { 
            try {
                // Inicializa o cliente Supabase
                supabase = createClient(SUPABASE_URL, SUPABASE_KEY); 
                console.log("Supabase Client Initialized.");

                // Adiciona a chamada de teste ap√≥s a inicializa√ß√£o
                testSupabaseConnection();
                
                // Ouve mudan√ßas de autentica√ß√£o
                supabase.auth.onAuthStateChange(async (event, session) => {
                     // Quando a sess√£o √© detectada (o usu√°rio est√° logado ou a sess√£o foi restaurada)
                    if (session) {
                        currentUserId = session.user.id;
                        // NOVO: Chama o callback para tratar URL de recupera√ß√£o, sen√£o navega
                        handleAuthCallback(session);
                    } else {
                        // Tenta criar um usu√°rio an√¥nimo (Guest) se n√£o houver sess√£o
                        if (event === 'SIGNED_OUT' || event === 'INITIAL_SESSION') {
                            currentUserId = null; 
                            handleAuthCallback(); // Chama o callback tamb√©m para tratar URLs sem sess√£o
                        }
                    }
                });
                
                // --- Eventos de UI est√°ticos (Ligados ap√≥s a inicializa√ß√£o) ---
                // REMOVIDO: Listener de Tasks Edit Section para evitar abertura do modal
                
                // NOVO: Adiciona listener para a se√ß√£o de Meta (Progresso) - CORRIGIDO EM SETUP EVENT LISTENERS
                
                // Setup dos bot√µes da sidebar (Mantidos para a vers√£o do Pai, mas sem serem usados na navega√ß√£o da crian√ßa)
                document.getElementById('menu-profile')?.addEventListener('click', () => {
                    sidebarEl?.classList.add('-translate-x-full');
                    renderProfileSettingsModal();
                });
                document.getElementById('menu-shop')?.addEventListener('click', () => {
                    sidebarEl?.classList.add('-translate-x-full');
                    renderShopModal();
                });
                document.getElementById('emotion-display-container')?.addEventListener('click', renderEmotionSelectionModal);
                if (piggyContainerEl) {
                    piggyContainerEl.addEventListener('click', triggerReaction);
                }
                
                // NOVO: Adicionar listener para tocar na foto de perfil
                if (profileIconContainer) {
                    profileIconContainer.addEventListener('click', () => {
                        if (userType === 'Child') {
                            renderShopModal('icons');
                        }
                    });
                    profileIconContainer.classList.add('cursor-pointer'); // Adicionar feedback visual de clique
                }

                setupEventListeners(); // Chama a fun√ß√£o consolidada de eventos

            } catch (error) {
                console.error("Erro ao inicializar Supabase:", error);
                showModal("Erro de Inicializa√ß√£o", "N√£o foi poss√≠vel conectar ao banco de dados. Tente recarregar.");
            }
        }

        // --- FUN√á√ÉO CONSOLIDADA DE EVENT LISTENERS ---
        function setupEventListeners() {
            // A√ß√µes da Crian√ßa
            document.getElementById('action-ganhar')?.addEventListener('click', launchGame);
            document.getElementById('action-poupar')?.addEventListener('click', renderSaveInputModal); 
            document.getElementById('action-gastar')?.addEventListener('click', () => renderShopModal('themes'));
            document.getElementById('action-doar')?.addEventListener('click', renderBadgesModal); 
            
            // CORRE√á√ÉO: Listeners para Meta (Texto e Progresso)
            // Removido listener antigo 'coin-goal' pois o elemento foi removido.
            // Mantido apenas o listener na se√ß√£o de progresso que agora cont√©m todas as informa√ß√µes.
            document.getElementById('goal-section')?.addEventListener('click', () => { 
                if(userType==='Child') renderGoalSettingModal(); 
            });

            // Login
            document.getElementById('login-type-toggle')?.addEventListener('change', (e) => {
                // L√≥gica de toggle j√° existente, apenas reatribuindo se necess√°rio ou mantendo o listener inline original se preferir
                // Mas para consist√™ncia, mantemos a l√≥gica original que estava espalhada
            });
            
            // A l√≥gica de login form submit j√° est√° sendo tratada abaixo, mantemos l√° ou trazemos pra c√°.
            // Vou manter os listeners originais que estavam soltos para n√£o quebrar a l√≥gica de login existente.
        }
        
        // --- FUN√á√ïES DE NAVEGA√á√ÉO / ROTAS ---
        function setView(viewId) {
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('child-app-view').classList.add('hidden');
            document.getElementById('parent-dashboard-view').classList.add('hidden');
            
            // NOVAS VISTAS DE LOGIN
            document.getElementById('signup-view').classList.add('hidden');
            document.getElementById('forgot-password-view').classList.add('hidden');
            
            // NOVO: VISTA DE RESET
            document.getElementById('reset-password-view').classList.add('hidden');

            document.getElementById(viewId).classList.remove('hidden');
        }
        
        // NOVO: Navega√ß√£o para Cadastro
        window.showSignupView = function() {
            document.getElementById('signup-message').textContent = '';
            setView('signup-view');
        }

        // NOVO: Navega√ß√£o para Esqueceu Senha
        window.showForgotPasswordView = function() {
            document.getElementById('reset-message').textContent = '';
            setView('forgot-password-view');
        }
        
        // NOVO: Navega√ß√£o para Redefinir Senha (Chamada pelo Auth Callback)
        window.showResetPasswordView = function() {
            document.getElementById('new-reset-message').textContent = '';
            setView('reset-password-view');
        }

        // CORRE√á√ÉO: Garante que a vista de login use o tema padr√£o
        window.showLoginView = function() {
            userType = 'Guest';
            applyTheme('padr√£o', DEFAULT_THEME_COLORS); // Tema padr√£o
            setView('login-view');
        }

        async function showChildApp(uid, parentUid) { // Adicionado parentUid
            userType = 'Child';
            currentUserId = uid;
            childParentId = parentUid; // Salva o ID do pai que possui os dados
            
            // Garantir que a sidebar n√£o interfira no app
            sidebarEl?.classList.add('-translate-x-full'); 
            
            await loadOrCreateUserData(currentUserId, DEFAULT_CHILD_DATA);
            // Se loadOrCreateUserData falhou e userData.name √© indefinido, paramos
            if (!userData.name && userType === 'Child') return;

            setupRealtimeListener(currentUserId);
            setView('child-app-view');
            // Recarrega o timer do jogo para mostrar o tempo restante corretamente
            setInterval(() => {
                if (isGameOnCooldown()) updateUI();
            }, 60000);
            
            // Novo: Adiciona listener para o bot√£o de logout da crian√ßa
            document.getElementById('child-logout-btn')?.addEventListener('click', childLogout);
        }

        // CORRE√á√ÉO: Garante que o dashboard do pai use o tema padr√£o
        async function showParentDashboard(uid) {
            userType = 'Parent';
            parentId = uid;
            applyTheme('padr√£o', DEFAULT_THEME_COLORS); // Tema padr√£o
            await loadParentData();
            window.showParentHome(); // CORRE√á√ÉO: Chamada exposta
            setupParentRealtimeListener(parentId);
            setView('parent-dashboard-view');
        }
        
        // CORRE√á√ÉO: Fun√ß√£o parentLogout exposta para ser chamada diretamente no 'onclick' do HTML
        window.parentLogout = async function() {
            userType = 'Guest';
            parentId = null;
            currentChildId = null;
            childParentId = null;
            
            // CORRE√á√ÉO DE SEGURAN√áA: Cleanup de Listeners e Dados
            if (parentSubscription) {
                supabase.removeChannel(parentSubscription);
                parentSubscription = null;
            }
            // Limpa o estado para evitar contamina√ß√£o entre sess√µes
            parentData = { name: "Respons√°vel", children: [] };
            
            await supabase.auth.signOut();
            showLoginView();
        }
        
        // NOVO: Fun√ß√£o de Logout para a Crian√ßa (chamada do bot√£o superior direito)
        window.childLogout = async function() {
             userType = 'Guest';
             currentUserId = null;
             childParentId = null;
             
             // CORRE√á√ÉO DE SEGURAN√áA: Cleanup
             if (childSubscription) {
                 await supabase.removeChannel(childSubscription);
                 childSubscription = null;
             }
             userData = {}; // Limpa dados da crian√ßa

             // Substitui√ß√£o: Sai do Supabase Auth
             await supabase.auth.signOut();
             showLoginView();
        }

        // NOVO: Mudar para a Home do Pai (Tela 1) - EXPOSTO GLOBALMENTE
        window.showParentHome = function() {
            currentChildId = null; // Desseleciona a crian√ßa
            
            const homeView = document.getElementById('parent-home-view');
            const managementView = document.getElementById('child-management-view');

            if (homeView) homeView.classList.remove('hidden');
            if (managementView) managementView.classList.add('hidden');
            
            renderParentDashboard(); // Renderiza a lista de crian√ßas
        }

        // NOVO: Mudar para o Gerenciamento da Crian√ßa (Tela 2) - EXPOSTO GLOBALMENTE
        window.showChildManagementView = async function(childUid) {
            currentChildId = childUid;
            const childData = await getChildDataSnapshot(childUid);
            if (childData) {
                renderChildManagement(childData);
                document.getElementById('parent-home-view').classList.add('hidden');
                document.getElementById('child-management-view').classList.remove('hidden');
            } else {
                showModal("Erro", "N√£o foi poss√≠vel carregar o perfil da crian√ßa.");
                window.showParentHome();
            }
        }
        
        // NOVO: Fun√ß√£o para tratar a URL ap√≥s o clique no link de recupera√ß√£o de senha.
        async function handleAuthCallback(session) {
            // A Supabase Auth armazena informa√ß√µes de recupera√ß√£o/email verification no hash da URL.
            const hash = window.location.hash;
            
            if (hash.includes('access_token') && hash.includes('type=recovery')) {
                // 1. Redireciona para a vista de Redefini√ß√£o de Senha
                showResetPasswordView();
                
                // 2. O Supabase.auth.onAuthStateChange j√° logou o usu√°rio temporariamente,
                // ent√£o podemos limpar o hash da URL para evitar loops/problemas.
                history.replaceState(null, '', window.location.pathname + window.location.search);
                
                return; // Impede que a navega√ß√£o normal de login continue
            }
            
            // Se houver sess√£o (usu√°rio logado) e n√£o for um callback de recupera√ß√£o
            if (session) {
                // Tenta carregar o perfil do pai (padr√£o)
                const { data: parentControlData, error: parentControlError } = await supabase
                    .from('parent_control')
                    .select('user_id')
                    .eq('user_id', session.user.id)
                    .single();
                
                if (parentControlData) {
                    showParentDashboard(session.user.id);
                } else if (parentControlError && parentControlError.code === 'PGRST116') {
                    // Se n√£o for um perfil de pai, pode ser um UID de crian√ßa logado temporariamente
                    // (Embora o fluxo de login da crian√ßa n√£o use Auth, √© cauteloso)
                    // Se n√£o for pai, volta para o login.
                    showLoginView();
                } else if (parentControlError) {
                    console.error("Erro ao verificar perfil de pai:", parentControlError);
                    showLoginView();
                } else {
                    // Usu√°rio logado, mas n√£o encontrado como pai (cai para login)
                    showLoginView();
                }

            } else {
                // Se n√£o houver sess√£o, mostra a tela de login.
                showLoginView();
            }
        }


        // --- L√ìGICA DE AUTENTICA√á√ÉO E LOGIN ---
        document.getElementById('login-type-toggle').addEventListener('click', (e) => {
            const isParent = e.target.checked;
            
            // Elementos do pai/comuns
            const parentEmailDiv = document.getElementById('parent-email-input-div');
            const parentPasswordDiv = document.getElementById('parent-password-input-div');
            const childCodeInput = document.getElementById('login-child-code-input');
            const createAccountBtn = document.getElementById('create-account-btn');
            const forgotPasswordLink = document.getElementById('forgot-password-link');
            
            // Inputs reais (para required)
            const emailInput = document.getElementById('login-email-input');
            const passwordInput = document.getElementById('login-password-input');

            document.getElementById('login-title-type').textContent = isParent ? 'Pai' : 'Crian√ßa';

            // Toggle visibilidade
            parentEmailDiv?.classList.toggle('hidden', !isParent);
            parentPasswordDiv?.classList.toggle('hidden', !isParent);
            childCodeInput.classList.toggle('hidden', isParent);
            
            // NOVO: Esconde elementos desnecess√°rios para a Crian√ßa (simplifica√ß√£o)
            createAccountBtn?.classList.toggle('hidden', !isParent);
            forgotPasswordLink?.classList.toggle('hidden', !isParent);

            // Toggle required fields
            if (emailInput) emailInput.required = isParent;
            if (passwordInput) passwordInput.required = isParent;
            childCodeInput.required = !isParent;
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const isParent = document.getElementById('login-type-toggle').checked;
            
            if (isParent) {
                parentLogin();
            } else {
                const code = document.getElementById('login-child-code-input').value;
                childLogin(code);
            }
        });
        
        async function parentLogin() {
            const email = document.getElementById('login-email-input').value;
            const password = document.getElementById('login-password-input').value;
            const messageEl = document.getElementById('login-message');

            messageEl.textContent = 'A fazer login...';
            messageEl.classList.remove('text-red-500');

            // --- CORRE√á√ÉO: USAR SUPABASE AUTH PARA LOGIN DO PAI ---
            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password,
            });

            if (error) {
                console.error("Erro de login Supabase:", error);
                messageEl.textContent = 'Credenciais incorretas. Tente novamente.';
                messageEl.classList.add('text-red-500');
                playSound('error');
                return;
            }

            if (data.user) {
                // Login bem-sucedido. Define o currentUserId real e navega.
                currentUserId = data.user.id;
                messageEl.textContent = 'Login bem-sucedido!';
                messageEl.classList.remove('text-red-500');
                showParentDashboard(currentUserId);
            } else {
                // Caso em que o Supabase Auth n√£o retorna erro, mas tamb√©m n√£o retorna usu√°rio (raro, mas cauteloso)
                messageEl.textContent = 'Credenciais incorretas. Tente novamente.';
                messageEl.classList.add('text-red-500');
                playSound('error');
            }
        }

        async function childLogin(code) {
            document.getElementById('login-message').textContent = 'Buscando perfil...';
            
            // --- CORRE√á√ÉO DE BUSCA DO SUPABASE (SECURITY FIX) ---
            // Agora usamos o filtro .contains() para buscar apenas o registro que cont√©m o c√≥digo.
            // Isso evita baixar todos os registros do banco de dados (Select All).
            
            try {
                // Busca apenas o documento que tem o c√≥digo espec√≠fico no array 'children'
                const { data, error } = await supabase
                    .from('parent_control')
                    .select('user_id, data')
                    .contains('data', { children: [{ code: code }] });
                
                if (error) {
                    console.error("Erro ao buscar perfil da crian√ßa:", error);
                    document.getElementById('login-message').textContent = 'Erro de comunica√ß√£o com o banco de dados.';
                    playSound('error');
                    return;
                }

                if (data && data.length > 0) {
                    // Encontrou o pai que tem esse c√≥digo
                    // Nota: Se m√∫ltiplos pais tiverem o mesmo c√≥digo (raro mas poss√≠vel com random), pegamos o primeiro.
                    const parentControl = data[0];
                    const parentId = parentControl.user_id;
                    const children = parentControl.data?.children || [];
                    
                    const child = children.find(c => c.code === code);
                    
                    if (child) {
                        // Encontrado! Passa o UID da crian√ßa (child.uid) e o ID do pai (parentId)
                        showChildApp(child.uid, parentId); 
                        playSound('success');
                        return;
                    }
                }
                
                // Se n√£o encontrar em 'parent_control', significa que foi deletado ou n√£o existe
                document.getElementById('login-message').textContent = 'C√≥digo de acesso inv√°lido ou n√£o encontrado.';
                playSound('error');

            } catch (e) {
                console.error("Erro inesperado no login da crian√ßa:", e);
                document.getElementById('login-message').textContent = 'Ocorreu um erro inesperado.';
                playSound('error');
            }
        }
        
        // --- NOVO: L√ìGICA DE CADASTRO E RECUPERA√á√ÉO (REAL) ---
        
        document.getElementById('signup-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email-input').value;
            const name = document.getElementById('signup-name-input').value;
            const password = document.getElementById('signup-password-input').value;
            const confirmPassword = document.getElementById('signup-confirm-password-input').value;
            const messageEl = document.getElementById('signup-message');

            messageEl.classList.remove('text-red-500', 'text-green-600', 'text-gray-600');
            messageEl.textContent = ''; // Limpa mensagens anteriores

            if (password !== confirmPassword) {
                messageEl.textContent = "Erro: As senhas n√£o coincidem.";
                messageEl.classList.add('text-red-500');
                playSound('error');
                return;
            }
            
            // --- NOVO: Valida√ß√£o de Senha M√≠nima (Cliente) ---
            if (password.length < 6) {
                 messageEl.textContent = "Erro: A senha deve ter no m√≠nimo 6 d√≠gitos.";
                 messageEl.classList.add('text-red-500');
                 playSound('error');
                 return;
            }
            // ----------------------------------------------------
            
            messageEl.textContent = 'A criar conta...';
            messageEl.classList.add('text-gray-600');

            // 1. Tenta criar o usu√°rio no Supabase Auth
            const { data, error } = await supabase.auth.signUp({
                email: email,
                password: password,
                options: {
                    data: { full_name: name },
                    // CR√çTICO: For√ßa o redirecionamento para o URL de produ√ß√£o
                    redirectTo: 'https://fin-family-eight.vercel.app'
                }
            });

            if (error) {
                // --- Mapeamento de Erros para Portugu√™s (Fallback do Servidor) ---
                let translatedMessage = `Erro ao criar conta: Ocorreu um problema no servidor.`;
                
                // Mapeia erros conhecidos, mas sem logar o stack trace completo
                if (error.message.includes("already registered")) {
                    translatedMessage = "Erro: Este e-mail j√° est√° cadastrado.";
                } else if (error.message.includes("Password should be at least 6 characters") || error.name === 'AuthWeakPasswordError') {
                    // Este erro deve ser raro ap√≥s a valida√ß√£o do cliente, mas √© mantido como fallback.
                    translatedMessage = "Erro: A senha deve ter pelo menos 6 caracteres.";
                }
                
                messageEl.textContent = translatedMessage;
                messageEl.classList.remove('text-gray-600');
                messageEl.classList.add('text-red-500');
                playSound('error');
                
                // Loga apenas erros desconhecidos ou cr√≠ticos
                if (!translatedMessage.includes("Erro: A senha deve ter")) {
                    console.error("Erro desconhecido ao cadastrar:", error);
                }
                
                return;
            }

            if (data.user) {
                // 2. Se a conta foi criada, exibe sucesso e volta para login
                // A mensagem assume que a confirma√ß√£o por e-mail foi desativada no dashboard.
                messageEl.textContent = `Conta criada com sucesso! Fa√ßa login abaixo.`;
                messageEl.classList.remove('text-gray-600');
                messageEl.classList.add('text-green-600');
                
                // Redireciona ap√≥s 3 segundos.
                setTimeout(() => {
                    showLoginView();
                }, 3000);
            } else {
                 // Caso de erro gen√©rico sem lan√ßamento de exce√ß√£o (ex: e-mail j√° existe)
                 messageEl.textContent = "Erro: Usu√°rio j√° existe ou outro problema. Verifique o console.";
                 messageEl.classList.remove('text-gray-600');
                 messageEl.classList.add('text-red-500');
                 playSound('error');
            }
        });

        document.getElementById('forgot-password-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('reset-email-input').value;
            const messageEl = document.getElementById('reset-message');
            
            messageEl.textContent = 'A enviar link...';
            messageEl.classList.remove('text-red-500', 'text-green-600');
            messageEl.classList.add('text-gray-600');

            // 1. Envia o link de redefini√ß√£o de senha
            const { error } = await supabase.auth.resetPasswordForEmail(email, {
                 // CR√çTICO: Redireciona para o URL de produ√ß√£o para que o app trate o hash
                 redirectTo: 'https://fin-family-eight.vercel.app'
            });

            if (error) {
                 console.error("Erro ao redefinir senha:", error);
                 messageEl.textContent = `Erro: ${error.message}`;
                 messageEl.classList.remove('text-gray-600');
                 messageEl.classList.add('text-red-500');
                 playSound('error');
                 return;
            }
            
            messageEl.textContent = `Link de redefini√ß√£o enviado para **${email}**!`;
            messageEl.classList.remove('text-gray-600');
            messageEl.classList.add('text-green-600');
            
            // Ap√≥s o envio, volta para o login principal
            setTimeout(() => {
                 showLoginView();
            }, 3000);
        });

        // NOVO: L√ìGICA DE ATUALIZA√á√ÉO DA SENHA (NOVA VIEW)
        document.getElementById('new-reset-password-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newPassword = document.getElementById('new-password-input').value;
            const confirmPassword = document.getElementById('confirm-new-password-input').value;
            const messageEl = document.getElementById('new-reset-message');

            messageEl.classList.remove('text-red-500', 'text-green-600');
            messageEl.textContent = 'A atualizar senha...';
            messageEl.classList.add('text-gray-600');

            if (newPassword !== confirmPassword) {
                 messageEl.textContent = "Erro: As senhas n√£o coincidem.";
                 messageEl.classList.add('text-red-500');
                 playSound('error');
                 return;
            }
            if (newPassword.length < 6) {
                 messageEl.textContent = "Erro: A senha deve ter no m√≠nimo 6 d√≠gitos.";
                 messageEl.classList.add('text-red-500');
                 playSound('error');
                 return;
            }

            // 1. Atualiza a senha do usu√°rio logado pela sess√£o tempor√°ria de recupera√ß√£o
            const { error } = await supabase.auth.updateUser({
                password: newPassword
            });

            if (error) {
                console.error("Erro ao atualizar senha:", error);
                messageEl.textContent = `Erro ao redefinir: ${error.message}. Tente novamente.`;
                messageEl.classList.remove('text-gray-600');
                messageEl.classList.add('text-red-500');
                playSound('error');
                return;
            }

            // 2. Sucesso!
            messageEl.textContent = `Senha redefinida com sucesso! Voc√™ ser√° redirecionado para o login.`;
            messageEl.classList.remove('text-gray-600');
            messageEl.classList.add('text-green-600');
            
            // 3. O Supabase.auth.updateUser() normalmente encerra a sess√£o, ent√£o navegamos para o login
            setTimeout(async () => {
                 await supabase.auth.signOut(); // Garantir logout da sess√£o tempor√°ria
                 showLoginView();
            }, 3000);
        });


        // --- Persist√™ncia de Dados (Geral) ---

        // Fun√ß√£o auxiliar para aplicar mesclagem profunda em objetos aninhados (settings, currentPet)
        function deepMergeUserData(targetData, sourceData) {
            const merged = { ...targetData }; // Come√ßa com os defaults ou dados atuais
            
            // Mesclagem simples para propriedades de primeiro n√≠vel (coins, name, tasks, transactions, etc.)
            Object.assign(merged, sourceData); 

            // --- CORRE√á√ÉO DE MESCLAGEM PROFUNDA E NOME ---
            
            // 1. Mesclagem profunda para SETTINGS
            if (sourceData.settings) {
                merged.settings = { 
                    ...targetData.settings, 
                    ...sourceData.settings,
                    themes: { // Mesclagem profunda para THEMES
                        ...targetData.settings.themes,
                        ...sourceData.settings.themes
                    }
                };
            } else {
                 merged.settings = merged.settings || targetData.settings || DEFAULT_CHILD_DATA.settings;
            }
            
            // 2. Mesclagem de CURRENT PET (garantindo que o PET tenha o objeto completo)
            const petId = sourceData.currentPet?.id || merged.currentPet?.id;
            if (petId) {
                 // Mescla as propriedades do PET DEFAULT + propriedades salvas
                 merged.currentPet = { 
                     ...PET_CHARACTERS.find(p => p.id === petId) || DEFAULT_CHILD_DATA.currentPet,
                     ...sourceData.currentPet 
                 };
            }

            // 3. Mesclagem de Profile Icon
            if (sourceData.profileIcon) {
                merged.profileIcon = { ...targetData.profileIcon, ...sourceData.profileIcon };
            }

            // 4. Mesclagem de Current Emotion
            if (sourceData.currentEmotion) {
                 merged.currentEmotion = { ...targetData.currentEmotion, ...sourceData.currentEmotion };
            }

            // 5. Assegura que o nome esteja sempre correto (prioriza o nome do registro do pai)
            const childInfoInParent = parentData.children.find(c => c.uid === merged.user_id);
            if (childInfoInParent) {
                 merged.name = childInfoInParent.name;
            } else if (sourceData.name && sourceData.name !== DEFAULT_CHILD_DATA.name) {
                 // Use o nome do dado se n√£o houver um registro de pai correspondente
                 merged.name = sourceData.name;
            } else if (targetData.name && targetData.name !== DEFAULT_CHILD_DATA.name) {
                 // Mant√©m o nome anterior se for v√°lido
                 merged.name = targetData.name;
            } else {
                 // Fallback final
                 merged.name = DEFAULT_CHILD_DATA.name;
            }
            
            // 6. Atualiza o UID se estiver faltando
            if (!merged.user_id) merged.user_id = sourceData.user_id;

            return merged;
        }

        async function loadOrCreateUserData(uid, defaultData) {
            // Usa childParentId para encontrar os dados da crian√ßa no caminho do pai
            const parentUidToUse = userType === 'Child' ? childParentId : parentId;
            if (!parentUidToUse) {
                console.error("Parent ID n√£o definido para carregar dados da crian√ßa.");
                userData = { ...defaultData };
                return;
            }

            try {
                // 1. Busca os dados (SELECT) na tabela 'child_profiles'
                const { data: existingData, error: fetchError } = await supabase
                    .from('child_profiles')
                    .select('data')
                    .eq('user_id', uid)
                    .single();
                
                // C√≥digo de erro Supabase para 'Nenhuma linha encontrada'
                const NO_ROWS_FOUND_ERROR = 'PGRST116'; 

                if (existingData) { // Se o dado existir
                    const docData = existingData.data;
                    
                    // --- APLICA MESCLAGEM PROFUNDA ---
                    userData = deepMergeUserData(defaultData, { ...docData, user_id: uid });
                    // ---------------------------------
                    
                } else if (fetchError && fetchError.code === NO_ROWS_FOUND_ERROR) {
                    // SEGURAN√áA: Se o perfil n√£o existe e estamos tentando logar como crian√ßa, N√ÉO CRIAR AUTOMATICAMENTE.
                    // A cria√ß√£o deve ser feita explicitamente pelo PAI no dashboard.
                    // Se chegou aqui, significa que a crian√ßa foi deletada ou o c√≥digo √© velho.
                    
                    if (userType === 'Child') {
                        console.error("Perfil de crian√ßa n√£o encontrado (Provavelmente deletado). Negando acesso.");
                        showModal("Acesso Negado", "Este perfil n√£o existe mais. Fale com seu respons√°vel.");
                        showLoginView(); // Volta para login
                        userData = {}; // Limpa
                        return;
                    }
                    
                    // Se for o PAI acessando (ex: preview ou cria√ß√£o), a√≠ sim criamos? 
                    // N√£o, a cria√ß√£o agora √© feita exclusivamente via 'renderAddChildModal'.
                    // Portanto, nunca devemos cair aqui para criar um perfil do zero implicitamente.
                    userData = defaultData;
                    // O insert original foi removido daqui para evitar 'zumbis'.

                } else if (fetchError) {
                     throw new Error(fetchError.message);
                }
                
                if (userType === 'Child') {
                    calculateInterest();
                    applyTheme(userData.settings.theme); 
                    showGreeting();
                    updateUI(); // Adicionando chamada expl√≠cita para renderizar
                }
            } catch (e) {
                console.error("Erro ao carregar/criar dados do usu√°rio:", e);
                showModal("Erro de Dados", "N√£o foi poss√≠vel carregar o progresso. (Verifique permiss√µes)");
                userData = { ...defaultData };
            }
        }
        
        // --- Persist√™ncia de Dados (Pai) ---
        async function loadParentData() {
            if (!parentId || typeof parentId !== 'string') { // CORRE√á√ÉO: ADDED NULL/TYPE CHECK
                console.error("loadParentData: parentId √© inv√°lido.");
                parentData = { name: "Respons√°vel", children: [] };
                return;
            }

            // CORRE√á√ÉO CR√çTICA DE SEGURAN√áA (VISUAL) E EVITAR DUPLICA√á√ÉO:
            // Reseta parentData antes de carregar novos dados para evitar que dados do usu√°rio anterior permane√ßam.
            parentData = { name: "Respons√°vel", children: [] };

            try {
                // 1. Busca os dados (SELECT) na tabela 'parent_control'
                const { data: existingData, error: fetchError } = await supabase
                    .from('parent_control')
                    .select('data')
                    .eq('user_id', parentId)
                    .single();

                const NO_ROWS_FOUND_ERROR = 'PGRST116'; 

                if (existingData) {
                    // Mescla APENAS se o dado existir, mas come√ßa limpo (gra√ßas √† linha acima)
                    parentData = { ...parentData, ...existingData.data };
                } else if (fetchError && fetchError.code === NO_ROWS_FOUND_ERROR) {
                    // 2. Cria o documento se n√£o existir (INSERT) APENAS COM O NOME PADR√ÉO
                    // Isso evita inserir dados "herdados" de uma vari√°vel global suja
                    const newParentData = { name: "Respons√°vel", children: [] };
                    await supabase
                        .from('parent_control')
                        .insert([{ user_id: parentId, data: newParentData }]);
                    parentData = newParentData;
                } else if (fetchError) {
                     // NOVO: Tratamento de erro espec√≠fico da tabela (como o erro original)
                     if (fetchError.message.includes('Could not find the table')) {
                         showModal("Erro Cr√≠tico de Tabela", "A tabela **parent_control** n√£o foi encontrada. Certifique-se de que ela existe na sua base de dados.");
                         throw new Error(`Tabela 'parent_control' n√£o encontrada: ${fetchError.message}`);
                     }
                     throw new Error(fetchError.message);
                }
                
                // NOVO: Sobrescreve o nome com o nome do Auth (se dispon√≠vel)
                const { data: userData, error: userError } = await supabase.auth.getUser();
                if (userData?.user?.user_metadata?.full_name) {
                    parentData.name = userData.user.user_metadata.full_name.split(' ')[0]; // Pega o primeiro nome
                } else if (userData?.user?.email) {
                    parentData.name = userData.user.email.split('@')[0]; // Pega o nome do email
                }
                // N√£o precisamos do 'else' fallback aqui porque j√° definimos "Respons√°vel" no in√≠cio
                
            } catch (e) {
                console.error("Erro ao carregar dados do pai:", e);
                // O modal √© exibido dentro do bloco try/catch interno se for erro de tabela, sen√£o, aqui.
                if (!e.message.includes('Tabela \'parent_control\' n√£o encontrada')) {
                    showModal("Erro de Dados", "N√£o foi poss√≠vel carregar o dashboard. (Verifique permiss√µes)");
                }
                parentData = { name: "Respons√°vel", children: [] };
            }
        }

        function setupRealtimeListener(uid) {
            if (!childParentId) return; 

            // CORRE√á√ÉO CR√çTICA: Limpa listener anterior se existir
            if (childSubscription) {
                supabase.removeChannel(childSubscription);
                childSubscription = null;
            }

            const channel = supabase
                .channel(`child_data_${uid}`) 
                .on('postgres_changes', { 
                    event: 'UPDATE', 
                    schema: 'public', 
                    table: 'child_profiles', 
                    filter: `user_id=eq.${uid}` 
                }, (payload) => {
                     // SEGURAN√áA: Se o usu√°rio logado mudou, ignora updates do canal antigo
                     if (currentUserId !== uid) return;

                     const docData = payload.new.data.data;
                     userData = deepMergeUserData(userData, { ...docData, user_id: uid });
                     applyTheme(userData.settings.theme); 
                     updateUI();
                })
                .subscribe();
            
            childSubscription = channel;
        }
        
        function setupParentRealtimeListener(uid) {
            if (!uid || typeof uid !== 'string') { 
                console.error("setupParentRealtimeListener: UID √© inv√°lido.");
                return; 
            }

             // CORRE√á√ÉO CR√çTICA: Limpa listener anterior se existir
            if (parentSubscription) {
                supabase.removeChannel(parentSubscription);
                parentSubscription = null;
            }

             const channel = supabase
                 .channel(`parent_data_${uid}`) 
                 .on('postgres_changes', { 
                    event: 'UPDATE', 
                    schema: 'public', 
                    table: 'parent_control', 
                    filter: `user_id=eq.${uid}` 
                 }, (payload) => {
                     // SEGURAN√áA: Se o usu√°rio logado mudou, ignora updates do canal antigo
                     if (currentUserId !== uid) return;

                     const data = payload.new.data.data;
                     parentData = { ...parentData, ...data };
                     renderParentDashboard();
                 })
                 .subscribe();
            
            parentSubscription = channel;
        }


        async function saveUserData(uid = currentUserId) {
            // Determina o UID do pai que deve ser usado no caminho de salvamento
            const parentUidToUse = userType === 'Child' ? childParentId : parentId;
            if (!uid || !parentUidToUse || userType === 'Guest') return;

            try {
                const dataToSave = { ...userData };
                delete dataToSave.game;
                
                // Salva no documento da crian√ßa usando UPSERT na tabela 'child_profiles'
                // Esta opera√ß√£o dispara o evento Realtime que o child est√° ouvindo.
                await supabase
                    .from('child_profiles')
                    .upsert({ user_id: uid, parent_id: parentUidToUse, data: dataToSave }, { onConflict: 'user_id' }); // Usando UPSERT

            } catch (e) {
                console.error("Erro ao salvar dados da crian√ßa:", e);
            }
        }
        
        async function saveParentData() {
            if (!parentId || userType !== 'Parent') return;
            try {
                // Salva no documento do pai usando UPSERT na tabela 'parent_control'
                await supabase
                    .from('parent_control')
                    .upsert({ user_id: parentId, data: parentData }, { onConflict: 'user_id' });
            } catch (e) {
                console.error("Erro ao salvar dados do pai:", e);
            }
        }

        // Fun√ß√£o utilit√°ria para pegar um snapshot de dados da crian√ßa (usada pelo pai)
        async function getChildDataSnapshot(uid) {
             if (!parentId) return null; // O pai deve estar logado
             
             // Busca os dados da crian√ßa na tabela 'child_profiles'
             try {
                const { data: docData, error } = await supabase
                    .from('child_profiles')
                    .select('data')
                    .eq('user_id', uid)
                    .single();

                if (docData) {
                    // Retorna os dados com a mesclagem profunda
                    return deepMergeUserData(DEFAULT_CHILD_DATA, docData.data);
                }
             } catch (e) {
                 console.error("Erro ao carregar snapshot da crian√ßa:", e);
             }
             return null;
        }


        // --- UI/UX & MASCOTE L√ìGICA ---
        let greetingTimeout;
        let reactionTimeout;
        
        function showGreeting() {
            clearTimeout(greetingTimeout);
            if (piggyGreetingEl && userType === 'Child') {
                piggyGreetingEl.textContent = `üëã Ol√°, ${userData.name}!`;
                piggyGreetingEl.classList.remove('opacity-0');
                
                greetingTimeout = setTimeout(() => {
                    piggyGreetingEl.classList.add('opacity-0');
                }, 4000);
            }
        }
        
        const REACTION_MESSAGES = [
            "Opa! Fui tocado!",
            "Eba! Mais moedas!",
            "Toca de novo! ‚ú®",
            "Pronto para poupar?",
            "Uau! üòä",
        ];

        function triggerReaction() {
            if (!piggyCharEl || userType !== 'Child') return;
            
            piggyCharEl.classList.remove('piggy-reacting');
            void piggyCharEl.offsetWidth; 
            piggyCharEl.classList.add('piggy-reacting');

            clearTimeout(reactionTimeout);
            const randomMsg = REACTION_MESSAGES[Math.floor(Math.random() * REACTION_MESSAGES.length)];
            piggyGreetingEl.textContent = randomMsg;
            piggyGreetingEl.classList.remove('opacity-0');

            reactionTimeout = setTimeout(() => {
                piggyGreetingEl.classList.add('opacity-0');
            }, 2000);
            
            // Som de pulo ao tocar no mascote
            playSound('jump');
        }
        
        function isGameOnCooldown() {
            return userData.gameCooldownEndTime > Date.now();
        }

        function getRemainingCooldownTime() {
             const remainingMs = userData.gameCooldownEndTime - Date.now();
            if (remainingMs <= 0) return null;

            const hours = Math.floor(remainingMs / (1000 * 60 * 60));
            const minutes = Math.floor((remainingMs % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((remainingMs % (1000 * 60)) / 1000);

            let parts = [];
            if (hours > 0) parts.push(`${hours}h`);
            if (minutes > 0) parts.push(`${minutes}min`);
            if (hours === 0 && minutes === 0 || parts.length === 0) {
                parts.push(`${seconds}s`);
            }

            return parts.join(' ');
        }

        // CORRE√á√ÉO DE TEMA: Aplicar tema (e garantir que o tema seja o padr√£o se n√£o for a crian√ßa)
        function applyTheme(themeName, fallbackColors = DEFAULT_THEME_COLORS) {
            // CORRE√á√ÉO: Uso de encadeamento opcional para evitar TypeError
            let theme = userData.settings?.themes?.[themeName];
            
            if (userType !== 'Child' || !theme) {
                theme = fallbackColors; // Usa o tema padr√£o se n√£o for a crian√ßa ou se o tema for inv√°lido
            }

            document.body.style.setProperty('--color-start', theme.start);
            document.body.style.setProperty('--color-end', theme.end);
            
            const bodyEl = document.body;
            if (userType === 'Child' || userType === 'Parent') { // Usu√°rio logado
                 bodyEl.classList.add('app-gradient');
                 bodyEl.classList.remove('login-background'); // REMO√á√ÉO DO BG DE LOGIN
                 bodyEl.classList.remove('bg-[#EDEFF2]');
            } else { // Usu√°rio Guest (Login/Signup/Forgot Password/Reset Password)
                 bodyEl.classList.remove('app-gradient');
                 bodyEl.classList.add('login-background'); // ADICIONA O BG DE LOGIN
                 bodyEl.classList.remove('bg-[#EDEFF2]');
            }
        }
        
        // NOVO: Fun√ß√£o para gerar o HTML do √≠cone de perfil
        function getIconHtml(iconData, sizeClass = 'text-3xl', containerSize = 'w-10 h-10') {
            if (!iconData || !iconData.value) {
                iconData = DEFAULT_CHILD_DATA.profileIcon;
            }

            const placeholder = `<div class="${containerSize} rounded-full overflow-hidden flex items-center justify-center bg-gray-300 text-white"><i class="fa-solid fa-user"></i></div>`;

            let content;
            if (iconData.type === 'fa-icon') {
                content = `<i class="fa-solid ${iconData.value} ${sizeClass} text-gray-500"></i>`;
            } else if (iconData.type === 'emoji') {
                content = `<span class="${sizeClass}">${iconData.value}</span>`;
            } else if (iconData.type === 'image-data') {
                content = `<img src="${iconData.value}" alt="Perfil" class="w-full h-full object-cover">`;
                return `<div class="${containerSize} rounded-full overflow-hidden profile-placeholder flex items-center justify-center">${content}</div>`;
            } else {
                return placeholder;
            }
            
            // Default container for icons/emojis
            return `<div class="${containerSize} rounded-full overflow-hidden profile-placeholder flex items-center justify-center">${content}</div>`;
        }

        function updateUI() {
            if (userType !== 'Child') return;

            // ** GARANTE O NOME CORRETO **
            userNameEl.textContent = userData.name;
            // ** GARANTE AS MOEDAS CORRETAS **
            coinCountEl.textContent = userData.coins;
            
            // Atualiza √çcones, Emo√ß√£o e Mascote
            const profileIconData = userData.profileIcon || DEFAULT_CHILD_DATA.profileIcon;
            profileIconContainer.innerHTML = '';
            profileIconContainer.innerHTML = getIconHtml(profileIconData, 'text-4xl', 'w-16 h-16');

            if (piggyCharEl) {
                 piggyCharEl.textContent = userData.currentPet?.value || 'üê∑'; 
            }
            document.getElementById('emotion-display-container').textContent = userData.currentEmotion?.value || 'üòä'; // Usa fallback

            // Progresso
            const totalTasks = userData.tasks.length;
            const completedTasks = userData.tasks.filter(t => t.completed).length;
            tasksTotalEl.textContent = totalTasks;
            tasksDoneEl.textContent = completedTasks;
            const savedAmount = userData.progress.savedAmount || 0;
            const progressGoal = userData.progress.goal || 0;
            
            const progressPercent = progressGoal > 0
                ? Math.min(100, (savedAmount / progressGoal) * 100)
                : 0;
                
            progressBarEl.style.width = `${progressPercent}%`;
            document.getElementById('progress-percent').textContent = `${Math.floor(progressPercent)}%`;
            
            // NOVO: Exibe o nome e valor da meta no cart√£o de perfil
            document.getElementById('goal-name-display').textContent = userData.progress.targetName;
            document.getElementById('goal-amount-display').textContent = `${savedAmount}/${progressGoal} moedas`;


            // A√ß√µes (Os valores est√£o corretos, o que faltava eram os listeners)
            document.getElementById('save-amount').textContent = `Mudar`; // Atualizado para texto (agora modal de input)
            document.getElementById('spend-amount').textContent = `Comprar`; // Atualizado para texto (agora loja)
            document.getElementById('donate-amount').textContent = `Ver`; // Atualizado para texto (agora conquistas)

            // Cooldown Jogo
            const ganharBtn = document.getElementById('action-ganhar');
            const ganharAmount = document.getElementById('earn-amount');
            const isCooldown = isGameOnCooldown();

            if (isCooldown) {
                // A cor agora √© controlada pela classe CSS pura, mas podemos desabilitar visualmente via Tailwind e disabled
                ganharBtn.classList.remove('action-green'); // Remove a cor ativa
                ganharBtn.classList.add('bg-gray-400', 'cursor-not-allowed', 'shadow-none', 'transform-none'); // Adiciona cor e desabilita o visual 3D
                ganharBtn.disabled = true;
                ganharAmount.textContent = getRemainingCooldownTime();
                document.getElementById('earn-text').textContent = 'Recarga'; 
            } else {
                // Reverte para o estado ativo
                ganharBtn.classList.remove('bg-gray-400', 'cursor-not-allowed', 'shadow-none', 'transform-none');
                ganharBtn.classList.add('action-green'); // Adiciona a cor ativa
                ganharBtn.disabled = false;
                ganharAmount.textContent = `+${userData.actions.earn}`;
                document.getElementById('earn-text').textContent = 'Ganhar'; 
            }
            
            // ** CORRE√á√ÉO TAREFAS: Renderiza a lista de tarefas da crian√ßa **
            renderTasks(document.getElementById('tasks-list'), false);
        }
        
        // --- FUN√á√ÉO GEMINI API PARA DICA FINANCEIRA ---

        /**
         * Chama a Gemini API para obter uma dica financeira m√°gica ap√≥s um gasto.
         * @param {string} category - 'Necessidade' ou 'Desejo'.
         * @param {number} amount - Quantidade gasta.
         * @returns {Promise<string>} Dica motivacional gerada pelo LLM.
         */
        async function getFinancialTip(category, amount) {
            const userQuery = `Eu gastei ${amount} moedas num item que classifiquei como '${category}'. Diga-me uma dica financeira m√°gica, motivacional e muito curta (m√°ximo 15 palavras) sobre a import√¢ncia de gastar (se for Necessidade) ou de equilibrar gastos (se for Desejo). Responda em Portugu√™s de Portugal.`;
            const systemPrompt = "Aja como um mentor financeiro infantil, criando dicas fofas, m√°gicas e encorajadoras.";
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            // Implementa√ß√£o de Backoff Exponencial para lidar com limites de taxa
            const MAX_RETRIES = 5;
            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        return result.candidates?.[0]?.content?.parts?.[0]?.text || "Ups! Sem dica desta vez, mas continua a poupar!";
                    } else if (response.status === 429 && i < MAX_RETRIES - 1) {
                        // Too Many Requests, espera e tenta novamente
                        const delay = Math.pow(2, i) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    } else {
                         console.error("Erro HTTP na chamada Gemini:", response.status, response.statusText);
                         return "A fada da dica est√° ocupada. Tenta mais tarde!";
                    }
                } catch (error) {
                    console.error("Erro na chamada Gemini API:", error);
                    return "A fada da dica est√° a dormir. Tenta mais tarde!";
                }
            }
        }
        
        // --- L√ìGICA DE A√á√ïES (GANHAR/POUPAR/GASTAR/DOAR) ---
        
        // NOVO: RENDERIZA MODAL PARA INPUT DE POUPAN√áA
        function renderSaveInputModal() {
            showModal("Quanto Quer Poupar? üí∞", `
                <p class="font-itim mb-4">Seu saldo atual √© de **${userData.coins} moedas**. Digite a quantidade que voc√™ quer guardar na meta:</p>
                <div class="space-y-4">
                    <input type="number" id="save-input-amount" placeholder="Valor a Poupar" class="soft-input w-full p-3 border rounded-lg font-itim text-lg" min="1" max="${userData.coins}">
                    <button id="execute-save-btn" class="w-full bg-blue-500 text-white p-3 rounded-lg font-itim text-xl hover:bg-blue-600 transition-colors action-button">
                        Guardar na Meta (${userData.progress.targetName})
                    </button>
                </div>
            `);

            document.getElementById('execute-save-btn')?.addEventListener('click', () => {
                const amount = parseInt(document.getElementById('save-input-amount').value);
                executeSave(amount);
            });
        }
        
        // NOVO: EXECUTA A TRANSA√á√ÉO DE POUPAN√áA
        function executeSave(saveAmount) {
            if (isNaN(saveAmount) || saveAmount <= 0) {
                playSound('error');
                return showModal("Erro", "Por favor, insira um valor v√°lido.");
            }
            if (userData.coins < saveAmount) {
                playSound('error');
                return showModal("Saldo Insuficiente", `Voc√™ precisa de **${saveAmount} moedas**, mas s√≥ tem ${userData.coins}.`);
            }

            userData.coins -= saveAmount;
            userData.progress.savedAmount += saveAmount;
            
            addTransaction('save', saveAmount, `Poupan√ßa para meta: ${userData.progress.targetName}`);
            awardBadge('first_save');
            checkBadges();
            saveUserData();
            hideModal();
            playSound('coin'); // Som de guardar dinheiro
            showModal("Poupan√ßa Completa! üè¶", `Voc√™ guardou **${saveAmount} moedas** na sua meta!`);
            updateUI(); // CORRE√á√ÉO: For√ßa a atualiza√ß√£o da UI
        }

        // MANTIDO: L√≥gica de Gasto gen√©rico (usado apenas pela Gemini integration, mas n√£o mapeado no bot√£o principal)
        function executeGenericSpend(spendAmount) {
            // Este √© o modal que permite escolher entre saldo livre ou meta, e a categoria N/D
            
            showModal("Onde Gastar? üõí", `
                <p class="font-itim mb-4">O valor do gasto √© de **${spendAmount} moedas**. De qual saldo voc√™ gostaria de retirar?</p>
                <div class="space-y-3">
                    <div class="p-3 border rounded-lg bg-red-50">
                        <p class="font-bold mb-2">Isso √© uma necessidade ou um desejo?</p>
                        <select id="spend-category" class="w-full p-2 border rounded font-itim soft-input">
                            <option value="Desejo">Desejo (Brinquedo, Doce, etc.)</option>
                            <option value="Necessidade">Necessidade (Comida, Material Escolar, etc.)</option>
                        </select>
                    </div>
                    
                    <button id="spend-from-coins" class="w-full bg-red-500 text-white p-3 rounded-lg font-itim hover:bg-red-600 transition-colors action-button" data-source="coins">
                        Retirar de Moedas Livres (${userData.coins} dispon√≠veis)
                    </button>
                    <button id="spend-from-saved" class="w-full bg-orange-500 text-white p-3 rounded-lg font-itim hover:bg-orange-600 transition-colors action-button" data-source="saved">
                        Retirar da Poupan√ßa (${userData.progress.savedAmount} dispon√≠veis)
                    </button>
                </div>
            `);

            const spendFromCoinsBtn = document.getElementById('spend-from-coins');
            const spendFromSavedBtn = document.getElementById('spend-from-saved');
            const categorySelect = document.getElementById('spend-category');

            spendFromCoinsBtn.disabled = userData.coins < spendAmount;
            spendFromSavedBtn.disabled = userData.progress.savedAmount < spendAmount;

            [spendFromCoinsBtn, spendFromSavedBtn].forEach(btn => {
                btn.onclick = () => {
                    const source = btn.dataset.source;
                    const category = categorySelect.value;
                    let success = false;

                    if (source === 'coins' && userData.coins >= spendAmount) {
                        userData.coins -= spendAmount;
                        addTransaction('spend', spendAmount, `Gasto: ${category} (Livre)`);
                        success = true;
                    } else if (source === 'saved' && userData.progress.savedAmount >= spendAmount) {
                        userData.progress.savedAmount -= spendAmount;
                        addTransaction('spend', spendAmount, `Gasto: ${category} (Meta)`);
                        success = true;
                    }

                    if (success) {
                        saveUserData();
                        hideModal();
                        playSound('coin');
                        
                        showModal("Gasto Realizado! üí∏", `
                            <p class="mb-4 font-itim">**${spendAmount} moedas** foram gastas! (Categoria: ${category}).</p>
                            <div id="gemini-tip-container">
                                <button id="get-tip-btn" class="w-full bg-purple-500 text-white p-3 rounded-lg font-itim text-lg hover:bg-purple-600 transition-colors action-button">
                                    Obter Dica Financeira M√°gica ‚ú®
                                </button>
                            </div>
                        `);
                        
                        document.getElementById('get-tip-btn')?.addEventListener('click', async (e) => {
                            const btn = e.target;
                            const tipContainer = document.getElementById('gemini-tip-container');
                            
                            btn.disabled = true;
                            btn.textContent = "A invocar a magia... üîÆ";
                            
                            const tip = await getFinancialTip(category, spendAmount);
                            
                            tipContainer.innerHTML = `
                                <div class="p-3 mt-3 bg-yellow-100 border border-yellow-300 rounded-lg">
                                    <p class="font-bold text-yellow-800">Dica M√°gica da Gemini:</p>
                                    <p class="mt-1 text-yellow-900">${tip}</p>
                                </div>
                            `;
                        });
                        
                        updateUI(); // CORRE√á√ÉO: For√ßa a atualiza√ß√£o da UI

                    } else {
                        playSound('error');
                        showModal("Erro de Saldo", "Saldo insuficiente na conta selecionada.");
                    }
                };
            });
        }


        // NOVO: FUN√á√ÉO PARA DOAR MOEDAS (Fun√ß√£o antiga, agora sem bot√£o no menu principal)
        function renderDonateModal() {
             const donateAmount = userData.actions.donate;
             showModal("Doar Moedas ‚ù§Ô∏è", `
                <p class="font-itim mb-4">Voc√™ tem **${userData.coins} moedas**. Voc√™ quer doar o valor padr√£o de **${donateAmount} moedas** e ajudar quem precisa?</p>
                <div class="space-y-4">
                    <button id="confirm-donate-btn" class="w-full bg-pink-500 text-white p-3 rounded-lg font-itim text-xl hover:bg-pink-600 transition-colors action-button" data-amount="${donateAmount}">
                        Sim, Doar Moedas
                    </button>
                </div>
            `);

            document.getElementById('confirm-donate-btn')?.addEventListener('click', () => {
                const amount = parseInt(document.getElementById('confirm-donate-btn').dataset.amount);
                 
                if (userData.coins < amount) {
                    hideModal();
                    playSound('error');
                    return showModal("Saldo Insuficiente", `Voc√™ precisa de pelo menos **${amount} moedas** para doar.`);
                }
                
                userData.coins -= amount;
                userData.donationCount = (userData.donationCount || 0) + 1;
                
                addTransaction('donate', amount, "Doa√ß√£o para Caridade");
                checkBadges();
                saveUserData();
                hideModal();
                playSound('success');
                showModal("Doa√ß√£o Feita! ‚ù§Ô∏è", `Obrigado por doar **${amount} moedas**! Voc√™ fez o bem!`);
                updateUI(); // CORRE√á√ÉO: For√ßa a atualiza√ß√£o da UI
            });
        }
        
        // --- L√ìGICA DO JOGO ---
        function launchGame() {
            if (isGameOnCooldown()) {
                 const remainingTime = getRemainingCooldownTime();
                 playSound('error');
                 return showModal("Jogo em Recarga", `Voc√™ pode jogar novamente em **${remainingTime}**.`);
            }

            document.getElementById('game-modal').classList.remove('hidden');
            startGame();
        }

        // --- GAME ASSETS E L√ìGICA (Simplificada e Responsiva) ---
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas?.getContext('2d');
        const GAME_WIDTH = 300;
        const GAME_HEIGHT = 400;
        
        // NOVO: Vari√°veis de estado do mouse/touch para controle horizontal (Estilo Pou)
        let isDragging = false;
        let touchX = GAME_WIDTH / 2; // Posi√ß√£o X desejada para o centro do Piggy

        let game = {
            piggy: { x: GAME_WIDTH / 2 - 15, y: GAME_HEIGHT - 80, w: 30, h: 30, vy: 0, gravity: 0.25, jumpPower: -10, onCloud: false },
            clouds: [], coins: [], obstacles: [], 
            multiplier: { active: false, remainingTime: 0, value: 2 }, 
            score: 0, isRunning: false, lastTime: 0,
        };
        
        function drawPiggy() {
            if (!ctx) return;
            ctx.font = '30px Itim';
            ctx.fillText(userData.currentPet?.value || 'üê∑', game.piggy.x - 15, game.piggy.y + 25); 
            if (game.multiplier.active) {
                ctx.fillStyle = 'rgba(255, 215, 0, 0.5)';
                ctx.beginPath();
                ctx.arc(game.piggy.x, game.piggy.y + 15, 20, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        function drawCloud(x, y) {
            if (!ctx) return;
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(x, y, 20, 0, Math.PI * 2);
            ctx.arc(x + 15, y - 10, 20, 0, Math.PI * 2);
            ctx.arc(x + 30, y, 20, 0, Math.PI * 2);
            ctx.arc(x + 15, y + 10, 20, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#3498db';
            ctx.stroke();
        }
        
        function drawCoin(x, y) {
            if (!ctx) return;
            ctx.font = '20px Arial';
            ctx.fillText('‚≠ê', x - 10, y + 15);
        }

        function drawObstacle(x, y) {
            if (!ctx) return;
            ctx.font = '30px Arial';
            ctx.fillText('üíÄ', x - 15, y + 25);
        }

        function drawMultiplier(x, y) {
            if (!ctx) return;
            ctx.font = '30px Arial';
            ctx.fillText('üíé', x - 15, y + 25);
        }

        // --- NOVO: Mapeamento Responsivo de Toque/Mouse ---
        function getScaledX(evt) {
            const rect = canvas.getBoundingClientRect();
            // Verifica se √© toque ou mouse
            const clientX = evt.touches ? evt.touches[0].clientX : evt.clientX;
            // Calcula a escala X (canvas interno / largura visual)
            const scaleX = canvas.width / rect.width; 
            return (clientX - rect.left) * scaleX;
        }

        function handleMouseDown(e) {
            isDragging = true;
            touchX = getScaledX(e);
        }

        function handleMouseMove(e) {
            if (isDragging) {
                touchX = getScaledX(e);
            }
        }

        function handleMouseUp() {
            isDragging = false;
        }

        function handleTouchStart(e) {
            e.preventDefault(); 
            isDragging = true;
            touchX = getScaledX(e); 
        }

        function handleTouchMove(e) {
            e.preventDefault(); 
            if (isDragging) {
                touchX = getScaledX(e);
            }
        }

        function handleTouchEnd() {
            isDragging = false;
        }

        // NOVO: Fun√ß√£o para mover o personagem em dire√ß√£o ao toque (estilo Pou/Doodle Jump)
        function updatePiggyMovement() {
            const targetX = touchX;
            const centerOffset = game.piggy.w / 2;
            const currentCenterX = game.piggy.x + centerOffset; 
            const diffX = targetX - currentCenterX;
            
            // Velocidade de movimento horizontal controlada
            const moveSpeed = 5; 

            if (Math.abs(diffX) > moveSpeed) {
                game.piggy.x += (diffX > 0 ? moveSpeed : -moveSpeed);
            } else {
                game.piggy.x += diffX; // Chega ao ponto exato se estiver perto
            }
            
            // Lidar com o wraparound horizontal
            if (game.piggy.x > GAME_WIDTH) game.piggy.x = -game.piggy.w;
            if (game.piggy.x < -game.piggy.w) game.piggy.x = GAME_WIDTH - game.piggy.w;
        }


        function updateGame(deltaTime) {
            game.piggy.vy += game.piggy.gravity;
            game.piggy.y += game.piggy.vy;
            
            // NOVO: Atualiza a posi√ß√£o horizontal com base no toque
            updatePiggyMovement();

            if (game.piggy.y < GAME_HEIGHT / 2 && game.piggy.vy < 0) {
                const scrollSpeed = -game.piggy.vy;
                game.piggy.y = GAME_HEIGHT / 2;
                
                game.clouds.forEach(c => c.y += scrollSpeed);
                game.coins.forEach(c => c.y += scrollSpeed);
                game.obstacles.forEach(o => o.y += scrollSpeed);
            }

            game.piggy.onCloud = false;
            game.clouds.forEach(cloud => {
                // L√≥gica de Colis√£o de Pulo Autom√°tico (estilo Pou)
                if (game.piggy.vy > 0 && // S√≥ checa colis√£o se estiver caindo
                    game.piggy.x + game.piggy.w > cloud.x && 
                    game.piggy.x < cloud.x + 50 &&
                    game.piggy.y + game.piggy.h > cloud.y && 
                    game.piggy.y + game.piggy.h < cloud.y + 20) {
                        
                    // Pulo for√ßado: redefine a velocidade vertical para subir
                    game.piggy.vy = game.piggy.jumpPower; 
                    game.piggy.y = cloud.y - game.piggy.h; // Posiciona em cima da nuvem
                    game.piggy.onCloud = true; // Necess√°rio para a l√≥gica de spawn de nuvens
                    playSound('jump'); // Som de pulo
                }
            });

            let highestCloudY = GAME_HEIGHT;
            if (game.clouds.length > 0) {
                highestCloudY = game.clouds.reduce((min, c) => Math.min(min, c.y), GAME_HEIGHT);
            }

            const MAX_VERTICAL_GAP = 120;
            const MIN_VERTICAL_GAP = 80;

            if (highestCloudY > MIN_VERTICAL_GAP) {
                const newY = highestCloudY - (Math.random() * (MAX_VERTICAL_GAP - MIN_VERTICAL_GAP) + MIN_VERTICAL_GAP);
                
                game.clouds.push({ x: Math.random() * (GAME_WIDTH - 50), y: newY, w: 50 });

                if (Math.random() < 0.7) {
                    game.coins.push({ 
                        x: Math.random() * (GAME_WIDTH - 20), 
                        y: newY - 40, 
                        w: 20, h: 20,
                        type: Math.random() < 0.9 ? 'coin' : 'multiplier'
                    });
                }

                if (Math.random() < 0.3) {
                     game.obstacles.push({
                        x: Math.random() * (GAME_WIDTH - 30), y: newY - 50, w: 30, h: 30, penalty: 5 
                    });
                }
            }

            game.coins = game.coins.filter(coin => {
                if (game.piggy.x < coin.x + coin.w && game.piggy.x + game.piggy.w > coin.x &&
                    game.piggy.y < coin.y + coin.h && game.piggy.y + game.piggy.h > coin.y) {
                    
                    if (coin.type === 'coin') {
                        const points = game.multiplier.active ? 2 : 1;
                        game.score += points;
                        document.getElementById('game-score').textContent = game.score;
                        playSound('coin'); // Som de moeda
                    } else if (coin.type === 'multiplier') {
                        game.multiplier.active = true;
                        game.multiplier.remainingTime = 5 * 60;
                        playSound('coin'); // Som ao pegar powerup
                    }
                    return false;
                }
                return coin.y < GAME_HEIGHT;
            });
            
            game.obstacles = game.obstacles.filter(obstacle => {
                 if (game.piggy.x < obstacle.x + obstacle.w && game.piggy.x + game.piggy.w > obstacle.x &&
                    game.piggy.y < obstacle.y + obstacle.h && game.piggy.y + game.piggy.h > obstacle.y) {
                    
                    game.score = Math.max(0, game.score - obstacle.penalty);
                    document.getElementById('game-score').textContent = game.score;
                    playSound('error'); // Som de penalidade
                    return false;
                }
                return obstacle.y < GAME_HEIGHT;
            });

            if (game.multiplier.active) {
                game.multiplier.remainingTime--;
                if (game.multiplier.remainingTime <= 0) {
                    game.multiplier.active = false;
                }
            }

            game.clouds = game.clouds.filter(cloud => cloud.y < GAME_HEIGHT);
            if (game.piggy.y > GAME_HEIGHT) {
                gameOver();
            }
            
            // Removida l√≥gica de wraparound daqui, agora est√° em updatePiggyMovement
        }
        
        function gameLoop(timestamp) {
            if (!game.isRunning || !ctx) return;

            const deltaTime = timestamp - game.lastTime;
            game.lastTime = timestamp;

            ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT);

            game.clouds.forEach(c => drawCloud(c.x, c.y));
            
            game.coins.forEach(c => {
                if (c.type === 'coin') drawCoin(c.x, c.y);
                if (c.type === 'multiplier') drawMultiplier(c.x, c.y);
            });
            
            game.obstacles.forEach(o => drawObstacle(o.x, o.y));

            drawPiggy();
            
            updateGame(deltaTime / 1000 * 60);

            requestAnimationFrame(gameLoop);
        }
        
        function startGame() { 
            // Implementa√ß√£o completa do startGame
            game = {
                piggy: { x: GAME_WIDTH / 2 - 15, y: GAME_HEIGHT - 80, w: 30, h: 30, vy: 0, gravity: 0.25, jumpPower: -10, onCloud: false },
                clouds: [
                    { x: GAME_WIDTH / 2 - 25, y: GAME_HEIGHT - 30, w: 50}, 
                    { x: Math.random() * (GAME_WIDTH - 50), y: GAME_HEIGHT - 120, w: 50}, 
                    { x: Math.random() * (GAME_WIDTH - 50), y: GAME_HEIGHT - 210, w: 50}, 
                ],
                coins: [], obstacles: [],
                multiplier: { active: false, remainingTime: 0, value: 2 },
                score: 0, isRunning: true, lastTime: performance.now(),
            };
            document.getElementById('game-score').textContent = game.score;
            document.getElementById('game-message').textContent = `Mova o dedo na tela e pule nas nuvens, ${userData.currentPet?.label || 'Porquinho'}!`;
            
            requestAnimationFrame(gameLoop);
            
            // NOVO: Adiciona listeners de mouse e toque
            canvas?.addEventListener('mousemove', handleMouseMove);
            canvas?.addEventListener('mousedown', handleMouseDown);
            canvas?.addEventListener('mouseup', handleMouseUp);
            // Usamos { passive: true } para touchmove, mas n√£o para o touchstart/touchend se e.preventDefault() for chamado
            canvas?.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas?.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas?.addEventListener('touchend', handleTouchEnd);
        }
        
        // Expondo a fun√ß√£o gameOver globalmente para que o onclick do HTML possa cham√°-la
        window.gameOver = function() {
            game.isRunning = false;
            
            // REMO√á√ÉO DOS LISTENERS DE ENTRADA (NOVO ESTILO)
            canvas?.removeEventListener('mousemove', handleMouseMove);
            canvas?.removeEventListener('mousedown', handleMouseDown);
            canvas?.removeEventListener('mouseup', handleMouseUp);
            canvas?.removeEventListener('touchstart', handleTouchStart);
            canvas?.removeEventListener('touchmove', handleTouchMove);
            canvas?.removeEventListener('touchend', handleTouchEnd);

            const finalScore = game.score * userData.actions.earn;

            if (finalScore > 0) {
                userData.coins += finalScore; 
                userData.gameCooldownEndTime = Date.now() + COOLDOWN_DURATION_MS; // Define o cooldown
                addTransaction('earn', finalScore, `Recompensa do Jogo (${game.score} itens)`);
                checkBadges();
                saveUserData();
                document.getElementById('game-message').textContent = `FIM DE JOGO! Voc√™ ganhou ${finalScore} moedas!`;
                playSound('success');
                showModal("Vit√≥ria no Jogo! ü•≥", `Voc√™ coletou **${game.score} itens** e ganhou **${finalScore} moedas**!`);
                updateUI(); // CORRE√á√ÉO: For√ßa a atualiza√ß√£o da UI
            } else {
                 document.getElementById('game-message').textContent = 'FIM DE JOGO! Tente novamente para ganhar moedas.';
                 playSound('error');
            }

            document.getElementById('game-modal').classList.add('hidden'); 
        }

        // REMOVIDA A FUN√á√ÉO handleInput (Antigo controle de teclado/clique)
        // function handleInput(event) { ... }


        // --- FUN√á√ïES DE L√ìGICA / DADOS ---

        function calculateInterest() {
            const INTEREST_RATE = 0.005; 
            const lastDate = new Date(userData.lastInterestDate);
            const now = new Date();
            const diffTime = Math.abs(now.getTime() - lastDate.getTime());
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)); 

            if (diffDays >= 1 && userData.progress.savedAmount > 0) {
                let interestGained = 0;
                for (let i = 0; i < diffDays; i++) {
                    interestGained += Math.floor(userData.progress.savedAmount * INTEREST_RATE);
                }
                
                if (interestGained > 0) {
                    userData.progress.savedAmount += interestGained;
                    userData.lastInterestDate = now.getTime(); 
                    addTransaction('earn', interestGained, `Juros (${diffDays} dias) da Poupan√ßa`);
                    playSound('coin');
                    showModal("Juros Ganhos! ‚ú®", `Sua poupan√ßa rendeu **${interestGained} moedas** de juros acumulados!`);
                    saveUserData();
                    updateUI(); // CORRE√á√ÉO: For√ßa a atualiza√ß√£o da UI
                }
            }
            userData.lastInterestDate = now.getTime(); 
        }

        function awardBadge(badgeId) {
             if (!userData.badges.includes(badgeId)) {
                userData.badges.push(badgeId);
                const badge = BADGES[badgeId];
                if (badge) {
                    showModal(`Nova Conquista: ${badge.name}! üèÜ`, `${badge.description} Parab√©ns!`);
                    playSound('success');
                    saveUserData();
                    updateUI(); // CORRE√á√ÉO: For√ßa a atualiza√ß√£o da UI
                }
            }
        }

        function checkBadges() {
             if (userData.transactions?.some(t => t.type === 'earn') && userData.coins > 0) {
                awardBadge('first_earn');
            }
            if (userData.transactions?.some(t => t.type === 'save')) {
                awardBadge('first_save');
            }
            if (userData.donationCount >= DONATION_TARGET) {
                 awardBadge('generous');
            }
            const progressPercent = userData.progress.goal > 0
                ? (userData.progress.savedAmount / userData.progress.goal)
                : 0;

            if (progressPercent >= 0.10) {
                awardBadge('goal_starter');
            }
            if (progressPercent >= 1.0) {
                awardBadge('goal_master');
            }
        }

        function addTransaction(type, amount, description) {
             userData.transactions = userData.transactions || [];
             userData.transactions.unshift({
                id: Date.now(),
                type: type, // 'earn', 'save', 'spend', 'donate'
                amount: amount,
                description: description,
                date: new Date().toLocaleDateString('pt-BR')
            });
            userData.transactions = userData.transactions.slice(0, 50); 
        }

        // --- FUN√á√ïES MODAIS ---
        
        // NOVO: Fun√ß√£o auxiliar para converter **Markdown** para HTML <b>
        function convertMarkdownToHtml(text) {
            if (typeof text !== 'string') return text;
            // Converte **negrito** para <b>negrito</b>
            return text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
        }

        function renderTasks(container, showDelete = false) {
             container.innerHTML = '';
            if (!userData.tasks || userData.tasks.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 pt-2 font-itim">Nenhuma tarefa. Adicione uma!</p>';
                return;
            }

            userData.tasks.forEach(task => {
                const li = document.createElement('li');
                const deleteBtn = showDelete ? `<button data-task-id="${task.id}" class="delete-task-btn text-red-500 p-1 hover:text-red-700 transition-colors"><i class="fa-solid fa-trash-can"></i></button>` : '';

                li.className = 'flex items-center justify-between p-3 border-b last:border-b-0';
                li.innerHTML = `
                    <span class="text-lg font-itim ${task.completed ? 'line-through text-gray-500' : 'text-gray-800'}">
                        ${task.text}
                    </span>
                    <div class="flex space-x-2 items-center">
                        ${deleteBtn}
                        ${!showDelete ? `
                        <button data-task-id="${task.id}" class="toggle-task p-2 rounded-full w-10 h-10 flex items-center justify-center 
                            ${task.completed ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-500 hover:bg-green-100'}">
                            <i class="fa-solid ${task.completed ? 'fa-check' : 'fa-circle'}"></i>
                        </button>
                        ` : ''}
                    </div>
                `;
                container.appendChild(li);
            });

            if (!showDelete) { // Bot√µes da crian√ßa (toggle)
                document.querySelectorAll('.toggle-task').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const taskId = e.currentTarget.dataset.taskId;
                        toggleTaskCompletion(taskId);
                    });
                });
            } else { // Bot√µes de exclus√£o (n√£o usados na vista da crian√ßa)
                document.querySelectorAll('.delete-task-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const taskId = e.currentTarget.dataset.taskId;
                        deleteTask(taskId);
                    });
                });
            }
        }
        
        function toggleTaskCompletion(taskId) {
            const task = userData.tasks.find(t => t.id === taskId);
            if (task) {
                const wasCompleted = task.completed;
                task.completed = !task.completed;
                
                if (task.completed && !wasCompleted) {
                    const reward = userData.actions.earn;
                    userData.coins += reward; 
                    addTransaction('earn', reward, `Tarefa conclu√≠da: ${task.text}`);
                    checkBadges(); 
                    playSound('success');
                    showModal("Tarefa Conclu√≠da!", `Parab√©ns! Voc√™ ganhou **${reward} moedas**!`);
                } else if (wasCompleted && !task.completed) {
                    const penalty = userData.actions.earn;
                    userData.coins = Math.max(0, userData.coins - penalty);
                    addTransaction('spend', penalty, `Tarefa desfeita: ${task.text}`);
                    playSound('error');
                    showModal("Tarefa Desfeita", `Voc√™ perdeu **${penalty} moedas** de volta.`);
                }
                saveUserData();
                updateUI(); // CORRE√á√ÉO: For√ßa a atualiza√ß√£o da UI
            }
        }
        
        function deleteTask(taskId) {
            userData.tasks = userData.tasks.filter(t => t.id !== taskId);
            saveUserData();
            // A UI da lista de tarefas precisa ser atualizada
            const tasksListEl = document.getElementById('tasks-list');
            if (tasksListEl) {
                renderTasks(tasksListEl, false);
            }
            updateUI(); // Garante que a contagem de tarefas no header seja atualizada
        }
        
        // NOVO: Modal para o filho alterar o nome da meta
        window.renderGoalSettingModal = function() {
            showModal("Minha Meta de Poupan√ßa üéØ", `
                <p class="font-itim mb-4 text-center text-xl">
                    Meta atual: <span class="text-blue-600 font-bold">${userData.progress.targetName}</span>
                    (Faltam ${userData.progress.goal - userData.progress.savedAmount} moedas)
                </p>
                <div class="space-y-4">
                    <label for="goal-name-input" class="font-bold font-itim block">Mudar o nome da meta:</label>
                    <input type="text" id="goal-name-input" value="${userData.progress.targetName}" 
                           placeholder="Ex: Bicicleta Nova, Viagem, Tablet" 
                           class="soft-input w-full p-3 border rounded-lg font-itim text-lg">
                    <button id="save-goal-name-btn" class="w-full bg-green-500 text-white p-3 rounded-lg font-itim text-xl hover:bg-green-600 transition-colors action-button">
                        Salvar Nome
                    </button>
                </div>
                <p class="text-sm text-gray-500 mt-4 font-itim text-center">O valor da meta √© definido pelo seu respons√°vel.</p>
            `);

            document.getElementById('save-goal-name-btn')?.addEventListener('click', () => {
                const newName = document.getElementById('goal-name-input').value.trim();
                if (newName) {
                    userData.progress.targetName = newName;
                    saveUserData();
                    hideModal();
                    playSound('success');
                    showModal("Sucesso!", `O nome da meta foi atualizado para **${newName}**!`);
                    updateUI(); // CORRE√á√ÉO: For√ßa a atualiza√ß√£o da UI
                } else {
                    playSound('error');
                    showModal("Erro", "O nome da meta n√£o pode ser vazio.");
                }
            });
        }
        

        // Expondo as fun√ß√µes modais para serem acess√≠veis via onclick
        window.renderTaskManagementModal = () => showModal("Gerenciar Tarefas", "Conte√∫do...");
        window.renderSettingsModal = () => showModal("Configura√ß√µes do App", "Conte√∫do...");
        window.renderProfileSettingsModal = () => showModal("Perfil e √çcone", "Conte√∫do...");
        window.renderThemesModal = () => showModal("Temas de Fundo", "Conte√∫do...");
        window.renderCompletedTasksModal = () => showModal("Tarefas Conclu√≠das", "Conte√∫do...");
        
        // CORRIGIDO: renderHistoryModal exposto globalmente
        window.renderHistoryModal = function() { showModal("Hist√≥rico de Transa√ß√µes", renderHistoryList(userData.transactions || []));}
        // CORRIGIDO: renderBadgesModal exposto globalmente
        window.renderBadgesModal = function() {
            const ownedBadges = userData.badges || [];
            
            const badgeContent = Object.values(BADGES).map(badge => {
                const unlocked = ownedBadges.includes(badge.id);
                const iconClass = unlocked ? 'text-yellow-500' : 'text-gray-400';
                
                return `
                    <div class="flex items-start space-x-3 p-3 border rounded-lg ${unlocked ? 'bg-yellow-50' : 'bg-gray-100'}">
                        <i class="fa-solid ${badge.icon} text-3xl ${iconClass} mt-1"></i>
                        <div>
                            <p class="font-bold text-lg">${badge.name}</p>
                            <p class="text-sm text-gray-700">${badge.description}</p>
                        </div>
                    </div>
                `;
            }).join('');

            showModal("Suas Conquistas üèÜ", `
                <p class="font-itim mb-4 text-center text-xl">Voc√™ desbloqueou **${ownedBadges.length} de ${Object.keys(BADGES).length}** conquistas!</p>
                <div class="space-y-3 max-h-80 overflow-y-auto">
                    ${badgeContent}
                </div>
            `);
        }
        
        // NOVO: L√ìGICA DO MODAL DE SELE√á√ÉO DE EMO√á√ÉO
        window.renderEmotionSelectionModal = function() {
            const allEmotions = STANDARD_EMOTIONS.concat(SHOP_EMOTIONS.map(e => ({ ...e, price: e.price || 0 })));
            
            const content = allEmotions.map(item => {
                const isEquipped = userData.currentEmotion.value === item.value;
                const owned = userData.currentEmotion.shopOwned.includes(item.id) || !item.price;
                const buttonText = isEquipped ? 'Equipado' : owned ? 'Usar' : `${item.price} Moedas`;
                const buttonClass = isEquipped ? 'action-green' : owned ? 'action-blue' : 'bg-gray-400 cursor-not-allowed';

                return `
                    <div class="p-2 border rounded-lg soft-card text-center bg-gray-50">
                        <span class="text-4xl">${item.value}</span>
                        <p class="font-bold text-sm">${item.label}</p>
                        <button class="select-emotion-btn ${buttonClass} text-white text-xs p-1 rounded-lg w-full transition-colors action-button"
                            data-value="${item.value}" data-id="${item.id}" data-price="${item.price || 0}" data-owned="${owned}">
                            ${buttonText}
                        </button>
                    </div>
                `;
            }).join('');

            showModal("Selecione sua Emo√ß√£o ‚ú®", `
                <div class="grid grid-cols-3 gap-3">
                    ${content}
                </div>
            `);

            document.querySelectorAll('.select-emotion-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const btn = e.currentTarget;
                    const value = btn.dataset.value;
                    const id = btn.dataset.id;
                    const price = parseInt(btn.dataset.price);
                    const owned = btn.dataset.owned === 'true';

                    if (!owned && price > 0) {
                        if (userData.coins < price) {
                             playSound('error');
                             return showModal("Moedas Insuficientes", `Voc√™ precisa de **${price} moedas** para comprar esta emo√ß√£o!`);
                        }
                        
                        // Compra e equipa
                        userData.coins -= price;
                        userData.currentEmotion.shopOwned.push(id);
                        userData.currentEmotion.value = value;
                        addTransaction('spend', price, `Compra de Emo√ß√£o: ${value}`);
                        playSound('coin');
                        showModal("Emo√ß√£o Desbloqueada!", `Voc√™ comprou e est√° usando **${value}**!`);
                    } else {
                        // Equipa
                        userData.currentEmotion.value = value;
                        hideModal();
                    }
                    saveUserData();
                    updateUI(); // CORRE√á√ÉO: For√ßa a atualiza√ß√£o da UI
                });
            });
        }


        // --- NOVO: L√ìGICA DA LOJA M√ÅGICA REVISADA ---
        window.renderShopModal = function(initialTab = 'themes') { // Adicionado par√¢metro opcional
            showModal("Loja M√°gica ‚ú®", `
                <div class="tabs flex space-x-2 border-b mb-4 font-itim">
                    <button id="tab-themes" class="tab-btn p-2 border-b-2 border-transparent hover:border-blue-400" data-tab="themes">Temas</button>
                    <button id="tab-pets" class="tab-btn p-2 border-b-2 border-transparent hover:border-blue-400" data-tab="pets">Bichinhos</button>
                    <button id="tab-icons" class="tab-btn p-2 border-b-2 border-transparent hover:border-blue-400" data-tab="icons">√çcones</button>
                    <button id="tab-emotions" class="tab-btn p-2 border-b-2 border-transparent hover:border-blue-400" data-tab="emotions">Emo√ß√µes</button>
                </div>
                <div id="shop-content"></div>
                <p class="text-right text-sm font-bold text-orange-500 mt-4">Suas Moedas: ${userData.coins}</p>
            `);
            
            let currentTab = initialTab;
            
            function renderTab(tabId) {
                const contentEl = document.getElementById('shop-content');
                if (!contentEl) return;
                
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.toggle('border-blue-600', btn.dataset.tab === tabId);
                    btn.classList.toggle('text-blue-600', btn.dataset.tab === tabId);
                });

                if (tabId === 'themes') contentEl.innerHTML = renderThemesShop();
                else if (tabId === 'pets') contentEl.innerHTML = renderPetsShop();
                else if (tabId === 'icons') contentEl.innerHTML = renderIconsShop();
                else if (tabId === 'emotions') contentEl.innerHTML = renderEmotionsShop();
                
                attachShopEventListeners();
            }
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => renderTab(e.target.dataset.tab));
            });
            
            renderTab(currentTab);
        }
        
        // Fun√ß√µes de Renderiza√ß√£o Espec√≠ficas da Loja (Themes, Pets, Icons, Emotions)
        function renderThemesShop() {
             return `<div class="grid grid-cols-2 gap-4">${Object.entries(DEFAULT_CHILD_DATA.settings.themes).map(([key, item]) => {
                const owned = userData.settings.themes[key]?.purchased;
                const price = item.price;
                const canAfford = userData.coins >= price;
                const buttonText = owned ? (userData.settings.theme === key ? 'Equipado' : 'Usar') : price === 0 ? 'Gr√°tis' : canAfford ? 'Comprar' : 'Moedas';
                const buttonClass = (userData.settings.theme === key) ? 'action-green' : owned ? 'action-blue' : price === 0 ? 'action-blue' : canAfford ? 'action-red' : 'bg-gray-400 cursor-not-allowed';
                
                return `
                    <div class="p-3 border rounded-lg soft-card text-center bg-gray-50">
                        <div class="h-16 w-full rounded-lg mb-2 shadow-inner" style="background: linear-gradient(180deg, ${item.start} 0%, ${item.end} 100%); border: ${userData.settings.theme === key ? '3px solid #FFC107' : '1px solid #ddd'};"></div>
                        <p class="font-bold">${key.charAt(0).toUpperCase() + key.slice(1)}</p>
                        <p class="text-xs text-gray-500 mb-2">${owned ? 'Seu' : `${price} Moedas`}</p>
                        <button class="shop-item-btn ${buttonClass} text-white text-sm p-2 rounded-lg w-full transition-colors action-button"
                            data-type="theme" data-id="${key}" data-price="${price}" data-owned="${owned}">
                            ${buttonText}
                        </button>
                    </div>
                `;
            }).join('')}</div>`;
        }
        
        function renderPetsShop() {
            return `<div class="grid grid-cols-3 gap-3">${PET_CHARACTERS.map(item => {
                const owned = userData.unlockedPets.includes(item.id);
                const isEquipped = userData.currentPet?.id === item.id;
                const price = item.price;
                const canAfford = userData.coins >= price;
                const buttonText = isEquipped ? 'Equipado' : owned ? 'Usar' : price === 0 ? 'Gr√°tis' : canAfford ? 'Comprar' : 'Moedas';
                const buttonClass = isEquipped ? 'action-green' : owned ? 'action-blue' : price === 0 ? 'action-blue' : canAfford ? 'action-red' : 'bg-gray-400 cursor-not-allowed';
                
                return `
                    <div class="p-2 border rounded-lg soft-card text-center bg-gray-50">
                        <span class="text-4xl">${item.value}</span>
                        <p class="font-bold text-sm">${item.label}</p>
                        <p class="text-xs text-gray-500 mb-2">${owned ? 'Seu' : `${price} Moedas`}</p>
                        <button class="shop-item-btn ${buttonClass} text-white text-xs p-1 rounded-lg w-full transition-colors action-button"
                            data-type="pet" data-id="${item.id}" data-value="${item.value}" data-price="${price}" data-owned="${owned}">
                            ${buttonText}
                        </button>
                    </div>
                `;
            }).join('')}</div>`;
        }

        function renderIconsShop() {
            const currentIcon = userData.profileIcon.value;
            const shopItems = SHOP_ICONS.concat({ id: 'default', type: 'fa-icon', value: 'fa-user-astronaut', label: 'Padr√£o', price: 0 }); // Inclui o padr√£o
            
            return `<div class="grid grid-cols-3 gap-3">${shopItems.map(item => {
                const owned = userData.profileIcon.shopOwned.includes(item.id) || item.price === 0;
                const isEquipped = currentIcon === item.value;
                const price = item.price;
                const canAfford = userData.coins >= price;
                const buttonText = isEquipped ? 'Equipado' : owned ? 'Usar' : price === 0 ? 'Gr√°tis' : canAfford ? 'Comprar' : 'Moedas';
                const buttonClass = isEquipped ? 'action-green' : owned ? 'action-blue' : price === 0 ? 'action-blue' : canAfford ? 'action-red' : 'bg-gray-400 cursor-not-allowed';
                
                const iconDisplay = item.type === 'fa-icon' 
                    ? `<i class="fa-solid ${item.value} text-3xl text-gray-600"></i>` 
                    : `<span class="text-3xl">${item.value}</span>`;

                return `
                    <div class="p-2 border rounded-lg soft-card text-center bg-gray-50">
                        <div class="h-10 flex items-center justify-center">${iconDisplay}</div>
                        <p class="font-bold text-sm">${item.label}</p>
                        <p class="text-xs text-gray-500 mb-2">${owned ? 'Seu' : `${price} Moedas`}</p>
                        <button class="shop-item-btn ${buttonClass} text-white text-xs p-1 rounded-lg w-full transition-colors action-button"
                            data-type="icon" data-id="${item.id}" data-value="${item.value}" data-icon-type="${item.type}" data-price="${price}" data-owned="${owned}">
                            ${buttonText}
                        </button>
                    </div>
                `;
            }).join('')}</div>`;
        }

        function renderEmotionsShop() {
            const allEmotions = STANDARD_EMOTIONS.concat(SHOP_EMOTIONS);
            
            return `<div class="grid grid-cols-3 gap-3">${allEmotions.map(item => {
                const owned = userData.currentEmotion.shopOwned.includes(item.id) || item.price === 0 || !item.price;
                const isEquipped = userData.currentEmotion.value === item.value;
                const price = item.price || 0;
                const canAfford = userData.coins >= price;
                const buttonText = isEquipped ? 'Equipado' : owned ? 'Usar' : price === 0 ? 'Gr√°tis' : canAfford ? 'Comprar' : 'Moedas';
                const buttonClass = isEquipped ? 'action-green' : owned ? 'action-blue' : price === 0 ? 'action-blue' : canAfford ? 'action-red' : 'bg-gray-400 cursor-not-allowed';
                
                return `
                    <div class="p-2 border rounded-lg soft-card text-center bg-gray-50">
                        <span class="text-4xl">${item.value}</span>
                        <p class="font-bold text-sm">${item.label}</p>
                        <p class="text-xs text-gray-500 mb-2">${owned ? 'Seu' : `${price} Moedas`}</p>
                        <button class="select-emotion-btn ${buttonClass} text-white text-xs p-1 rounded-lg w-full transition-colors action-button"
                            data-value="${item.value}" data-id="${item.id}" data-price="${item.price || 0}" data-owned="${owned}">
                            ${buttonText}
                        </button>
                    </div>
                `;
            }).join('')}</div>`;
        }

        // --- L√≥gica de Compra e Equipamento (Unificado) ---
        function attachShopEventListeners() {
            document.querySelectorAll('.shop-item-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const btn = e.currentTarget;
                    const type = btn.dataset.type;
                    const id = btn.dataset.id;
                    const price = parseInt(btn.dataset.price);
                    const owned = btn.dataset.owned === 'true';

                    if (!owned) {
                        if (userData.coins < price) {
                             playSound('error');
                             return showModal("Moedas Insuficientes", `Voc√™ precisa de **${price} moedas** para comprar este item!`);
                        }
                        
                        // L√≥gica de Compra
                        userData.coins -= price;
                        addTransaction('spend', price, `Compra na Loja: ${type} (${id})`);
                        
                        // Marca como comprado e equipa
                        if (type === 'theme') {
                            userData.settings.themes[id].purchased = true;
                            userData.settings.theme = id;
                            applyTheme(id); // CORRE√á√ÉO: Aplica o tema imediatamente
                        } else if (type === 'pet') {
                            userData.unlockedPets.push(id);
                            userData.currentPet = PET_CHARACTERS.find(p => p.id === id);
                        } else if (type === 'icon') {
                            userData.profileIcon.shopOwned.push(id);
                            userData.profileIcon = { type: btn.dataset.iconType, value: btn.dataset.value, shopOwned: userData.profileIcon.shopOwned };
                        } else if (type === 'emotion') {
                            userData.currentEmotion.shopOwned.push(id);
                            userData.currentEmotion = { value: btn.dataset.value, shopOwned: userData.currentEmotion.shopOwned };
                        }

                        playSound('coin');
                        showModal("Compra Conclu√≠da!", `Voc√™ comprou e equipou **${btn.textContent}** por **${price} moedas**!`);

                    } else {
                        // L√≥gica de Equipamento
                        if (type === 'theme') {
                            userData.settings.theme = id;
                            applyTheme(id); // CORRE√á√ÉO: Aplica o tema imediatamente
                        } else if (type === 'pet') {
                            userData.currentPet = PET_CHARACTERS.find(p => p.id === id);
                        } else if (type === 'icon') {
                            userData.profileIcon = { type: btn.dataset.iconType, value: btn.dataset.value, shopOwned: userData.profileIcon.shopOwned };
                        } else if (type === 'emotion') {
                            userData.currentEmotion = { value: btn.dataset.value, shopOwned: userData.currentEmotion.shopOwned };
                        }
                        showModal("Item Equipado", `Voc√™ est√° usando **${btn.textContent}**!`);
                    }
                    
                    saveUserData();
                    renderShopModal(); // Re-renderiza a loja para atualizar os bot√µes
                    updateUI(); // CORRE√á√ÉO: For√ßa a atualiza√ß√£o da UI (para moedas, √≠cone, emo√ß√£o)
                });
            });
        }


        // NOVO: L√ìGICA DO MODAL DE CONQUISTAS (BADGES)
        window.renderBadgesModal = function() {
            const ownedBadges = userData.badges || [];
            
            const badgeContent = Object.values(BADGES).map(badge => {
                const unlocked = ownedBadges.includes(badge.id);
                const iconClass = unlocked ? 'text-yellow-500' : 'text-gray-400';
                
                return `
                    <div class="flex items-start space-x-3 p-3 border rounded-lg ${unlocked ? 'bg-yellow-50' : 'bg-gray-100'}">
                        <i class="fa-solid ${badge.icon} text-3xl ${iconClass} mt-1"></i>
                        <div>
                            <p class="font-bold text-lg">${badge.name}</p>
                            <p class="text-sm text-gray-700">${badge.description}</p>
                        </div>
                    </div>
                `;
            }).join('');

            showModal("Suas Conquistas üèÜ", `
                <p class="font-itim mb-4 text-center text-xl">Voc√™ desbloqueou **${ownedBadges.length} de ${Object.keys(BADGES).length}** conquistas!</p>
                <div class="space-y-3 max-h-80 overflow-y-auto">
                    ${badgeContent}
                </div>
            `);
        }
        
        // --- UI GERAL ---
        
        // CORRE√á√ÉO CR√çTICA: Aplica a convers√£o de **Markdown** para HTML <b>
        window.showModal = function(title, message) {
            if (modalTitleEl) modalTitleEl.textContent = title;
            if (modalBodyEl) modalBodyEl.innerHTML = convertMarkdownToHtml(message);
            modalEl?.classList.remove('hidden');
        }

        window.hideModal = function() {
            modalEl?.classList.add('hidden');
            if (game.isRunning) {
                 game.isRunning = false;
                 document.getElementById('game-modal')?.classList.add('hidden');
            }
        }
        
        document.getElementById('modal-close-btn')?.addEventListener('click', hideModal);

        // O sidebar e o open-sidebar-btn foram removidos da vista da crian√ßa, mas mantemos o listener do bot√£o de fechar para o pai
        document.getElementById('close-sidebar-btn')?.addEventListener('click', () => {
            sidebarEl?.classList.remove('translate-x-0');
            sidebarEl?.classList.add('-translate-x-full');
        });

        document.getElementById('menu-logout')?.addEventListener('click', async () => {
            // Este bot√£o est√° na sidebar do pai, que est√° fora do fluxo da crian√ßa
            sidebarEl?.classList.add('-translate-x-full');
            // Substitui√ß√£o: Sai do Supabase Auth
            await supabase.auth.signOut();
            showLoginView();
            showModal("Sess√£o Encerrada", "Voc√™ saiu. Fa√ßa login novamente.");
        });


        // --- DASHBOARD DO PAI L√ìGICA (MANTIDA) ---
        // Fun√ß√£o utilit√°ria para gerar c√≥digo
        function generateUniqueCode() {
            let code = '';
            for (let i = 0; i < 4; i++) {
                code += Math.floor(Math.random() * 10).toString();
            }
            return code;
        }

        // NOVO: Mudar para a Home do Pai (Tela 1) - EXPOSTO GLOBALMENTE
        window.showParentHome = function() {
            currentChildId = null; // Desseleciona a crian√ßa
            
            const homeView = document.getElementById('parent-home-view');
            const managementView = document.getElementById('child-management-view');

            if (homeView) homeView.classList.remove('hidden');
            if (managementView) managementView.classList.add('hidden');
            
            renderParentDashboard(); // Renderiza a lista de crian√ßas
        }

        // NOVO: RENDERIZA MODAL PARA ADICIONAR CRIAN√áA
        window.renderAddChildModal = function() {
            showModal("Adicionar Novo Perfil", `
                <form id="add-child-form-modal" class="space-y-4">
                    <label for="new-child-name-input-modal" class="font-bold font-itim block">Nome da Crian√ßa:</label>
                    <input type="text" id="new-child-name-input-modal" placeholder="Nome (Ex: Alex, Bia)" class="soft-input w-full p-3 border rounded-lg font-itim text-lg" required>
                    <p id="add-child-message" class="text-red-500 font-itim"></p>
                    <button type="submit" id="submit-add-child-btn" class="w-full bg-purple-500 text-white p-3 rounded-lg font-itim text-xl hover:bg-purple-600 transition-colors action-button">
                        Adicionar Perfil
                    </button>
                </form>
            `);

            // Anexa o listener ao novo formul√°rio dentro do modal
            document.getElementById('add-child-form-modal')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const nameInput = document.getElementById('new-child-name-input-modal');
                const name = nameInput.value.trim();
                
                if (name && parentId) {
                    try { 
                        // Uso de crypto.randomUUID() para gerar um UID √∫nico
                        const childUid = crypto.randomUUID(); 
                        const childCode = generateUniqueCode();
                        
                        const newChild = {
                            uid: childUid,
                            name: name,
                            code: childCode,
                            profileIcon: DEFAULT_CHILD_DATA.profileIcon, 
                            currentEmotion: DEFAULT_CHILD_DATA.currentEmotion
                        };
                        
                        // 1. Cria o documento real da crian√ßa primeiro (INSERT no Supabase)
                        const childInitialData = { ...DEFAULT_CHILD_DATA, name: name };
                        const { error: insertError } = await supabase
                            .from('child_profiles')
                            .insert([{ user_id: childUid, parent_id: parentId, data: childInitialData }]);
                        
                        if (insertError) throw new Error(insertError.message);
                        
                        // 2. Atualiza a lista do pai (manualmente e salva)
                        if (!parentData.children) {
                            parentData.children = [];
                        }
                        parentData.children.push(newChild);
                        await saveParentData(); 
        
                        nameInput.value = '';
                        hideModal();
                        showModal("Crian√ßa Adicionada!", `**${name}** foi adicionada com sucesso. C√≥digo: **${childCode}**.`);
                        
                    } catch (error) {
                        console.error("Erro CR√çTICO ao adicionar crian√ßa:", error);
                        document.getElementById('add-child-message').textContent = `Erro: ${error.message}. Tente novamente.`;
                        
                    } finally {
                        // CR√çTICO: Garante que o usu√°rio permane√ßa na vista do pai mesmo ap√≥s o erro no catch
                        window.showParentHome(); 
                    }
                } else {
                    document.getElementById('add-child-message').textContent = "Nome da crian√ßa √© obrigat√≥rio.";
                }
            });
        }


        function renderParentDashboard() {

            if (userType !== 'Parent') return;

            const childrenListEl = document.getElementById('parent-children-list');
            const parentGreetingEl = document.getElementById('parent-greeting'); // Elemento de sauda√ß√£o
            
            // DEFESA CR√çTICA: Inicializa os elementos e usa try/catch para evitar tela em branco
            if (childrenListEl) childrenListEl.innerHTML = '';
            
            // ATUALIZADO: Usando parentData.name, que agora deve ser o primeiro nome
            if (parentGreetingEl) {
                 // Adiciona √≠cone de edi√ß√£o ao lado do nome
                 parentGreetingEl.innerHTML = `Ol√°, ${parentData.name}! <button onclick="renderEditParentNameModal()" class="text-gray-500 hover:text-blue-500 text-xl ml-2" title="Editar Nome"><i class="fa-solid fa-pencil"></i></button>`;
            }
            
            try {
                if (parentData.children.length === 0) {
                    if (childrenListEl) childrenListEl.innerHTML = `<p class="text-gray-500 font-itim text-center mt-4 p-6 bg-gray-50 rounded-lg shadow-inner">Nenhuma crian√ßa adicionada ainda. Clique no '+' para come√ßar.</p>`;
                } else {
                    // 1. Renderiza a lista de crian√ßas
                    parentData.children.forEach(child => {
                        // Usando tamanho maior para o √≠cone conforme o Figma
                        const iconHtml = getIconHtml(child.profileIcon, 'text-4xl', 'w-20 h-20'); 

                        const div = document.createElement('div');
                        // NOVO ESTILO: Usando soft-card para consist√™ncia
                        div.className = 'w-full h-[107px] p-4 soft-card flex justify-between items-center';
                        
                        div.innerHTML = `
                            <div class="flex items-center space-x-3">
                                ${iconHtml} 
                                <div>
                                    <span class="font-itim text-2xl sm:text-3xl text-gray-800 font-bold block">${child.name}</span>
                                    <span class="text-sm font-bold text-blue-600">C√ìDIGO: ${child.code}</span>
                                </div>
                            </div>
                            
                            <!-- Bot√µes de A√ß√£o agrupados em √≠cones no lado direito -->
                            <div class="flex space-x-2 items-center p-1">
                                
                                <!-- Bot√£o Gerenciar (Engrenagem) -->
                                <button data-uid="${child.uid}" class="view-child-btn bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 transition-colors shadow-md w-10 h-10 flex items-center justify-center action-button" title="Gerenciar Perfil">
                                    <i class="fa-solid fa-gear text-xl"></i>
                                </button>
                                
                                <!-- Bot√£o Apagar (Lixeira) -->
                                <button data-uid="${child.uid}" class="delete-child-btn text-red-500 bg-gray-100 hover:bg-red-100 p-2 rounded-full transition-colors shadow-md w-10 h-10 flex items-center justify-center action-button" title="Apagar Perfil">
                                    <i class="fa-solid fa-trash-can text-xl"></i>
                                </button>
                            </div>
                        `;
                        if (childrenListEl) childrenListEl.appendChild(div);
                    });
                    
                    // 2. Adiciona listeners para ver o dashboard individual e excluir
                    document.querySelectorAll('.view-child-btn').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            const childUid = e.currentTarget.dataset.uid;
                            currentChildId = childUid;
                            const childDataLocal = await getChildDataSnapshot(childUid); 
                            if (childDataLocal) {
                                 window.showChildManagementView(childUid);
                            } else {
                                // Fallback com dados default, mas nome correto
                                 window.showChildManagementView(childUid); 
                            }
                        });
                    });

                    // NOVO: Listener para Excluir
                    document.querySelectorAll('.delete-child-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const childUid = e.currentTarget.dataset.uid;
                            const child = parentData.children.find(c => c.uid === childUid);
                            if (child) {
                                confirmDeleteChild(child.uid, child.name);
                            }
                        });
                    });
                }
                
            } catch (e) {
                console.error("Erro CR√çTICO durante renderParentDashboard:", e);
                if (childrenListEl) childrenListEl.innerHTML = `<p class="text-red-500 font-itim text-center mt-4">Erro Cr√≠tico ao exibir perfis. Veja o console.</p>`;
            }
        }

        // Fun√ß√£o para adicionar nova crian√ßa (Mantido para fins de estrutura, mas a l√≥gica est√° no modal)
        // O listener original para o form 'add-child-form' foi removido e substitu√≠do pelo modal

        
        // --- NOVO: L√ìGICA DE EXCLUS√ÉO DE PERFIL (PAI) ---

        function confirmDeleteChild(uid, name) {
            showModal("Confirma√ß√£o de Exclus√£o", `
                <p class="font-itim text-xl text-center mb-4">Voc√™ tem certeza que deseja **EXCLUIR PERMANENTEMENTE** o perfil de:</p>
                <p class="font-itim text-2xl font-bold text-red-600 text-center">${name}</p>
                <p class="text-sm text-center text-gray-500 mt-2">Isto ir√° apagar todas as moedas, tarefas e hist√≥rico desta crian√ßa.</p>
                <div class="flex justify-center space-x-4 mt-6">
                    <button onclick="hideModal()" class="bg-gray-300 text-gray-800 p-3 rounded-lg font-itim hover:bg-gray-400 action-button">Cancelar</button>
                    <button id="execute-delete-btn" data-uid="${uid}" class="bg-red-600 text-white p-3 rounded-lg font-itim hover:bg-red-700 action-button">Excluir Permanentemente</button>
                </div>
            `);

            document.getElementById('execute-delete-btn')?.addEventListener('click', (e) => {
                const targetUid = e.currentTarget.dataset.uid;
                hideModal();
                deleteChildProfile(targetUid);
            });
        }

        async function deleteChildProfile(uid) {
            if (!parentId || userType !== 'Parent' || !uid) return;

            try {
                // 0. SEGURAN√áA: Recarregar dados do pai para garantir que 'parentData' est√° fresco
                // Isso evita deletar usando uma lista desatualizada
                const { data: currentParentData, error: fetchError } = await supabase
                    .from('parent_control')
                    .select('data')
                    .eq('user_id', parentId)
                    .single();

                if (currentParentData) {
                     parentData = { ...parentData, ...currentParentData.data };
                }

                // 1. Remove o documento principal da crian√ßa no Supabase (child_profiles)
                const { error: deleteError } = await supabase
                    .from('child_profiles')
                    .delete()
                    .eq('user_id', uid); 
                    
                if (deleteError) throw new Error(deleteError.message);

                // 2. Remove a crian√ßa da lista denormalizada do pai (parentData.children) e salva
                parentData.children = parentData.children.filter(child => child.uid !== uid);
                await saveParentData(); 
                
                // 3. Atualiza a UI
                showModal("Exclu√≠do com Sucesso", "O perfil da crian√ßa foi removido.");
                window.showParentHome(); // Volta para a tela Home do pai e re-renderiza a lista
                
            } catch (error) {
                console.error("Erro ao excluir perfil da crian√ßa:", error);
                showModal("Erro de Exclus√£o", `N√£o foi poss√≠vel excluir o perfil no banco de dados. Detalhe: ${error.message}.`);
                // Garante que a UI do pai seja atualizada mesmo se a exclus√£o do doc falhar
                window.showParentHome();
            }
        }
        
        // NOVO: Mudar para o Gerenciamento da Crian√ßa (Tela 2) - EXPOSTO GLOBALMENTE
        window.showChildManagementView = async function(childUid) {
            currentChildId = childUid;
            const childData = await getChildDataSnapshot(childUid);
            if (childData) {
                renderChildManagement(childData);
                document.getElementById('parent-home-view').classList.add('hidden');
                document.getElementById('child-management-view').classList.remove('hidden');
            } else {
                showModal("Erro", "N√£o foi poss√≠vel carregar o perfil da crian√ßa.");
                window.showParentHome();
            }
        }

        function renderChildManagement(childData) {
            // CORRE√á√ÉO: Altera o alvo para o ID √∫nico da vista de gerenciamento
            const childManagementContainer = document.getElementById('child-management-container');
            const child = parentData.children.find(c => c.uid === currentChildId);
            
            if (!child || !childManagementContainer) return;

            // Garantindo que o childData tem a estrutura completa, mesmo que falhe no carregamento
            childData = { ...DEFAULT_CHILD_DATA, ...childData };

            const totalTasks = childData.tasks?.length || 0;
            const completedTasks = childData.tasks?.filter(t => t.completed).length || 0;
            const savedAmount = childData.progress.savedAmount || 0;
            const goalAmount = childData.progress.goal || 0;
            
            // NOVO: Exibir emo√ß√£o e √çcone
            const currentEmotion = childData.currentEmotion?.value || 'üòä';
            const iconHtml = getIconHtml(childData.profileIcon, 'text-3xl', 'w-12 h-12');


            childManagementContainer.innerHTML = `
                
                <!-- Layout de 2 colunas para desktop -->
                <div class="grid grid-cols-1 md:grid-cols-2 md:gap-4">
                    
                    <!-- Coluna 1: Informa√ß√µes e Mesada/B√¥nus -->
                    <div>
                        <!-- Cart√£o de Informa√ß√µes Principais -->
                        <div class="soft-card p-4 mb-4 border-2 border-green-300">
                            <div class="flex items-center space-x-3 border-b pb-2 mb-3">
                                ${iconHtml} <!-- NOVO: √çcone aqui -->
                                <h4 class="text-2xl font-itim text-green-700 flex items-center">
                                    ${child.name} 
                                    <span class="ml-2 text-3xl">${currentEmotion}</span>
                                    <!-- Bot√£o Editar Nome da Crian√ßa -->
                                    <button onclick="renderEditChildNameModal('${currentChildId}', '${child.name}')" class="ml-3 text-gray-400 hover:text-blue-500 text-lg" title="Editar Nome"><i class="fa-solid fa-pencil"></i></button>
                                </h4>
                            </div>
                            <p class="text-xl font-itim mb-2">C√≥digo de Acesso: <span class="text-blue-600 font-bold">${child.code}</span></p>
                            <p class="text-xl font-itim mb-2">Saldo Atual: <span class="text-orange-500 font-bold">${childData.coins} moedas</span></p>
                            
                            <!-- Exibi√ß√£o e Configura√ß√£o da Meta -->
                            <p class="text-xl font-itim mb-2">Meta: <span class="text-purple-600 font-bold">${childData.progress.targetName}</span></p>
                            <p class="text-xl font-itim mb-2">Poupan√ßa: <span class="text-red-500 font-bold">${savedAmount} / ${goalAmount} moedas</span></p>

                            <!-- Configurar Valor da Meta -->
                            <div class="bg-yellow-50 p-3 rounded-lg mt-3 soft-card">
                                <label for="goal-value-input" class="text-lg font-bold font-itim block mb-1">Definir Valor da Meta:</label>
                                <div class="flex space-x-2">
                                    <input type="number" id="goal-value-input" placeholder="Novo Valor em Moedas" class="soft-input w-full p-2 border rounded-lg font-itim" min="1" value="${goalAmount}">
                                    <button id="set-goal-btn" class="bg-yellow-600 text-white p-2 rounded-lg font-itim hover:bg-yellow-700 action-button">Salvar</button>
                                </div>
                            </div>

                            <p class="text-xl font-itim mt-3 border-t pt-3">Tarefas: ${completedTasks} / ${totalTasks}</p>
                        </div>
                        
                        <!-- Gerenciar Moedas (Mesada/B√¥nus) -->
                        <div class="bg-gray-100 p-4 rounded-lg shadow-inner mb-4 md:mb-0 soft-card">
                            <h5 class="text-xl font-itim text-gray-800 mb-3">Dar Mesada/B√¥nus</h5>
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                                <input type="number" id="allowance-amount" placeholder="Qtd. Moedas" class="soft-input w-full sm:w-1/4 p-2 border rounded-lg font-itim" min="1" value="10">
                                <input type="text" id="allowance-reason" placeholder="Motivo (Ex: Mesada Semanal)" class="soft-input w-full sm:flex-grow p-2 border rounded-lg font-itim">
                                <button id="give-allowance-btn" class="w-full sm:w-auto bg-green-500 text-white p-2 rounded-lg font-itim hover:bg-green-600 action-button">Dar Moedas</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Coluna 2: Gerenciar Tarefas e Hist√≥rico -->
                    <div>
                        <!-- Gerenciar Tarefas -->
                        <div class="bg-gray-100 p-4 rounded-lg shadow-inner mb-4 soft-card">
                            <h5 class="text-xl font-itim text-gray-800 mb-3">Criar Tarefa</h5>
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                                <input type="text" id="parent-new-task-input" placeholder="Nova Tarefa (Ex: Lavar lou√ßa)" class="soft-input w-full sm:flex-grow p-2 border rounded-lg font-itim">
                                <button id="parent-add-task-btn" class="w-full sm:w-auto bg-purple-500 text-white p-2 rounded-lg font-itim hover:bg-purple-600 action-button">Adicionar</button>
                            </div>
                            <h5 class="text-xl font-itim text-gray-800 mt-4 border-t pt-3">Tarefas Atuais</h5>
                            <ul id="parent-tasks-list" class="space-y-1 mt-2 max-h-40 overflow-y-auto"></ul>
                        </div>

                        <!-- Hist√≥rico de Transa√ß√µes -->
                        <div class="soft-card p-4 border-t">
                            <h5 class="text-xl font-itim text-gray-800 mb-3">Hist√≥rico de Transa√ß√µes</h5>
                            <div id="parent-child-history" class="max-h-40 overflow-y-auto border p-2 rounded bg-gray-50">
                                ${renderHistoryList(childData.transactions)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Anexa listeners ao painel de gest√£o
            document.getElementById('give-allowance-btn')?.addEventListener('click', () => {
                const amount = parseInt(document.getElementById('allowance-amount').value);
                const reason = document.getElementById('allowance-reason').value.trim() || "Mesada/B√¥nus";
                giveAllowance(childData, amount, reason, currentChildId);
            });
            
            document.getElementById('parent-add-task-btn')?.addEventListener('click', () => {
                const taskText = document.getElementById('parent-new-task-input').value.trim();
                createTaskForChild(childData, taskText, currentChildId);
            });
            
            // NOVO: Listener para definir valor da meta
            document.getElementById('set-goal-btn')?.addEventListener('click', () => {
                 const newGoal = parseInt(document.getElementById('goal-value-input').value);
                 setGoalValueForChild(childData, newGoal, currentChildId);
            });
            
            // Renderiza as tarefas ativas no painel do pai
            renderTasksParent(document.getElementById('parent-tasks-list'), childData, currentChildId);
        }
        
        // NOVO: Fun√ß√£o para o Pai definir o valor da meta
        async function setGoalValueForChild(childData, newGoal, uid) {
            if (isNaN(newGoal) || newGoal <= 0) {
                 return showModal("Erro", "O valor da meta deve ser um n√∫mero positivo.");
            }
            
            childData.progress.goal = newGoal;
            
            // Substitui√ß√£o: Atualiza o documento no Supabase
            const { error } = await supabase
                .from('child_profiles')
                .update({ data: { ...childData, progress: childData.progress } }) // Atualiza o objeto JSONB completo
                .eq('user_id', uid);
            
            if (error) {
                 return showModal("Erro", `Erro ao salvar a meta: ${error.message}`);
            }
            
            showModal("Meta Definida!", `O valor da meta de **${childData.progress.targetName}** foi definido para **${newGoal} moedas**!`);
            
            const updatedData = await getChildDataSnapshot(uid);
            if (updatedData) renderChildManagement(updatedData);
        }


        function renderHistoryList(transactions) {
            return (transactions && transactions.length > 0) 
                ? `<ul class="space-y-2">${transactions.map(t => `
                    <li class="flex justify-between items-center p-2 rounded ${t.type === 'earn' ? 'bg-green-100 text-green-700' : t.type === 'donate' ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'}">
                        <span class="font-itim text-xs w-1/4">${t.date}</span>
                        <span class="font-itim text-xs w-1/2">${t.description}</span>
                        <span class="font-bold text-sm w-1/4 text-right">${t.type === 'earn' ? '+' : '-'}${t.amount} Moedas</span>
                    </li>
                `).join('')}</ul>`
                : '<p class="text-gray-500 font-itim text-center">Nenhuma transa√ß√£o recente.</p>';
        }

        async function giveAllowance(childData, amount, reason, uid) {
            if (amount <= 0 || !uid) {
                return showModal("Erro", "Quantidade inv√°lida.");
            }
            
            childData.coins += amount;
            childData.transactions = childData.transactions || [];
            childData.transactions.unshift({
                id: Date.now(),
                type: 'earn',
                amount: amount,
                description: reason,
                date: new Date().toLocaleDateString('pt-BR')
            });
            childData.transactions = childData.transactions.slice(0, 50);
            
            // Substitui√ß√£o: Salva no Supabase usando UPDATE do objeto JSONB completo
            const { error } = await supabase
                .from('child_profiles')
                .update({ data: childData })
                .eq('user_id', uid);
            
            if (error) {
                 return showModal("Erro", `Erro ao dar mesada: ${error.message}`);
            }
            
            showModal("Sucesso", `Mesada de **${amount} moedas** dada a ${childData.name}!`);
            document.getElementById('allowance-reason').value = '';
            // CORRE√á√ÉO DASHBOARD: Recarrega os dados e re-renderiza o painel do filho
            const updatedData = await getChildDataSnapshot(uid);
            if (updatedData) renderChildManagement(updatedData);
        }

        async function createTaskForChild(childData, taskText, uid) {
            if (!taskText || !uid) return;

            const newTask = {
                id: Date.now().toString(),
                text: taskText,
                completed: false
            };
            
            childData.tasks = childData.tasks || [];
            childData.tasks.push(newTask);
            
            // Substitui√ß√£o: Salva no Supabase usando UPDATE do objeto JSONB completo
            const { error } = await supabase
                .from('child_profiles')
                .update({ data: childData }) // Salva childData que j√° tem tasks atualizadas
                .eq('user_id', uid);
                
            if (error) {
                 return showModal("Erro", `Erro ao criar tarefa: ${error.message}`);
            }
            
            document.getElementById('parent-new-task-input').value = '';
            // CORRE√á√ÉO DASHBOARD: Recarrega os dados e re-renderiza o painel do filho
            const updatedData = await getChildDataSnapshot(uid);
            if (updatedData) renderChildManagement(updatedData);
            showModal("Sucesso", `Tarefa '${taskText}' adicionada para ${childData.name}.`);
        }

        function renderTasksParent(container, currentData, currentUid) {
            container.innerHTML = '';
            if (!currentData.tasks || currentData.tasks.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 pt-2 font-itim">Nenhuma tarefa.</p>';
                return;
            }

            currentData.tasks.forEach(task => {
                const li = document.createElement('li');
                
                li.className = 'flex items-center justify-between p-2 bg-gray-50 rounded-lg';
                li.innerHTML = `
                    <span class="text-gray-800 font-itim text-sm">${task.text}</span>
                    <div class="flex space-x-2 items-center">
                        <span class="text-sm font-itim ${task.completed ? 'text-green-500' : 'text-gray-500'}">${task.completed ? 'Feita' : 'Pendente'}</span>
                        <button data-task-id="${task.id}" data-uid="${currentUid}" class="delete-task-btn text-red-500 p-1 hover:text-red-700 transition-colors">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                `;
                container.appendChild(li);
            });

            document.querySelectorAll('.delete-task-btn').forEach(button => {
                 button.addEventListener('click', async (e) => {
                    const taskId = e.currentTarget.dataset.taskId;
                    const targetUid = e.currentTarget.dataset.uid;
                    
                    const childData = await getChildDataSnapshot(targetUid);
                    if (childData) {
                        childData.tasks = childData.tasks.filter(t => t.id !== taskId);
                        
                        // Substitui√ß√£o: Salva no Supabase usando UPDATE do objeto JSONB completo
                        const { error } = await supabase
                            .from('child_profiles')
                            .update({ data: childData })
                            .eq('user_id', targetUid);

                        if (error) {
                             return showModal("Erro", `Erro ao deletar tarefa: ${error.message}`);
                        }

                        renderChildManagement(childData); // Atualiza o painel do pai
                    }
                });
            });
        }
        
        // --- NOVAS FUN√á√ïES DE EDI√á√ÉO DE NOME ---

        // 1. Modal e L√≥gica para Editar Nome do PAI
        window.renderEditParentNameModal = function() {
            showModal("Editar Meu Nome", `
                <div class="space-y-4">
                    <input type="text" id="edit-parent-name-input" value="${parentData.name}" class="soft-input w-full p-3 border rounded-lg font-itim text-lg">
                    <button id="save-parent-name-btn" class="w-full bg-blue-500 text-white p-3 rounded-lg font-itim text-xl hover:bg-blue-600 transition-colors action-button">
                        Salvar Nome
                    </button>
                </div>
            `);

            document.getElementById('save-parent-name-btn')?.addEventListener('click', async () => {
                const newName = document.getElementById('edit-parent-name-input').value.trim();
                if (newName) {
                    parentData.name = newName;
                    await saveParentData(); // Salva no Supabase
                    renderParentDashboard(); // Atualiza a UI do Dashboard
                    hideModal();
                    playSound('success');
                    showModal("Sucesso", `Seu nome foi alterado para **${newName}**!`);
                } else {
                    playSound('error');
                    showModal("Erro", "O nome n√£o pode ser vazio.");
                }
            });
        }

        // 2. Modal e L√≥gica para Editar Nome da CRIAN√áA
        window.renderEditChildNameModal = function(childUid, currentName) {
            showModal("Editar Nome da Crian√ßa", `
                <div class="space-y-4">
                    <input type="text" id="edit-child-name-input" value="${currentName}" class="soft-input w-full p-3 border rounded-lg font-itim text-lg">
                    <button id="save-child-name-btn" class="w-full bg-green-500 text-white p-3 rounded-lg font-itim text-xl hover:bg-green-600 transition-colors action-button">
                        Salvar Nome
                    </button>
                </div>
            `);

            document.getElementById('save-child-name-btn')?.addEventListener('click', async () => {
                const newName = document.getElementById('edit-child-name-input').value.trim();
                if (newName && childUid) {
                    try {
                        // 1. Atualiza o documento individual da crian√ßa
                        const childDataSnapshot = await getChildDataSnapshot(childUid);
                        if (childDataSnapshot) {
                            childDataSnapshot.name = newName;
                            await supabase
                                .from('child_profiles')
                                .update({ data: childDataSnapshot })
                                .eq('user_id', childUid);
                        }

                        // 2. Atualiza a lista de refer√™ncia dentro do documento do pai
                        const childInParentList = parentData.children.find(c => c.uid === childUid);
                        if (childInParentList) {
                            childInParentList.name = newName;
                            await saveParentData(); // Salva a lista do pai atualizada
                        }

                        // 3. Atualiza a UI
                        renderChildManagement(childDataSnapshot); // Atualiza a tela de gest√£o
                        hideModal();
                        playSound('success');
                        showModal("Sucesso", `O nome foi alterado para **${newName}**!`);

                    } catch (e) {
                        console.error("Erro ao atualizar nome da crian√ßa:", e);
                        playSound('error');
                        showModal("Erro", "Falha ao salvar o nome.");
                    }
                } else {
                    playSound('error');
                    showModal("Erro", "Nome inv√°lido.");
                }
            });
        }
        
        initSupabase(); // CHAMADA ADICIONADA PARA INICIALIZAR O FLUXO DO APLICATIVO (Renomeado)
    </script>
    
    <!-- VISTAS PRINCIPAIS -->
    
    <!-- 1. VISTA DE LOGIN -->
    <div id="login-view" class="w-11/12 max-w-sm md:max-w-lg p-6 soft-card flex flex-col items-center z-10" 
         style="min-height: 591px; margin-top: 50px;">
        
        <!-- Mascote/Logo/T√≠tulo -->
        <div class="flex flex-col items-center justify-center mb-8">

             <!-- √çcone/Toggle Simples do Figma (Usamos o toggle funcional abaixo) -->
             <div class="w-14 h-8 bg-[#9AC0FB] rounded-full flex justify-center items-center p-1 mb-6 soft-card">
                 <span id="login-title-type" class="text-sm font-bold text-white font-itim">Pai</span>
            </div>

            <h2 class="text-4xl font-itim text-gray-800">Fin Family</h2>
            <!-- NOVO: Porquinho 3D -->
             <span class="text-6xl mb-2">üê∑</span>
        </div>
        
        <!-- Toggle Switch Funcional (Posicionado para melhor UX) -->
        <div class="flex items-center space-x-3 mb-6 p-2 bg-gray-100 rounded-full shadow-inner soft-card">
            <span class="font-itim text-lg text-gray-600">Crian√ßa</span>
            <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" value="" id="login-type-toggle" class="sr-only peer" checked>
                <div class="w-11 h-6 bg-gray-400 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#9AC1FB]"></div>
            </label>
            <span class="font-itim text-lg text-blue-600">Pai</span>
        </div>

        <form id="login-form" class="w-full space-y-4">
            <!-- Input 1 (Email) - WRAPPED FOR DYNAMIC HIDING -->
            <div id="parent-email-input-div"> 
                <input type="email" id="login-email-input" placeholder="E-mail" class="w-full p-4 border-0 rounded-xl soft-input font-itim placeholder-gray-500 text-base" required>
            </div>
            
            <!-- Input 2 (Password) - WRAPPED FOR DYNAMIC HIDING -->
            <div id="parent-password-input-div">
                <input type="password" id="login-password-input" placeholder="Senha" class="w-full p-4 border-0 rounded-xl soft-input font-itim placeholder-gray-500 text-base" required>
            </div>
            
            <!-- Input 3 (Child Code - Initially Hidden) -->
            <input type="text" id="login-child-code-input" placeholder="C√≥digo da Crian√ßa (4 d√≠gitos)" class="w-full p-4 border-0 rounded-xl soft-input font-itim placeholder-gray-500 text-base hidden">
            
            <p id="login-message" class="text-red-500 font-itim mt-3 text-center"></p>

            <!-- Bot√µes de A√ß√£o -->
            <div class="space-y-4 pt-4">
                <!-- Entrar (Login - Blue Figma button) -->
                <button type="submit" id="login-btn-submit" class="w-full bg-[#9AC1FB] text-gray-800 p-3 rounded-full font-itim text-xl shadow-md hover:bg-blue-400 transition-colors action-button">
                    Entrar
                </button>
                
                <!-- Criar Conta (Sign Up - Green Figma button) -->
                <!-- CORRE√á√ÉO: Usando a navega√ß√£o real para a nova vista -->
                <button type="button" onclick="showSignupView()" id="create-account-btn" class="w-full bg-[#C7F8DC] text-gray-800 p-3 rounded-full font-itim text-xl shadow-md hover:bg-green-300 transition-colors action-button">
                    Criar conta
                </button>
            </div>
        </form>

        <!-- Link Esqueceu Senha (Hid in Child View) -->
        <!-- CORRE√á√ÉO: Usando a navega√ß√£o real para a nova vista -->
        <a href="#" id="forgot-password-link" onclick="showForgotPasswordView()" class="text-sm font-itim text-gray-500 mt-4 hover:text-blue-500">Esqueceu a senha?</a>
    </div>

    <!-- 2. VISTA DE CADASTRO (SIGN UP) -->
    <div id="signup-view" class="hidden w-11/12 max-w-sm md:max-w-lg p-6 soft-card flex flex-col items-center z-10" 
         style="min-height: 591px; margin-top: 50px;">
        
        <div class="flex flex-col items-center justify-center mb-6">
            <span class="text-6xl mb-2">‚ú®</span>
            <h2 class="text-3xl font-itim text-gray-800">Criar Conta</h2>
            <p class="text-sm text-gray-500 font-itim">Seja o respons√°vel financeiro!</p>
        </div>

        <form id="signup-form" class="w-full space-y-4">
            <!-- Nome -->
            <input type="text" id="signup-name-input" placeholder="Seu Nome" class="w-full p-4 border-0 rounded-xl soft-input font-itim placeholder-gray-500 text-base" required>
            
            <!-- E-mail -->
            <input type="email" id="signup-email-input" placeholder="E-mail" class="w-full p-4 border-0 rounded-xl soft-input font-itim placeholder-gray-500 text-base" required>
            
            <!-- Senha -->
            <input type="password" id="signup-password-input" placeholder="Senha" class="w-full p-4 border-0 rounded-xl soft-input font-itim placeholder-gray-500 text-base" required>
            
            <!-- Repetir Senha -->
            <input type="password" id="signup-confirm-password-input" placeholder="Repetir Senha" class="w-full p-4 border-0 rounded-xl soft-input font-itim placeholder-gray-500 text-base" required>
            
            <p id="signup-message" class="font-itim mt-3 text-center"></p>

            <!-- Bot√£o Criar Conta (Green Figma button) -->
            <div class="space-y-4 pt-4">
                <button type="submit" id="signup-btn-submit" class="w-full bg-[#C7F8DC] text-gray-800 p-3 rounded-full font-itim text-xl shadow-md hover:bg-green-300 transition-colors action-button">
                    Criar conta
                </button>
            </div>
        </form>
        
        <a href="#" onclick="showLoginView()" class="text-sm font-itim text-gray-500 mt-4 hover:text-blue-500">Voltar para o Login</a>
    </div>

    <!-- 3. VISTA DE ESQUECEU SENHA (FORGOT PASSWORD) -->
     <div id="forgot-password-view" class="hidden w-11/12 max-w-sm md:max-w-lg p-6 soft-card flex flex-col items-center z-10" 
         style="min-height: 400px; margin-top: 50px;">
        
        <div class="flex flex-col items-center justify-center mb-8">
            <span class="text-6xl mb-2">üîë</span>
            <h2 class="text-3xl font-itim text-gray-800">Esqueceu a Senha?</h2>
            <p class="text-sm text-gray-500 font-itim text-center">Enviaremos um link de recupera√ß√£o.</p>
        </div>

        <form id="forgot-password-form" class="w-full space-y-4">
            <!-- E-mail -->
            <input type="email" id="reset-email-input" placeholder="E-mail" class="w-full p-4 border-0 rounded-xl soft-input font-itim placeholder-gray-500 text-base" required>
            
            <p id="reset-message" class="font-itim mt-3 text-center"></p>

            <!-- Bot√£o Entrar (Blue Figma button) -->
            <div class="space-y-4 pt-4">
                <button type="submit" id="reset-btn-submit" class="w-full bg-[#9AC1FB] text-gray-800 p-3 rounded-full font-itim text-xl shadow-md hover:bg-blue-400 transition-colors action-button">
                    Redefinir Senha
                </button>
            </div>
        </form>
        
        <a href="#" onclick="showLoginView()" class="text-sm font-itim text-gray-500 mt-4 hover:text-blue-500">Voltar para o Login</a>
    </div>

    <!-- NOVO: 4. VISTA DE REDEFINI√á√ÉO DE SENHA (RESET PASSWORD) -->
    <div id="reset-password-view" class="hidden w-11/12 max-w-sm md:max-w-lg p-6 soft-card flex flex-col items-center z-10" 
         style="min-height: 400px; margin-top: 50px;">
        
        <div class="flex flex-col items-center justify-center mb-8">
            <span class="text-6xl mb-2">üîí</span>
            <h2 class="text-3xl font-itim text-gray-800">Nova Senha</h2>
            <p class="text-sm text-gray-500 font-itim text-center">Digite a sua nova senha.</p>
        </div>

        <form id="new-reset-password-form" class="w-full space-y-4">
            <!-- Nova Senha -->
            <input type="password" id="new-password-input" placeholder="Nova Senha (m√≠n. 6 d√≠gitos)" class="w-full p-4 border-0 rounded-xl soft-input font-itim placeholder-gray-500 text-base" required>
            
            <!-- Confirma√ß√£o de Senha -->
            <input type="password" id="confirm-new-password-input" placeholder="Confirmar Nova Senha" class="w-full p-4 border-0 rounded-xl soft-input font-itim placeholder-gray-500 text-base" required>
            
            <p id="new-reset-message" class="font-itim mt-3 text-center"></p>

            <!-- Bot√£o Atualizar Senha -->
            <div class="space-y-4 pt-4">
                <button type="submit" id="update-password-btn" class="w-full bg-green-500 text-white p-3 rounded-full font-itim text-xl shadow-md hover:bg-green-600 transition-colors action-button">
                    Atualizar Senha
                </button>
            </div>
        </form>
        
        <!-- O usu√°rio ser√° redirecionado automaticamente -->
    </div>


    <!-- DASHBOARD DO PAI -->
    <!-- Ajustado para max-w-full e md:max-w-4xl (Desktop) e usa nova classe parent-desktop-card -->
    <div id="parent-dashboard-view" class="hidden w-full max-w-full md:max-w-4xl mobile-card parent-desktop-card relative overflow-hidden app-gradient">
        
        <!-- VISTA DE LISTAGEM DE CRIAN√áAS (TELA 1) -->
        <div id="parent-home-view" class="p-4 pt-8 h-full">
            
            <!-- HEADER (FORA DO CART√ÉO) -->
            <div class="flex justify-between items-start z-20 relative mb-4">
                 <!-- CORRE√á√ÉO: Sauda√ß√£o mais espa√ßada -->
                 <!-- ATUALIZADO: O JS agora define o nome correto aqui -->
                 <h1 id="parent-greeting" class="text-4xl font-itim text-black mt-2 flex items-center">
                    Ol√°, Respons√°vel!
                 </h1>
                 
                 <!-- Bot√µes de A√ß√£o Superiores (√çcones) -->
                 <div class="flex space-x-2 pt-2">
                    <!-- Bot√£o Add Crian√ßa -->
                    <button onclick="renderAddChildModal()" class="bg-purple-500 text-white p-3 rounded-full hover:bg-purple-600 transition-colors shadow-md w-10 h-10 flex items-center justify-center action-button" title="Adicionar Crian√ßa">
                        <i class="fa-solid fa-plus text-xl"></i>
                    </button>
                    <!-- Bot√£o Sair -->
                    <button onclick="parentLogout()" class="bg-red-500 text-white p-3 rounded-full hover:bg-red-600 transition-colors shadow-md w-10 h-10 flex items-center justify-center action-button" title="Sair do Dashboard">
                        <i class="fa-solid fa-right-from-bracket text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Cart√£o Principal (Figma white card) -->
            <!-- Ajustado para Desktop: top/bottom para usar a altura total dispon√≠vel, e grid de 2 colunas para crian√ßas -->
            <div class="soft-card p-4 absolute inset-x-4 bottom-4 top-[120px] z-10 overflow-y-auto">
                
                <h3 class="text-2xl font-itim text-blue-700 mb-3">Perfis Registrados</h3>
                <!-- NOVO: Grid de 1 coluna no mobile, 2 colunas no desktop -->
                <div id="parent-children-list" class="space-y-4 md:space-y-0 md:grid md:grid-cols-2 md:gap-4">
                    <!-- Perfis de crian√ßas ser√£o injetados aqui -->
                </div>
                
            </div>
        </div>

        <!-- VISTA DE GERENCIAMENTO DE CRIAN√áA (Tela 2) -->
        <div id="child-management-view" class="hidden p-4 h-full overflow-y-auto">
            
            <!-- HEADER DO GERENCIAMENTO (Simplificado) -->
            <div class="flex justify-start items-center mb-4 pb-3 border-b">
                <!-- Bot√£o Voltar (√çcone √önico) -->
                <button onclick="showParentHome()" class="bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 transition-colors shadow-md w-10 h-10 flex items-center justify-center action-button" title="Voltar">
                    <i class="fa-solid fa-arrow-left text-xl"></i>
                </button>
                <h1 class="text-2xl font-itim text-blue-800 ml-4">Gerenciamento</h1>
            </div>
            
            <div id="child-management-container">
                <!-- Conte√∫do de Gerenciamento Injetado aqui (ID CORRIGIDO) -->
            </div>
        </div>
    </div>

    <!-- APP DA CRIAN√áA (VISTA PRINCIPAL) -->
    <!-- Ajustado para max-w-xl (Desktop) e nova classe child-desktop-card -->
    <div id="child-app-view" class="hidden w-full max-w-sm md:max-w-xl p-4 soft-card mobile-card child-desktop-card relative overflow-hidden">
        
        <!-- NOVO: Bot√£o de Sair no canto superior direito -->
        <button id="child-logout-btn" class="absolute top-4 right-4 z-20 text-red-600 text-2xl p-2 rounded-full hover:bg-red-100 transition-colors">
            <i class="fa-solid fa-right-from-bracket"></i>
        </button>

        <!-- Container Principal - Layout em 2 Colunas no Desktop -->
        <div class="grid grid-cols-1 md:grid-cols-2 md:gap-6 h-full">

            <!-- Coluna 1: Mascote, Saldo e A√ß√µes (Mobile: 1¬™ se√ß√£o) -->
            <div class="md:order-1 flex flex-col items-center pt-8 pb-4 relative">
                 <p id="piggy-greeting" class="absolute top-0 text-lg font-itim bg-yellow-100 p-2 rounded-lg transition-opacity opacity-0 text-center z-10 soft-card">Ol√°!</p>
                
                <div id="animated-piggy-container" class="w-32 h-32 md:w-40 md:h-40 flex items-center justify-center relative">
                    <span id="piggy-character" class="piggy-character text-8xl md:text-9xl">üê∑</span>
                </div>

                <div class="flex flex-col items-center mt-4">
                    <!-- Moedas maiores e em destaque -->
                    <span class="text-7xl md:text-8xl text-orange-500 font-itim font-extrabold" id="coin-count">0</span>
                    <div class="flex items-center space-x-2 mt-2">
                        <i class="fa-solid fa-coins text-yellow-500 text-4xl"></i>
                        <span class="text-2xl font-itim text-gray-700">Moedas M√°gicas</span>
                    </div>
                </div>

                <!-- Bot√µes de A√ß√£o (Ganhar, Poupar, Gastar, Doar) - Agora abaixo do Mascote -->
                <!-- Grid de 4 colunas no mobile, 2x2 no desktop (md:grid-cols-2) -->
                <div class="grid grid-cols-4 md:grid-cols-2 gap-3 mt-8 pb-4 md:w-full">
                    
                    <!-- Ganhar (Jogo) -->
                    <button id="action-ganhar" class="action-button action-green p-3 flex flex-col items-center justify-center text-white col-span-1">
                        <i class="fa-solid fa-gamepad text-3xl"></i>
                        <span id="earn-text" class="text-sm font-itim mt-1">Ganhar</span>
                        <span id="earn-amount" class="text-xs font-bold">+10</span>
                    </button>

                    <!-- Poupar (Permite escolher valor) -->
                    <button id="action-poupar" class="action-button action-blue p-3 flex flex-col items-center justify-center text-white col-span-1">
                        <i class="fa-solid fa-sack-dollar text-3xl"></i>
                        <span class="text-sm font-itim mt-1">Poupar</span>
                        <span id="save-amount" class="text-xs font-bold">Mudar</span>
                    </button>

                    <!-- Gastar (Loja M√°gica) -->
                    <button id="action-gastar" class="action-button action-red p-3 flex flex-col items-center justify-center text-white col-span-1">
                        <i class="fa-solid fa-store text-3xl"></i>
                        <span class="text-sm font-itim mt-1">Gastar</span>
                        <span id="spend-amount" class="text-xs font-bold">Comprar</span>
                    </button>

                    <!-- Doar (Conquistas/Badges) -->
                    <button id="action-doar" class="action-button action-yellow p-3 flex flex-col items-center justify-center text-white col-span-1">
                        <i class="fa-solid fa-trophy text-3xl"></i>
                        <span class="text-sm font-itim mt-1">Conquistas</span>
                        <span id="donate-amount" class="text-xs font-bold">Ver</span>
                    </button>
                </div>
            </div>

            <!-- Coluna 2: Cart√£o de Perfil, Progresso e Tarefas (Mobile: 2¬™ se√ß√£o) -->
            <div class="md:order-2 flex flex-col">

                <!-- Cart√£o de Perfil -->
                <div class="soft-card p-4 mt-4 md:mt-0 border-2 border-gray-100 flex-shrink-0">
                    <div class="flex items-center space-x-4">
                        <!-- Alterar foto de perfil ao clicar (cursor-pointer adicionado) -->
                        <div id="profile-icon-container" class="w-16 h-16 rounded-full overflow-hidden profile-placeholder flex items-center justify-center border-4 border-white cursor-pointer transition-transform hover:scale-105 active:scale-95">
                            <i class="fa-solid fa-user-astronaut text-4xl text-gray-500"></i>
                        </div>
                        <div>
                            <div class="flex items-center space-x-2">
                                <h2 id="user-name" class="text-3xl font-itim text-gray-800">Alex</h2>
                                <div id="emotion-display-container" class="text-3xl p-1 cursor-pointer transition-transform hover:scale-110 active:scale-95 soft-card rounded-full" aria-label="Selecione sua Emo√ß√£o">üòä</div>
                            </div>
                            <!-- META REMOVIDA DAQUI E MOVIDA PARA A BARRA DE PROGRESSO -->
                        </div>
                    </div>
                </div>

                <!-- Se√ß√£o de Progresso e Tarefas (Ocupa o restante do espa√ßo) -->
                <div class="soft-card p-4 mt-6 flex-grow overflow-y-auto">
                    <h3 class="text-xl font-itim text-gray-700 mb-3">Progresso</h3>
                    
                    <!-- Barra de Progresso (Poupan√ßa) - (INTERATIVO - AGORA CONT√âM A META) -->
                    <div class="mb-4 cursor-pointer hover:opacity-80 transition-opacity p-1" id="goal-section" title="Alterar Meta">
                        
                        <!-- Cabe√ßalho da Meta (Nome e Valor) -->
                        <div class="flex justify-between items-end mb-1 px-1">
                             <span id="goal-name-display" class="font-bold text-blue-600 text-lg leading-none font-itim">Meta</span>
                             <span id="goal-amount-display" class="text-xs text-gray-500 font-bold font-itim">0/0 moedas</span>
                        </div>

                        <div class="w-full bg-gray-300 rounded-full h-4 relative overflow-hidden border border-gray-200">
                            <!-- Cantos mais arredondados para a barra de progresso -->
                            <div id="progress-bar" class="h-full rounded-full bg-green-500 transition-all duration-500 relative" style="width: 0%;">
                                <!-- Efeito de brilho animado -->
                                <div class="absolute top-0 left-0 bottom-0 right-0 bg-white opacity-20 w-full animate-pulse"></div>
                            </div>
                        </div>
                        <div class="flex justify-between mt-1 text-sm font-itim text-gray-600 px-1">
                            <span>Poupan√ßa</span>
                            <span id="progress-percent" class="font-bold text-green-600">0%</span>
                        </div>
                    </div>

                    <!-- Tarefas (EST√ÅTICO - SEM CLIQUE) -->
                    <div class="p-3 border rounded-xl soft-card bg-gray-50">
                        <div class="flex justify-between items-center">
                            <span class="text-lg font-itim text-gray-800">Tarefas Di√°rias</span>
                            <span class="text-lg font-itim text-purple-600"><span id="tasks-done">0</span>/<span id="tasks-total">0</span></span>
                        </div>
                    </div>
                    
                    <!-- Lista R√°pida de Tarefas (Escondida, renderizada via JS) -->
                    <ul id="tasks-list" class="mt-3 max-h-40 md:max-h-60 overflow-y-auto border rounded-xl divide-y divide-gray-200 soft-card">
                        <!-- Tarefas injetadas aqui -->
                    </ul>
                </div>
                
                 <!-- Bot√£o de A√ß√£o Auxiliar -->
                <div class="flex justify-center space-x-4 mt-4 mb-2 flex-shrink-0">
                    <button onclick="renderHistoryModal()" class="text-sm text-gray-600 font-itim hover:text-gray-800 transition-colors">
                        <i class="fa-solid fa-clock-rotate-left mr-1"></i> Hist√≥rico
                    </button>
                </div>

            </div>

        </div>
        
    </div>


    <!-- SIDEBAR (Mantida para fins de re-uso no futuro, mas sem bot√£o para abrir) -->
    <div id="sidebar" class="sidebar fixed top-0 left-0 w-64 h-full bg-white shadow-2xl transform -translate-x-full p-4 flex flex-col justify-between z-50 soft-card">
        <div>
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-2xl font-itim text-blue-600">Menu M√°gico</h3>
                <button id="close-sidebar-btn" class="text-2xl text-gray-500 hover:text-gray-800 p-1">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            
            <ul class="space-y-3 font-itim text-lg">
                <li id="menu-profile" class="cursor-pointer p-2 rounded-lg hover:bg-gray-100 transition-colors soft-card"><i class="fa-solid fa-user mr-3"></i> Perfil e √çcone</li>
                <li id="menu-shop" class="cursor-pointer p-2 rounded-lg hover:bg-gray-100 transition-colors soft-card"><i class="fa-solid fa-store mr-3"></i> Loja M√°gica</li>
                <li id="menu-badges" class="cursor-pointer p-2 rounded-lg hover:bg-gray-100 transition-colors soft-card"><i class="fa-solid fa-trophy mr-3"></i> Conquistas</li>
                <li id="menu-history" class="cursor-pointer p-2 rounded-lg hover:bg-gray-100 transition-colors soft-card"><i class="fa-solid fa-clock-rotate-left mr-3"></i> Hist√≥rico</li>
                <li id="menu-themes" class="cursor-pointer p-2 rounded-lg hover:bg-gray-100 transition-colors soft-card"><i class="fa-solid fa-palette mr-3"></i> Temas</li>
            </ul>
        </div>

        <button id="menu-logout" class="bg-red-500 text-white p-3 rounded-lg font-itim text-xl hover:bg-red-600 transition-colors w-full action-button">
            <i class="fa-solid fa-right-from-bracket mr-2"></i> Sair
        </button>
    </div>

    <!-- MODAL PRINCIPAL (Usado para todas as intera√ß√µes) -->
    <div id="main-modal" class="hidden modal-overlay fixed inset-0 flex items-center justify-center p-4">
        <div class="modal-content bg-white p-6 rounded-xl w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 id="modal-title" class="text-2xl font-itim text-gray-800">T√≠tulo do Modal</h3>
                <button id="modal-close-btn" class="text-2xl text-gray-500 hover:text-gray-800 p-1">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div id="modal-body" class="font-itim text-gray-700">
                Conte√∫do din√¢mico aqui.
            </div>
        </div>
    </div>
    
    <!-- MODAL DO MINI-GAME -->
    <div id="game-modal" class="hidden modal-overlay fixed inset-0 flex items-center justify-center p-4">
        <div class="modal-content bg-white p-4 rounded-xl max-w-xs flex flex-col items-center w-full">
            <h3 class="text-2xl font-itim text-purple-600 mb-2">Mini-Game: Saltitante</h3>
            <canvas id="game-canvas" width="300" height="400" class="mb-3"></canvas>
            <p class="font-itim text-lg mb-2">Pontua√ß√£o: <span id="game-score" class="font-bold text-orange-500">0</span></p>
            <p id="game-message" class="font-itim text-sm text-center text-gray-600 mb-3">Mova o dedo na tela e pule nas nuvens!</p>
            <button onclick="gameOver()" class="bg-red-500 text-white p-2 rounded-lg font-itim hover:bg-red-600 action-button">Sair do Jogo</button>
        </div>
    </div>
</body>
</html>
