<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Fin Family - Respons√°vel</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- Depend√™ncias Essenciais -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Fredoka', 'sans-serif'] },
                    animation: { 'fade-in-up': 'fadeInUp 0.4s ease-out forwards', 'pulse-slow': 'pulse 3s infinite' },
                    keyframes: { fadeInUp: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } },
                    boxShadow: { 'soft-blue': '0 20px 40px -15px rgba(59, 130, 246, 0.3)', 'card-glow': '0 30px 60px -15px rgba(59, 130, 246, 0.25), 0 0 20px rgba(255,255,255,0.8) inset' }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Fredoka', sans-serif; } 
        .soft-input { border: 2px solid #E2E8F0; transition: 0.3s; } 
        .soft-input:focus { border-color: #60A5FA; outline: none; }
        
        /* Estilos do Tutorial */
        .tutorial-overlay {
            background-color: rgba(0, 0, 0, 0.7);
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 50;
            pointer-events: auto; /* Bloqueia cliques fora */
        }
        
        /* Highlight com box-shadow invertido */
        .tutorial-highlight {
            position: relative;
            z-index: 51; /* Acima do overlay */
            background-color: white;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7), 0 0 20px rgba(255, 255, 255, 0.8); /* Foco visual */
            border-radius: 12px;
            pointer-events: none; /* Deixa interagir apenas se necess√°rio, mas o tutorial guia */
        }

        .tutorial-tooltip {
            position: absolute;
            background: white;
            padding: 20px;
            border-radius: 16px;
            width: 300px;
            z-index: 52;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: fadeInUp 0.3s ease-out;
        }
        
        .tutorial-arrow {
            position: absolute;
            width: 0; height: 0;
            border-style: solid;
        }
    </style>
</head>
<body class="bg-blue-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const supabase = window.supabase.createClient("https://jwwgsyibgwpvgfbsltzr.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3d2dzeWliZ3dwdmdmYnNsdHpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzNzkzMDAsImV4cCI6MjA3ODk1NTMwMH0.9iA_dKu4UJf-tQV03YdG8J1N4FhuP_flxHr7HWDbt9I");

        // Defaults atualizados com settings de aprova√ß√£o
        const DEFAULT_CHILD_DATA = { 
            name: "Crian√ßa", 
            coins: 0, 
            tasks: [], 
            transactions: [], 
            progress: { goals: [] }, 
            profileIcon: { type: 'fa-icon', value: 'fa-user-astronaut' },
            currentEmotion: { value: 'üòä' }, // Adicionado emo√ß√£o default
            settings: { parentApprovalRequired: false } // Configura√ß√£o de aprova√ß√£o
        };

        // Componente Modal Gen√©rico para React
        const Modal = ({ title, onClose, children }) => (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in-up">
                <div className="bg-white rounded-[2rem] p-6 max-w-sm w-full shadow-2xl relative border-4 border-white max-h-[90vh] overflow-y-auto">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-2xl font-bold text-gray-800">{title}</h3>
                        <button onClick={onClose} className="text-gray-400 hover:text-red-500 text-xl"><i class="fa-solid fa-times"></i></button>
                    </div>
                    {children}
                </div>
            </div>
        );

        // --- COMPONENTE DE TUTORIAL ---
        const Tutorial = ({ steps, onClose }) => {
            const [currentStep, setCurrentStep] = useState(0);
            const [highlightStyle, setHighlightStyle] = useState({});
            const [tooltipStyle, setTooltipStyle] = useState({});

            useEffect(() => {
                // Pequeno delay para garantir que o DOM renderizou
                const timer = setTimeout(updatePosition, 100);
                window.addEventListener('resize', updatePosition);
                return () => {
                    clearTimeout(timer);
                    window.removeEventListener('resize', updatePosition);
                };
            }, [currentStep]);

            const updatePosition = () => {
                const step = steps[currentStep];
                if (!step) return;

                const targetEl = document.querySelector(step.target);
                
                if (targetEl) {
                    const rect = targetEl.getBoundingClientRect();
                    
                    // Highlight (caixa iluminada sobre o elemento)
                    setHighlightStyle({
                        top: rect.top - 5,
                        left: rect.left - 5,
                        width: rect.width + 10,
                        height: rect.height + 10,
                        position: 'fixed',
                        borderRadius: '16px', // Arredondamento suave
                        zIndex: 51,
                        boxShadow: '0 0 0 9999px rgba(0, 0, 0, 0.7)' // Overlay escuro
                    });

                    // Tooltip (bal√£o de texto)
                    let top = rect.bottom + 20;
                    let left = rect.left + (rect.width / 2) - 150; // Centraliza horizontalmente

                    // Ajustes de borda da tela
                    if (left < 10) left = 10;
                    if (left + 300 > window.innerWidth) left = window.innerWidth - 310;
                    
                    // Se n√£o couber embaixo, joga pra cima
                    if (top + 200 > window.innerHeight) {
                        top = rect.top - 240; 
                    }

                    setTooltipStyle({
                        top: top,
                        left: left,
                        position: 'fixed'
                    });
                } else {
                    // Se o elemento n√£o existir (ex: lista vazia ou passo introdut√≥rio), centraliza na tela
                    setHighlightStyle({ display: 'none' }); // Remove o highlight f√≠sico
                    setTooltipStyle({
                        top: '50%',
                        left: '50%',
                        transform: 'translate(-50%, -50%)',
                        position: 'fixed',
                        boxShadow: '0 0 0 9999px rgba(0, 0, 0, 0.7)' // Overlay escuro total
                    });
                }
            };

            const handleNext = () => {
                if (currentStep < steps.length - 1) {
                    setCurrentStep(currentStep + 1);
                } else {
                    onClose();
                }
            };

            const step = steps[currentStep];

            return (
                <div className="fixed inset-0 z-50 pointer-events-auto">
                    {/* Elemento de Destaque Visual (apenas se tiver target vis√≠vel) */}
                    <div style={highlightStyle} className="transition-all duration-300 pointer-events-none"></div>

                    {/* Tooltip de Texto */}
                    <div style={tooltipStyle} className="tutorial-tooltip bg-white p-6 rounded-2xl shadow-2xl z-52 flex flex-col items-center text-center border-4 border-blue-100 transition-all duration-300">
                        <div className="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-500 text-2xl mb-3 animate-pulse-slow">
                            <i className={`fa-solid ${step.icon || 'fa-info'}`}></i>
                        </div>
                        <h4 className="text-xl font-bold text-slate-800 mb-2">{step.title}</h4>
                        <p className="text-slate-600 text-sm mb-6 leading-relaxed">{step.content}</p>
                        
                        <div className="flex justify-between w-full">
                            <span className="text-xs text-gray-400 font-bold self-center">Passo {currentStep + 1}/{steps.length}</span>
                            <button onClick={handleNext} className="bg-blue-500 text-white px-6 py-2 rounded-xl font-bold hover:bg-blue-600 transition-colors shadow-md">
                                {currentStep === steps.length - 1 ? 'Concluir! üéâ' : 'Pr√≥ximo ‚Üí'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };


        function ParentDashboard() {
            const [parentData, setParentData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('list'); 
            const [customShopItems, setCustomShopItems] = useState([]);
            
            // Novos estados para gerenciamento detalhado
            const [selectedChild, setSelectedChild] = useState(null); // Objeto completo da crian√ßa selecionada
            const [modalOpen, setModalOpen] = useState(false);
            const [modalType, setModalType] = useState(null); // 'settings', 'edit-goal', 'give-money', 'add-task'
            const [editingGoal, setEditingGoal] = useState(null); // Meta sendo editada
            
            // Estado do Tutorial
            const [showTutorial, setShowTutorial] = useState(false);
            // Novo: Estado para saber se estamos no tutorial detalhado da crian√ßa
            const [childTutorialMode, setChildTutorialMode] = useState(false);

            useEffect(() => {
                const checkAuth = async () => {
                    const session = localStorage.getItem('fin_session');
                    if (!session || JSON.parse(session).role !== 'parent') { window.location.href = 'fluxo-login.html'; return; }
                    const sessionData = JSON.parse(session);
                    const { data } = await supabase.from('parent_control').select('data').eq('user_id', sessionData.uid).single();
                    setParentData(data ? data.data : { name: "Respons√°vel", children: [] });
                    if(data && data.data.shopItems) setCustomShopItems(data.data.shopItems);
                    
                    // Verifica se √© a primeira vez (Tutorial Geral)
                    const tutorialSeen = localStorage.getItem('parent_tutorial_seen');
                    if (!tutorialSeen) {
                        setTimeout(() => setShowTutorial(true), 1500); // Delay para carregar a UI
                    }
                    
                    setLoading(false);
                };
                checkAuth();
            }, []);

            const updateParentData = async (newData) => {
                const session = JSON.parse(localStorage.getItem('fin_session'));
                await supabase.from('parent_control').upsert({ user_id: session.uid, data: newData });
                setParentData(newData);
            };

            // Fun√ß√£o para carregar detalhes completos da crian√ßa
            const loadChildDetails = async (childUid) => {
                setLoading(true);
                const { data } = await supabase.from('child_profiles').select('data').eq('user_id', childUid).single();
                if (data) {
                    // Merge com defaults para garantir campos novos
                    const mergedData = { ...DEFAULT_CHILD_DATA, ...data.data, uid: childUid };
                    if (!mergedData.progress.goals) mergedData.progress.goals = [];
                    if (!mergedData.settings) mergedData.settings = DEFAULT_CHILD_DATA.settings;
                    
                    setSelectedChild(mergedData);
                    setView('child-detail');
                    
                    // Verifica se deve mostrar o tutorial detalhado da crian√ßa
                    const childTutorialSeen = localStorage.getItem('parent_child_tutorial_seen');
                    if (!childTutorialSeen) {
                        setChildTutorialMode(true);
                        setTimeout(() => setShowTutorial(true), 1000);
                    }
                }
                setLoading(false);
            };

            const updateChildData = async (updatedChild) => {
                // Atualiza no banco
                await supabase.from('child_profiles').update({ data: updatedChild }).eq('user_id', updatedChild.uid);
                // Atualiza estado local
                setSelectedChild(updatedChild);
            };

            // Toggle Configura√ß√£o de Aprova√ß√£o
            const toggleApprovalSetting = async () => {
                if (!selectedChild) return;
                const newSettings = { ...selectedChild.settings, parentApprovalRequired: !selectedChild.settings?.parentApprovalRequired };
                const updated = { ...selectedChild, settings: newSettings };
                await updateChildData(updated);
            };

            // Fun√ß√µes de Gest√£o de Metas (Pai)
            const handleGoalUpdate = async (goalId, newAmount, newName, isApproved) => {
                const updatedGoals = selectedChild.progress.goals.map(g => {
                    if (g.id === goalId) {
                        return { ...g, amount: Number(newAmount), name: newName, approved: isApproved };
                    }
                    return g;
                });
                await updateChildData({ ...selectedChild, progress: { ...selectedChild.progress, goals: updatedGoals } });
                setModalOpen(false);
            };

            const handleDeleteGoal = async (goalId) => {
                if(!confirm("Remover esta meta? O valor guardado voltar√° para o saldo livre da crian√ßa.")) return;
                
                const goal = selectedChild.progress.goals.find(g => g.id === goalId);
                const refund = goal.saved;
                const newGoals = selectedChild.progress.goals.filter(g => g.id !== goalId);
                
                // Reembolsa e registra transa√ß√£o
                let newTransactions = selectedChild.transactions;
                if(refund > 0) {
                    newTransactions = [{
                        id: Date.now(), type: 'earn', amount: refund, 
                        description: `Reembolso Meta Cancelada: ${goal.name}`, 
                        date: new Date().toLocaleDateString() 
                    }, ...selectedChild.transactions];
                }

                await updateChildData({ 
                    ...selectedChild, 
                    coins: selectedChild.coins + refund,
                    progress: { ...selectedChild.progress, goals: newGoals },
                    transactions: newTransactions
                });
            };

            // --- NOVAS FUN√á√ïES: DAR DINHEIRO & TAREFAS ---

            const handleGiveMoney = async (amount, reason) => {
                if (amount <= 0) return alert("Valor inv√°lido.");
                const newCoins = selectedChild.coins + Number(amount);
                const newTransaction = {
                    id: Date.now(),
                    type: 'earn',
                    amount: Number(amount),
                    description: reason || "Mesada/B√¥nus",
                    date: new Date().toLocaleDateString()
                };
                
                await updateChildData({ 
                    ...selectedChild, 
                    coins: newCoins,
                    transactions: [newTransaction, ...selectedChild.transactions]
                });
                setModalOpen(false);
                alert(`Enviado ${amount} moedas para ${selectedChild.name}!`);
            };

            const handleAddTask = async (taskText, rewardAmount) => {
                if (!taskText) return alert("Digite a descri√ß√£o da tarefa.");
                const newTask = {
                    id: Date.now().toString(),
                    text: taskText,
                    reward: Number(rewardAmount),
                    completed: false,
                    approved: false // Nova flag: Precisa ser aprovada ap√≥s conclu√≠da
                };
                
                await updateChildData({ 
                    ...selectedChild, 
                    tasks: [...selectedChild.tasks, newTask]
                });
                setModalOpen(false);
                alert("Tarefa criada!");
            };

            const handleApproveTask = async (taskId) => {
                const task = selectedChild.tasks.find(t => t.id === taskId);
                if (!task) return;

                if (!task.completed) {
                    // Se o pai marcar como conclu√≠da manualmente
                    task.completed = true;
                }
                
                // Aprova e libera moedas
                task.approved = true;
                const newCoins = selectedChild.coins + (task.reward || 0);
                const newTransaction = {
                    id: Date.now(),
                    type: 'earn',
                    amount: task.reward || 0,
                    description: `Tarefa Aprovada: ${task.text}`,
                    date: new Date().toLocaleDateString()
                };

                // Atualiza lista de tarefas
                const updatedTasks = selectedChild.tasks.map(t => t.id === taskId ? task : t);

                await updateChildData({
                    ...selectedChild,
                    coins: newCoins,
                    tasks: updatedTasks,
                    transactions: [newTransaction, ...selectedChild.transactions]
                });
            };
            
            const handleDeleteTask = async (taskId) => {
                const updatedTasks = selectedChild.tasks.filter(t => t.id !== taskId);
                await updateChildData({ ...selectedChild, tasks: updatedTasks });
            };


            // Fun√ß√µes Auxiliares (Add Child, etc - Mantidas simplificadas)
            const addChild = async () => {
                const name = prompt("Nome da crian√ßa:");
                if (!name) return;
                const uid = JSON.parse(localStorage.getItem('fin_session')).uid;
                const newUid = crypto.randomUUID();
                const newCode = Math.floor(1000 + Math.random() * 9000).toString();
                await supabase.from('child_profiles').insert([{ user_id: newUid, parent_id: uid, data: { ...DEFAULT_CHILD_DATA, name } }]);
                const updated = { ...parentData, children: [...parentData.children, { uid: newUid, name, code: newCode, profileIcon: { type: 'fa-icon', value: 'fa-user-astronaut' } }] };
                await updateParentData(updated);
                alert(`C√≥digo: ${newCode}`);
            };

            // Shop Logic (Mantida)
            const addShopItem = async () => { /* ... mesma l√≥gica anterior ... */ };
            const deleteShopItem = async (id) => { /* ... mesma l√≥gica anterior ... */ };
            
            // --- DADOS DO TUTORIAL (DIN√ÇMICO) ---
            const getTutorialSteps = () => {
                if (childTutorialMode) {
                    return [
                        {
                            target: null,
                            title: "Perfil da Crian√ßa üë§",
                            content: "Bem-vindo ao perfil detalhado! Aqui voc√™ gerencia tudo sobre esta crian√ßa especificamente.",
                            icon: "fa-user"
                        },
                        {
                            target: "#btn-give-money",
                            title: "Dar Mesada üí∞",
                            content: "Use este bot√£o para enviar moedas instantaneamente (mesada, presente, b√¥nus).",
                            icon: "fa-coins"
                        },
                        {
                            target: "#btn-add-task",
                            title: "Criar Tarefas üìù",
                            content: "Crie tarefas com recompensa. A crian√ßa marca como feita, e voc√™ aprova para liberar o pagamento.",
                            icon: "fa-list-check"
                        },
                        {
                            target: "#btn-settings",
                            title: "Configura√ß√µes ‚öôÔ∏è",
                            content: "Aqui voc√™ define se as metas precisam da sua aprova√ß√£o antes que a crian√ßa comece a poupar.",
                            icon: "fa-cog"
                        },
                        {
                            target: "#goals-section",
                            title: "Metas e Aprova√ß√µes üéØ",
                            content: "Acompanhe o progresso das metas. Se a aprova√ß√£o estiver ligada, novas metas aparecer√£o aqui como 'Pendentes' para voc√™ liberar.",
                            icon: "fa-bullseye"
                        }
                    ];
                }
                
                // Tutorial Padr√£o (Home)
                return [
                    {
                        target: null,
                        title: "Bem-vindo ao Fin Family! üëã",
                        content: "Este √© o seu Painel de Controle. Aqui voc√™ gerencia a educa√ß√£o financeira dos seus filhos de forma simples e divertida!",
                        icon: "fa-hand-sparkles"
                    },
                    {
                        target: "#add-child-btn-tutorial",
                        title: "Adicione Crian√ßas üë∂",
                        content: "Comece clicando aqui para criar perfis. Cada crian√ßa ter√° um c√≥digo de acesso √∫nico.",
                        icon: "fa-user-plus"
                    },
                    {
                        target: "#help-btn-tutorial",
                        title: "Precisa de Ajuda? ‚ùì",
                        content: "Clique neste √≠cone a qualquer momento para ver este tutorial novamente.",
                        icon: "fa-question"
                    }
                ];
            };
            
            // Fun√ß√£o para iniciar o tutorial manualmente (bot√£o de ajuda)
            const handleManualHelp = () => {
                // Determina o modo baseado na view atual
                if (view === 'child-detail') {
                    setChildTutorialMode(true);
                } else {
                    setChildTutorialMode(false);
                }
                setShowTutorial(true);
            };

            if (loading) return <div className="flex h-screen items-center justify-center text-blue-500 font-bold">Carregando...</div>;

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-100 via-teal-50 to-indigo-100 p-4 relative overflow-hidden">
                    <div className="absolute inset-0 opacity-40 bg-polka animate-gradient-xy"></div>
                    
                    {/* TUTORIAL OVERLAY */}
                    {showTutorial && (
                        <Tutorial 
                            steps={getTutorialSteps()} 
                            onClose={() => { 
                                setShowTutorial(false); 
                                if (childTutorialMode) {
                                    localStorage.setItem('parent_child_tutorial_seen', 'true');
                                } else {
                                    localStorage.setItem('parent_tutorial_seen', 'true'); 
                                }
                            }} 
                        />
                    )}

                    {/* MODAIS */}
                    {modalOpen && modalType === 'settings' && (
                        <Modal title={`Configura√ß√µes de ${selectedChild.name}`} onClose={() => setModalOpen(false)}>
                            <div className="space-y-4">
                                <div className="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                                    <div>
                                        <p className="font-bold text-gray-700">Aprova√ß√£o de Metas</p>
                                        <p className="text-xs text-gray-500">Exigir sua aprova√ß√£o para novas metas criadas pela crian√ßa.</p>
                                    </div>
                                    <button 
                                        onClick={toggleApprovalSetting}
                                        className={`w-12 h-6 rounded-full p-1 transition-colors ${selectedChild.settings?.parentApprovalRequired ? 'bg-green-500' : 'bg-gray-300'}`}
                                    >
                                        <div className={`bg-white w-4 h-4 rounded-full shadow-md transform transition-transform ${selectedChild.settings?.parentApprovalRequired ? 'translate-x-6' : ''}`}></div>
                                    </button>
                                </div>
                                <button onClick={() => setModalOpen(false)} className="w-full bg-blue-500 text-white p-3 rounded-xl font-bold">Conclu√≠do</button>
                            </div>
                        </Modal>
                    )}

                    {/* ... (Outros modais mantidos iguais) ... */}
                    {modalOpen && modalType === 'edit-goal' && editingGoal && (
                        <Modal title="Editar Meta" onClose={() => setModalOpen(false)}>
                            <form onSubmit={(e) => {
                                e.preventDefault();
                                handleGoalUpdate(editingGoal.id, e.target.amount.value, e.target.name.value, e.target.approved.checked);
                            }} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-bold text-gray-600">Nome da Meta</label>
                                    <input name="name" defaultValue={editingGoal.name} className="soft-input w-full p-2 rounded-lg" required />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-gray-600">Valor Alvo</label>
                                    <input name="amount" type="number" defaultValue={editingGoal.amount} className="soft-input w-full p-2 rounded-lg" required />
                                </div>
                                <div className="flex items-center gap-2">
                                    <input type="checkbox" name="approved" defaultChecked={editingGoal.approved} id="check-approve" />
                                    <label for="check-approve" className="text-sm font-bold text-gray-600">Aprovada</label>
                                </div>
                                <button type="submit" className="w-full bg-green-500 text-white p-3 rounded-xl font-bold">Salvar Altera√ß√µes</button>
                            </form>
                        </Modal>
                    )}

                    {/* NOVO: Modal Dar Dinheiro */}
                    {modalOpen && modalType === 'give-money' && (
                        <Modal title="Enviar Moedas üí∞" onClose={() => setModalOpen(false)}>
                            <form onSubmit={(e) => {
                                e.preventDefault();
                                handleGiveMoney(e.target.amount.value, e.target.reason.value);
                            }} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-bold text-gray-600">Quantidade</label>
                                    <input name="amount" type="number" placeholder="0" className="soft-input w-full p-3 rounded-lg text-lg font-bold" required min="1" />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-gray-600">Motivo</label>
                                    <input name="reason" type="text" placeholder="Ex: Mesada, Ajudou em casa" className="soft-input w-full p-3 rounded-lg" />
                                </div>
                                <button type="submit" className="w-full bg-green-500 text-white p-3 rounded-xl font-bold hover:bg-green-600 shadow-md">Enviar</button>
                            </form>
                        </Modal>
                    )}

                    {/* NOVO: Modal Criar Tarefa */}
                    {modalOpen && modalType === 'add-task' && (
                        <Modal title="Nova Tarefa üìù" onClose={() => setModalOpen(false)}>
                            <form onSubmit={(e) => {
                                e.preventDefault();
                                handleAddTask(e.target.task.value, e.target.reward.value);
                            }} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-bold text-gray-600">Descri√ß√£o da Tarefa</label>
                                    <input name="task" type="text" placeholder="Ex: Arrumar o quarto" className="soft-input w-full p-3 rounded-lg" required />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-gray-600">Recompensa (Moedas)</label>
                                    <input name="reward" type="number" placeholder="0" className="soft-input w-full p-3 rounded-lg font-bold text-orange-500" required min="0" />
                                </div>
                                <button type="submit" className="w-full bg-purple-500 text-white p-3 rounded-xl font-bold hover:bg-purple-600 shadow-md">Criar Tarefa</button>
                            </form>
                        </Modal>
                    )}

                    <div className="max-w-4xl mx-auto relative z-10 animate-fade-in-up">
                        {/* Header Comum */}
                        <div className="flex justify-between items-center mb-6 bg-white/70 p-4 rounded-3xl backdrop-blur-md shadow-card-glow border-2 border-white">
                            <div>
                                <h1 className="text-3xl font-bold text-slate-800">Ol√°, {parentData.name}!</h1>
                                <p className="text-slate-500 font-medium">Gest√£o Financeira</p>
                            </div>
                            <div className="flex gap-2">
                                {view === 'child-detail' && (
                                    <button onClick={() => { setView('list'); setSelectedChild(null); }} className="bg-gray-200 text-gray-600 px-4 py-2 rounded-full font-bold hover:bg-gray-300 transition-colors">
                                        <i className="fa-solid fa-arrow-left mr-2"></i> Voltar
                                    </button>
                                )}
                                {/* Bot√£o de Ajuda (Novo) */}
                                <button id="help-btn-tutorial" onClick={handleManualHelp} className="bg-yellow-100 text-yellow-600 p-3 rounded-full hover:bg-yellow-200 transition-colors shadow-sm" title="Ajuda">
                                    <i className="fa-solid fa-question text-xl"></i>
                                </button>
                                <button onClick={() => { localStorage.removeItem('fin_session'); window.location.href = 'fluxo-login.html'; }} className="bg-red-100 text-red-500 p-3 rounded-full hover:bg-red-200 transition-colors shadow-sm"><i className="fa-solid fa-right-from-bracket"></i></button>
                            </div>
                        </div>

                        {/* VIEW: LISTA DE FILHOS */}
                        {view === 'list' && (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div id="add-child-btn-tutorial" onClick={addChild} className="bg-white/60 border-4 border-dashed border-blue-200 p-6 rounded-[2.5rem] flex flex-col items-center justify-center cursor-pointer hover:bg-white/80 transition-all min-h-[200px] group shadow-sm">
                                    <div className="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center text-blue-500 text-3xl mb-4 group-hover:scale-110 transition-transform"><i className="fa-solid fa-plus"></i></div>
                                    <h3 className="text-xl font-bold text-slate-600">Adicionar Crian√ßa</h3>
                                </div>

                                {parentData.children.map(child => (
                                    <div key={child.uid} onClick={() => loadChildDetails(child.uid)} className="bg-white p-6 rounded-[2.5rem] shadow-soft-blue relative overflow-hidden group border-4 border-white cursor-pointer hover:scale-[1.02] transition-transform">
                                        <div className="flex justify-between items-start mb-4">
                                            <div className="flex items-center gap-4">
                                                <div className="w-14 h-14 bg-blue-50 rounded-full flex items-center justify-center text-2xl text-blue-400">
                                                    <i className={`fa-solid ${child.profileIcon.value}`}></i>
                                                </div>
                                                <div>
                                                    <h3 className="text-2xl font-bold text-slate-800">{child.name}</h3>
                                                    <p className="text-slate-400 font-medium text-sm">C√≥digo: {child.code}</p>
                                                </div>
                                            </div>
                                            <i className="fa-solid fa-chevron-right text-gray-300"></i>
                                        </div>
                                        <p className="text-sm text-center text-blue-500 font-bold bg-blue-50 p-2 rounded-lg">Clique para ver detalhes</p>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* VIEW: DETALHES DA CRIAN√áA */}
                        {view === 'child-detail' && selectedChild && (
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                
                                {/* Coluna 1: Perfil e Status */}
                                <div className="md:col-span-1 space-y-6">
                                    <div className="bg-white p-6 rounded-[2rem] shadow-soft-blue text-center border-4 border-white">
                                        <div className="relative inline-block">
                                            <div className="w-24 h-24 bg-blue-100 rounded-full flex items-center justify-center text-4xl text-blue-500 mx-auto mb-3">
                                                <i className={`fa-solid ${selectedChild.profileIcon.value}`}></i>
                                            </div>
                                            <div className="absolute bottom-0 right-0 bg-white p-1 rounded-full text-2xl shadow-sm" title="Emo√ß√£o Atual">
                                                {selectedChild.currentEmotion?.value || 'üòä'}
                                            </div>
                                        </div>
                                        <h2 className="text-3xl font-bold text-slate-800">{selectedChild.name}</h2>
                                        <p className="text-orange-500 font-bold text-xl mt-2">{selectedChild.coins} Moedas</p>
                                        
                                        <div className="mt-4 grid grid-cols-2 gap-2">
                                            <button 
                                                id="btn-give-money"
                                                onClick={() => { setModalType('give-money'); setModalOpen(true); }}
                                                className="bg-green-100 text-green-700 py-2 rounded-xl font-bold hover:bg-green-200 transition-colors text-sm flex flex-col items-center justify-center"
                                            >
                                                <i className="fa-solid fa-coins mb-1 text-xl"></i> Dar $$
                                            </button>
                                            <button 
                                                id="btn-add-task"
                                                onClick={() => { setModalType('add-task'); setModalOpen(true); }}
                                                className="bg-purple-100 text-purple-700 py-2 rounded-xl font-bold hover:bg-purple-200 transition-colors text-sm flex flex-col items-center justify-center"
                                            >
                                                <i className="fa-solid fa-list-check mb-1 text-xl"></i> Tarefa
                                            </button>
                                        </div>

                                        <button 
                                            id="btn-settings"
                                            onClick={() => { setModalType('settings'); setModalOpen(true); }}
                                            className="mt-4 w-full bg-gray-100 text-gray-600 py-2 rounded-xl font-bold hover:bg-gray-200 flex items-center justify-center gap-2"
                                        >
                                            <i className="fa-solid fa-cog"></i> Configura√ß√µes
                                        </button>
                                    </div>
                                    
                                    {/* Lista de Tarefas (NOVO) */}
                                    <div className="bg-white p-6 rounded-[2rem] shadow-soft-blue border-l-8 border-purple-400">
                                        <h3 className="text-lg font-bold text-purple-700 mb-3 flex items-center gap-2">
                                            <i className="fa-solid fa-list-check"></i> Tarefas Pendentes
                                        </h3>
                                        
                                        {selectedChild.tasks.length === 0 ? (
                                            <p className="text-gray-400 text-center text-sm">Sem tarefas.</p>
                                        ) : (
                                            <div className="space-y-2 max-h-60 overflow-y-auto pr-1">
                                                {selectedChild.tasks.map(task => (
                                                    <div key={task.id} className={`p-2 rounded-lg border flex flex-col ${task.completed ? (task.approved ? 'bg-green-50 border-green-200' : 'bg-yellow-50 border-yellow-200') : 'bg-gray-50 border-gray-200'}`}>
                                                        <div className="flex justify-between items-start">
                                                            <span className="text-sm font-bold text-slate-700">{task.text}</span>
                                                            <span className="text-xs font-bold text-orange-500 bg-orange-50 px-2 py-0.5 rounded-full">+{task.reward}</span>
                                                        </div>
                                                        <div className="flex justify-between items-center mt-2">
                                                            <span className="text-xs text-gray-500">
                                                                {task.approved ? 'Aprovada' : task.completed ? 'Aguardando Aprova√ß√£o' : 'Pendente'}
                                                            </span>
                                                            <div className="flex gap-1">
                                                                {task.completed && !task.approved && (
                                                                    <button onClick={() => handleApproveTask(task.id)} className="bg-green-500 text-white p-1 rounded hover:bg-green-600 text-xs" title="Aprovar e Pagar">
                                                                        <i className="fa-solid fa-check"></i> Pagar
                                                                    </button>
                                                                )}
                                                                <button onClick={() => handleDeleteTask(task.id)} className="text-red-400 hover:text-red-600 p-1" title="Apagar">
                                                                    <i className="fa-solid fa-trash"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {/* Coluna 2: Metas e Hist√≥rico */}
                                <div className="md:col-span-2 space-y-6">
                                    
                                    {/* Gest√£o de Metas */}
                                    <div id="goals-section" className="bg-white p-6 rounded-[2rem] shadow-soft-blue border-l-8 border-green-400">
                                        <h3 className="text-xl font-bold text-green-700 mb-4 flex items-center gap-2">
                                            <i className="fa-solid fa-bullseye"></i> Metas da Crian√ßa
                                        </h3>
                                        
                                        {selectedChild.progress.goals.length === 0 ? (
                                            <p className="text-gray-400 text-center py-4">Nenhuma meta ativa.</p>
                                        ) : (
                                            <div className="space-y-3">
                                                {selectedChild.progress.goals.map(goal => (
                                                    <div key={goal.id} className="bg-green-50 p-4 rounded-xl border border-green-100 flex justify-between items-center">
                                                        <div>
                                                            <div className="flex items-center gap-2">
                                                                <span className="font-bold text-slate-700">{goal.name}</span>
                                                                {!goal.approved && <span className="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded font-bold">Pendente</span>}
                                                            </div>
                                                            <p className="text-sm text-gray-500">{goal.saved} / {goal.amount} moedas</p>
                                                        </div>
                                                        <div className="flex gap-2">
                                                            <button 
                                                                onClick={() => { setEditingGoal(goal); setModalType('edit-goal'); setModalOpen(true); }}
                                                                className="p-2 bg-white text-blue-500 rounded-lg shadow-sm hover:text-blue-700" title="Editar"
                                                            >
                                                                <i className="fa-solid fa-pencil"></i>
                                                            </button>
                                                            <button 
                                                                onClick={() => handleDeleteGoal(goal.id)}
                                                                className="p-2 bg-white text-red-500 rounded-lg shadow-sm hover:text-red-700" title="Excluir"
                                                            >
                                                                <i className="fa-solid fa-trash"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>

                                    {/* Hist√≥rico Detalhado */}
                                    <div className="bg-white p-6 rounded-[2rem] shadow-soft-blue">
                                        <h3 className="text-xl font-bold text-slate-700 mb-4 flex items-center gap-2">
                                            <i className="fa-solid fa-clock-rotate-left"></i> Hist√≥rico Completo
                                        </h3>
                                        <div className="max-h-60 overflow-y-auto pr-2 space-y-2">
                                            {(!selectedChild.transactions || selectedChild.transactions.length === 0) ? (
                                                <p className="text-center text-gray-400">Sem transa√ß√µes.</p>
                                            ) : (
                                                selectedChild.transactions.map((t, i) => (
                                                    <div key={i} className={`flex justify-between items-center p-3 rounded-lg border-l-4 ${t.type === 'earn' ? 'bg-green-50 border-green-400' : t.type === 'spend' ? 'bg-red-50 border-red-400' : 'bg-blue-50 border-blue-400'}`}>
                                                        <div>
                                                            <p className="text-xs text-gray-500 font-bold">{t.date}</p>
                                                            <p className="text-sm text-slate-700 font-medium">{t.description}</p>
                                                        </div>
                                                        <span className={`font-bold ${t.type === 'earn' ? 'text-green-600' : t.type === 'spend' ? 'text-red-600' : 'text-blue-600'}`}>
                                                            {t.type === 'earn' ? '+' : '-'}{t.amount}
                                                        </span>
                                                    </div>
                                                ))
                                            )}
                                        </div>
                                    </div>

                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ParentDashboard />);
    </script>
</body>
</html>