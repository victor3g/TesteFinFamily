<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Saltitante - Fin Family</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: 'Fredoka', sans-serif; overflow: hidden; touch-action: none; background: #E0F7FA; user-select: none; -webkit-user-select: none; }
        canvas { display: block; margin: 0 auto; box-shadow: 0 10px 30px rgba(0,0,0,0.15); border-radius: 20px; background: linear-gradient(180deg, #87CEEB 0%, #E0F7FA 100%); cursor: grab; }
        canvas:active { cursor: grabbing; }
        
        /* Anima√ß√µes de UI */
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 4px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            border-radius: 2rem;
        }
        .btn-game {
            transition: all 0.1s;
            box-shadow: 0 6px 0 0 rgba(0,0,0,0.2);
        }
        .btn-game:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 0 rgba(0,0,0,0.2);
        }
        
        .floating { animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    </style>
</head>
<body class="flex flex-col items-center justify-center h-screen relative bg-blue-50">

    <div class="absolute top-4 left-4 z-20">
        <a href="ChildDashboard.html" class="bg-white p-3 rounded-full text-gray-600 hover:text-blue-500 shadow-lg transition-transform hover:scale-110 inline-block border-2 border-gray-100">
            <i class="fa-solid fa-arrow-left text-xl"></i>
        </a>
    </div>
    
    <div id="game-ui" class="hidden absolute top-4 right-4 z-20 bg-white/90 px-5 py-2 rounded-full shadow-lg border-2 border-white flex items-center gap-2">
        <span class="text-orange-500 font-bold text-2xl"><i class="fa-solid fa-coins mr-2"></i><span id="score-display">0</span></span>
    </div>

    <div id="game-container" class="relative w-full max-w-md h-full flex items-center justify-center p-4">
        <canvas id="gameCanvas"></canvas>
        
        <div id="loading-screen" class="absolute inset-0 flex items-center justify-center bg-blue-100 z-50">
            <div class="text-center">
                <i class="fa-solid fa-spinner fa-spin text-4xl text-blue-500"></i>
                <p class="mt-2 font-bold text-blue-400">Carregando...</p>
            </div>
        </div>

        <div id="start-screen" class="hidden absolute inset-0 bg-black/30 backdrop-blur-sm flex flex-col items-center justify-center z-40 rounded-[20px]">
            <div class="glass-panel p-8 text-center max-w-xs mx-4 animate-bounce-slow">
                <div class="mb-4 text-6xl floating">üê∑</div>
                <h1 class="text-4xl font-extrabold text-purple-600 mb-2">Saltitante!</h1>
                <p class="text-gray-500 mb-6 font-bold">Incline ou arraste para mover.<br>Cuidado com os raios ‚ö°!</p>
                <button onclick="startGame()" class="btn-game w-full bg-green-500 text-white px-8 py-4 rounded-2xl font-bold text-2xl hover:bg-green-600">
                    JOGAR ‚ñ∂
                </button>
            </div>
        </div>

        <div id="cooldown-screen" class="hidden absolute inset-0 bg-black/40 backdrop-blur-md flex flex-col items-center justify-center z-40 rounded-[20px]">
            <div class="glass-panel p-8 text-center max-w-xs mx-4">
                <div class="mb-4 text-6xl animate-pulse">‚è≥</div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Hora do Descanso!</h2>
                <p class="text-gray-600 mb-4">Voc√™ jogou muito bem! Volte mais tarde para ganhar mais moedas.</p>
                <div class="bg-blue-100 text-blue-600 font-mono text-2xl font-bold p-3 rounded-xl mb-6 border-2 border-blue-200">
                    <span id="cooldown-timer">00:00</span>
                </div>
                <a href="ChildDashboard.html" class="btn-game block w-full bg-blue-500 text-white px-6 py-3 rounded-xl font-bold text-lg hover:bg-blue-600">
                    Voltar ao Menu
                </a>
            </div>
        </div>
        
        <div id="game-over-screen" class="hidden absolute inset-0 bg-black/50 backdrop-blur-md flex flex-col items-center justify-center z-40 rounded-[20px]">
            <div class="glass-panel p-8 text-center max-w-xs mx-4 transform scale-100 transition-transform">
                <h2 class="text-3xl font-bold text-gray-800 mb-2">Fim de Jogo!</h2>
                <p class="text-gray-500 text-lg mb-4">Voc√™ coletou:</p>
                <div class="text-6xl font-bold text-orange-500 mb-6 flex items-center justify-center gap-2 drop-shadow-sm">
                    +<span id="final-score">0</span> <i class="fa-solid fa-coins text-4xl"></i>
                </div>
                <button onclick="saveAndExit()" class="btn-game w-full bg-green-500 text-white px-6 py-3 rounded-xl font-bold text-xl hover:bg-green-600 mb-3 shadow-lg">
                    <i class="fa-solid fa-check mr-2"></i> Coletar & Sair
                </button>
                <p class="text-xs text-white/80 mt-2 font-bold">O tempo de recarga come√ßar√° agora.</p>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO ---
        const COOLDOWN_HOURS = 1;
        const COOLDOWN_MS = COOLDOWN_HOURS * 60 * 60 * 1000;
        const supabase = window.supabase.createClient("https://jwwgsyibgwpvgfbsltzr.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3d2dzeWliZ3dwdmdmYnNsdHpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzNzkzMDAsImV4cCI6MjA3ODk1NTMwMH0.9iA_dKu4UJf-tQV03YdG8J1N4FhuP_flxHr7HWDbt9I");

        // --- SISTEMA DE √ÅUDIO ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            const now = audioCtx.currentTime;
            
            if (type === 'jump') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(300, now);
                osc.frequency.linearRampToValueAtTime(600, now + 0.1);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.linearRampToValueAtTime(0.01, now + 0.2);
                osc.start(now); osc.stop(now + 0.2);
            } else if (type === 'coin') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(1000, now);
                osc.frequency.exponentialRampToValueAtTime(2000, now + 0.1);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'crash') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, now);
                osc.frequency.exponentialRampToValueAtTime(50, now + 0.3);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.linearRampToValueAtTime(0.01, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'over') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.linearRampToValueAtTime(200, now + 0.4);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.linearRampToValueAtTime(0.01, now + 0.4);
                osc.start(now); osc.stop(now + 0.4);
            }
        }

        // --- VARI√ÅVEIS DO JOGO ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let gameState = 'loading'; // loading, menu, playing, gameover, cooldown
        let score = 0;
        let userData = null;
        let session = null;

        // F√≠sica e Objetos
        let player = { x: 0, y: 0, w: 40, h: 40, vx: 0, vy: 0 };
        let platforms = [];
        let coins = [];
        let obstacles = [];
        let particles = [];
        let cameraY = 0;
        
        // AJUSTES DE JOGABILIDADE
        let gravity = 0.5;
        let jumpForce = -13;
        let inputX = 0; 

        // --- INICIALIZA√á√ÉO ---
        function resize() {
            canvas.width = Math.min(window.innerWidth, 400);
            canvas.height = window.innerHeight;
            if(gameState === 'menu') player.x = canvas.width / 2 - player.w / 2;
        }
        window.addEventListener('resize', resize);
        resize();

        async function init() {
            session = JSON.parse(localStorage.getItem('fin_session'));
            if (!session || session.role !== 'child') {
                window.location.href = 'fluxo-login.html';
                return;
            }

            const { data, error } = await supabase.from('child_profiles').select('data').eq('user_id', session.uid).single();
            document.getElementById('loading-screen').classList.add('hidden');
            
            if (data && data.data) {
                userData = data.data;
                const lastPlayed = userData.lastGameTime || 0;
                const now = Date.now();
                const diff = now - lastPlayed;

                if (diff < COOLDOWN_MS) {
                    showCooldown(COOLDOWN_MS - diff);
                } else {
                    showMenu();
                }
            } else {
                showMenu();
            }
        }

        // --- L√ìGICA DE COOLDOWN ---
        function showCooldown(remainingTime) {
            gameState = 'cooldown';
            document.getElementById('cooldown-screen').classList.remove('hidden');
            const timerEl = document.getElementById('cooldown-timer');
            const interval = setInterval(() => {
                remainingTime -= 1000;
                if (remainingTime <= 0) {
                    clearInterval(interval);
                    location.reload();
                    return;
                }
                const minutes = Math.floor(remainingTime / 60000);
                const seconds = Math.floor((remainingTime % 60000) / 1000);
                timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // --- L√ìGICA DO JOGO ---
        function showMenu() {
            gameState = 'menu';
            document.getElementById('start-screen').classList.remove('hidden');
            document.getElementById('game-ui').classList.add('hidden');
            resetGame();
        }

        function resetGame() {
            score = 0;
            cameraY = 0;
            player = { x: canvas.width/2 - 20, y: canvas.height - 150, w: 40, h: 40, vx: 0, vy: 0 };
            inputX = canvas.width / 2;
            
            platforms = [];
            // Plataforma inicial segura
            platforms.push({ x: canvas.width/2 - 40, y: canvas.height - 50, w: 80, h: 15 });
            
            // Gerar plataformas iniciais (menos densas)
            for(let i=0; i<8; i++) {
                // Gap aumentado para ~100px (pulo alcan√ßa ~160px)
                generatePlatform(canvas.height - 150 - (i * 100));
            }
            
            coins = [];
            obstacles = [];
            particles = [];
            document.getElementById('score-display').innerText = "0";
        }

        function generatePlatform(y) {
            const w = 70;
            const x = Math.random() * (canvas.width - w);
            platforms.push({ x, y, w, h: 15 });
            
            // Moedas: Chance RARA (5%)
            if (Math.random() < 0.05) {
                coins.push({ x: x + w/2 - 10, y: y - 40, w: 20, h: 20, collected: false });
            }

            // Obst√°culos
            if (score > 5 && Math.random() < 0.1) {
                obstacles.push({ x: Math.random() * (canvas.width - 40), y: y - 80, w: 40, h: 40 });
            }
        }

        function startGame() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
            gameState = 'playing';
            audioCtx.resume();
            loop();
        }

        // Input
        function handleInput(e) {
            if (gameState !== 'playing') return;
            const rect = canvas.getBoundingClientRect();
            let clientX = e.touches ? e.touches[0].clientX : e.clientX;
            inputX = (clientX - rect.left) * (canvas.width / rect.width);
        }
        window.addEventListener('mousemove', handleInput);
        window.addEventListener('touchmove', (e) => { e.preventDefault(); handleInput(e); }, {passive: false});
        window.addEventListener('touchstart', (e) => { handleInput(e); }, {passive: true});

        function update() {
            // Movimento Horizontal
            const diff = inputX - (player.x + player.w/2);
            player.vx = diff * 0.15;
            player.x += player.vx;

            // Limites Laterais (Wraparound)
            if (player.x > canvas.width) player.x = -player.w;
            if (player.x < -player.w) player.x = canvas.width;

            // Gravidade
            player.vy += gravity;
            player.y += player.vy;

            // Colis√£o com Plataformas
            if (player.vy > 0) {
                platforms.forEach(p => {
                    if (player.x + player.w > p.x && player.x < p.x + p.w &&
                        player.y + player.h > p.y && player.y + player.h < p.y + p.h + 20) {
                        player.vy = jumpForce;
                        playSound('jump');
                        createParticles(player.x + player.w/2, player.y + player.h, '#fff');
                    }
                });
            }

            // C√¢mera e Gera√ß√£o de Plataformas
            if (player.y < canvas.height / 2) {
                const delta = canvas.height / 2 - player.y;
                player.y += delta;
                cameraY += delta;
                
                platforms.forEach(p => p.y += delta);
                coins.forEach(c => c.y += delta);
                obstacles.forEach(o => o.y += delta);
                
                // Limpeza
                platforms = platforms.filter(p => p.y < canvas.height + 50);
                coins = coins.filter(c => c.y < canvas.height + 50);
                obstacles = obstacles.filter(o => o.y < canvas.height + 50);
                
                // Gera√ß√£o Infinita (Gap ~100px)
                const highestY = Math.min(...platforms.map(p => p.y));
                if (highestY > 110) {
                    generatePlatform(highestY - (Math.random() * 20 + 90)); 
                }
            }

            // Colis√£o com Moedas
            coins.forEach(c => {
                if (!c.collected && 
                    player.x < c.x + c.w && player.x + player.w > c.x &&
                    player.y < c.y + c.h && player.y + player.h > c.y) {
                    c.collected = true;
                    score++;
                    document.getElementById('score-display').innerText = score;
                    playSound('coin');
                    createParticles(c.x, c.y, '#FFD700');
                }
            });
            coins = coins.filter(c => !c.collected);

            // Colis√£o com Obst√°culos (Game Over)
            obstacles.forEach(o => {
                if (player.x + 5 < o.x + o.w && player.x + player.w - 5 > o.x &&
                    player.y + 5 < o.y + o.h && player.y + player.h - 5 > o.y) {
                    playSound('crash');
                    endGame();
                }
            });

            // Game Over (Queda)
            if (player.y > canvas.height) {
                endGame();
            }

            // Part√≠culas
            particles.forEach(p => { p.x += p.vx; p.y += p.vy; p.life--; });
            particles = particles.filter(p => p.life > 0);
        }

        function createParticles(x, y, color) {
            for(let i=0; i<8; i++) {
                particles.push({
                    x, y, 
                    vx: (Math.random() - 0.5) * 5, 
                    vy: (Math.random() - 0.5) * 5, 
                    life: 20, color
                });
            }
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Plataformas
            platforms.forEach(p => {
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.arc(p.x + 10, p.y + 10, 15, 0, Math.PI * 2);
                ctx.arc(p.x + p.w - 10, p.y + 10, 15, 0, Math.PI * 2);
                ctx.arc(p.x + p.w / 2, p.y - 5, 20, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = 'rgba(200, 230, 255, 0.5)';
                ctx.beginPath();
                ctx.roundRect(p.x, p.y + 10, p.w, 10, 10);
                ctx.fill();
            });

            // Moedas
            coins.forEach(c => {
                ctx.shadowBlur = 10; ctx.shadowColor = "#FFD700";
                ctx.fillStyle = '#FFD700';
                ctx.beginPath(); ctx.arc(c.x + c.w/2, c.y + c.h/2, 12, 0, Math.PI*2); ctx.fill();
                ctx.shadowBlur = 0;
                ctx.strokeStyle = '#FFA500'; ctx.lineWidth = 2; ctx.stroke();
                ctx.fillStyle = '#FFA500'; ctx.font = 'bold 16px Arial'; ctx.fillText('$', c.x + 6, c.y + 16);
            });

            // Obst√°culos
            obstacles.forEach(o => {
                ctx.fillStyle = '#555';
                ctx.beginPath();
                ctx.arc(o.x + 10, o.y + 10, 15, 0, Math.PI * 2);
                ctx.arc(o.x + o.w - 10, o.y + 10, 15, 0, Math.PI * 2);
                ctx.arc(o.x + o.w / 2, o.y - 5, 20, 0, Math.PI * 2);
                ctx.fill();
                ctx.font = '24px Arial'; ctx.fillText('‚ö°', o.x + 8, o.y + 40);
            });

            // Player
            ctx.shadowBlur = 15; ctx.shadowColor = "rgba(0,0,0,0.2)";
            ctx.font = "40px Arial";
            ctx.save();
            if (player.vx < 0) { ctx.scale(-1, 1); ctx.fillText(userData?.currentPet?.value || 'üê∑', -player.x - player.w, player.y + 35); } 
            else { ctx.fillText(userData?.currentPet?.value || 'üê∑', player.x, player.y + 35); }
            ctx.restore();
            ctx.shadowBlur = 0;

            // Part√≠culas
            particles.forEach(p => {
                ctx.fillStyle = p.color;
                ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI*2); ctx.fill();
            });
        }

        function loop() {
            if (gameState === 'playing') {
                update();
                draw();
                requestAnimationFrame(loop);
            }
        }

        function endGame() {
            gameState = 'gameover';
            playSound('over');
            document.getElementById('final-score').innerText = score;
            document.getElementById('game-ui').classList.add('hidden');
            document.getElementById('game-over-screen').classList.remove('hidden');
        }

        async function saveAndExit() {
            const btn = document.querySelector('#game-over-screen button');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Salvando...';

            if (score > 0) {
                const newCoins = (userData.coins || 0) + score;
                const newTransactions = [{ id: Date.now(), type: 'earn', amount: score, description: "Ganhou no Saltitante üê∑", date: new Date().toLocaleDateString() }, ...(userData.transactions || [])];
                await supabase.from('child_profiles').update({ data: { ...userData, coins: newCoins, transactions: newTransactions, lastGameTime: Date.now() } }).eq('user_id', session.uid);
            } else {
                await supabase.from('child_profiles').update({ data: { ...userData, lastGameTime: Date.now() } }).eq('user_id', session.uid);
            }
            window.location.href = 'ChildDashboard.html';
        }

        init();
    </script>
</body>
</html>
